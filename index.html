<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Static Live Chatting - Extended</title>

  <style>
    :root {
      /* Default: Dark Theme */
      --bg-color: #111;
      --text-color: #fff;
      --sidebar-color: #1c1c1c;
      --chat-bg: #222;
      --bubble-me: #1e90ff;
      --bubble-them: #444;
      --accent: #1e90ff;
      --badge: red;
      --chat-item-bg: #333;
    }
    body.light {
      --bg-color: #f4f4f4;
      --text-color: #000;
      --sidebar-color: #ddd;
      --chat-bg: #eee;
      --bubble-me: #007aff;
      --bubble-them: #ccc;
      --accent: #007acc;
      --chat-item-bg: #bbb;
    }
    body.blue {
      --bg-color: #0b1622;
      --text-color: #f0f8ff;
      --sidebar-color: #132336;
      --chat-bg: #1e2d40;
      --bubble-me: #1f65ff;
      --bubble-them: #41546a;
      --accent: #389fff;
      --chat-item-bg: #2e3d52;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
      border-radius: 6px;
      border: none;
    }
    button {
      background: var(--accent);
      color: #fff;
      cursor: pointer;
    }
    .panel {
      padding: 20px;
      background: var(--chat-bg);
      border-radius: 10px;
    }
    #login, #settingsPanel, #groupJoinPanel, #groupCreatePanel, #directoryPanel, #confirmPanel, #noticePanel {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .panelContent {
      background: var(--chat-bg);
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
    }
    #app {
      display: flex;
      flex: 1;
      height: 100%;
    }
    #sidebar {
      width: 280px;
      background: var(--sidebar-color);
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow-y: auto;
    }
    #chatPanel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--chat-bg);
      position: relative;
    }
    #topBar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      font-size: 18px;
      background: var(--chat-bg);
    }
    #messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .msg {
      max-width: 70%;
      padding: 12px 16px;
      margin: 6px;
      border-radius: 20px;
      font-size: 17px;
      line-height: 1.4;
      word-wrap: break-word;
      position: relative;
      cursor: pointer;
    }
    .me {
      align-self: flex-end;
      background: var(--bubble-me);
      color: #fff;
      border-bottom-right-radius: 5px;
    }
    .them {
      align-self: flex-start;
      background: var(--bubble-them);
      color: #fff;
      border-bottom-left-radius: 5px;
    }
    .reactionBar {
      position: absolute;
      bottom: 100%;
      display: none;
      flex-direction: row;
      gap: 5px;
      background: rgba(0,0,0,0.6);
      padding: 5px;
      border-radius: 6px;
    }
    .reactionBar span {
      font-size: 22px;
      cursor: pointer;
    }
    .reactionTag {
      margin-left: 6px;
      font-size: 14px;
      opacity: 0.8;
    }
    .timestamp {
      position: absolute;
      font-size: 10px;
      opacity: 0.7;
      bottom: -14px;
    }
    .mineTime {
      right: 10px;
    }
    .otherTime {
      left: 10px;
    }
    #typingIndicator {
      font-style: italic;
      font-size: 14px;
      margin: 0 20px 10px;
    }
    #inputArea {
      display: flex;
      padding: 10px;
      background: var(--sidebar-color);
    }
    #inputArea input {
      flex: 1;
      margin-right: 5px;
      font-size: 17px;
    }
    #emojiPicker {
      display: none;
      position: absolute;
      bottom: 70px;
      right: 15px;
      background: var(--chat-bg);
      padding: 10px;
      flex-wrap: wrap;
      z-index: 99;
      max-width: 260px;
    }
    #emojiPicker span {
      font-size: 22px;
      margin: 6px;
      cursor: pointer;
    }
    .chatItem {
      background: var(--chat-item-bg);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .chatItem:hover {
      background: var(--bubble-them);
    }
    .chatItem.active {
      outline: 2px solid var(--accent);
    }
    .chatBadge {
      background: var(--badge);
      color: #fff;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 12px;
      margin-left: 5px;
    }
    .requestItem {
      background: var(--bubble-them);
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 6px;
    }
    #staticMenu {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: #1e1e1e;
      color: #fff;
      padding: 5px 8px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 0 6px #0ff;
      animation: blink 2s infinite;
      z-index: 1000;
    }
    .nameColor1 { color: #ff8888; }
    .nameColor2 { color: #88ff88; }
    .nameColor3 { color: #8888ff; }
    .nameColor4 { color: #ffff88; }
    .nameColor5 { color: #ff88ff; }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
  </style>
</head>
<body>
<script>
  window.onbeforeunload = () => \"Are you sure you want to leave? Your progress may not be saved.\";
</script>

<!-- Panels that show up for in-page confirmations/notices -->
<div id="confirmPanel">
  <div class="panelContent" id="confirmInner"></div>
</div>
<div id="noticePanel">
  <div class="panelContent" id="noticeInner"></div>
</div>

<!-- Login Screen -->
<div id="login" style="display:flex;">
  <div class="panel">
    <h2>Static Live Chatting</h2>
    <p>‚ö†Ô∏è Never share sensitive info</p>
    <input id="username" placeholder="Username"/><br/>
    <div style="display:flex;align-items:center;">
      <input id="password" type="password" placeholder="Password (optional)" style="margin:5px 0;flex:1;" />
      <button style="margin:5px 0;" onclick="toggleLoginPass()">üëÅÔ∏è</button>
    </div>
    <button onclick="doLogin()">Log In</button>
  </div>
</div>

<!-- Main App -->
<div id="app" style="display:none;">
  <div id="sidebar">
    <h3>Friend Requests</h3>
    <div id="requestsTab"></div>
    <h3>People (Public)</h3>
    <div id="peopleList"></div>
    <hr/>
    <h3>Chats</h3>
    <div id="chatList"></div>
    <hr/>
    <button onclick="showJoinPanel()">üîì Join Group Chat</button>
    <button onclick="showCreatePanel()">‚ûï Create Group</button>
    <button onclick="showDirectory()">üåê All Public Groups</button>
  </div>

  <div id="chatPanel">
    <div id="topBar">
      <div id="chatTitle">No Chat</div>
      <div id="topButtons" style="display:flex;align-items:center;">
        <!-- Lock button is separate from toggling messages. -->
        <div style="margin-right:10px;">
          <span id="lastSeenInfo" style="font-size:14px;"></span>
          <span id="hiddenPassword" style="font-size:14px; margin-left:8px; display:none;"></span>
          <button onclick="toggleTopLock()" style="font-size:14px;">üîí</button>
        </div>
        <button onclick="openSettings()">‚öôÔ∏è</button>
      </div>
    </div>
    <div id="groupMembers" style="padding:5px 15px; display:none; font-size:14px;"></div>
    <div id="messages"></div>
    <div id="typingIndicator" style="display:none;"></div>
    <div id="inputArea">
      <input id="msgInput" placeholder="Type..." oninput="sendTyping()" onkeypress="if(event.key==='Enter')sendMessage();"/>
      <button onclick="toggleEmojiPicker()">üòÄ</button>
      <button onclick="toggleLock()">üîí</button>
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="emojiPicker"></div>
  </div>
</div>

<!-- Static Menu -->
<div id="staticMenu">
  üåü More Unblocked Games by Static
</div>

<!-- Settings Panel -->
<div id="settingsPanel" class="panel" style="display:none;">
  <h3>Settings</h3>
  <label>Username:</label><br/>
  <input id="editUsername"><br/>
  <label>Password:</label><br/>
  <input id="editPassword"><br/>
  <p>Theme:</p>
  <select id="themeSelect">
    <option value="dark">Dark</option>
    <option value="light">Light</option>
    <option value="blue">Blue</option>
  </select><br/>
  <button onclick="saveSettings()">Save</button>
  <button onclick="closeSettings()">Close</button><br/>
  <button onclick="openImportExportPanel()">üì§ Import/Export</button>
</div>

<!-- Group Join Panel -->
<div id="groupJoinPanel" class="panel" style="display:none;">
  <h3>Join Group</h3>
  <input id="joinGroupID" placeholder="Group ID"><br/>
  <input id="joinGroupPassword" placeholder="Password (if needed)"><br/>
  <button onclick="joinGroupChat()">Join</button>
  <button onclick="closeJoinPanel()">Close</button>
</div>

<!-- Group Create Panel -->
<div id="groupCreatePanel" class="panel" style="display:none;">
  <h3>Create Group</h3>
  <input id="groupName" placeholder="Group Name"><br/>
  <select id="groupType">
    <option value="open">Open</option>
    <option value="password">Password</option>
    <option value="invite">Invite Only</option>
  </select><br/>
  <input id="groupPassword" placeholder="Password (optional)"><br/>
  <button onclick="createGroupChat()">Create</button>
  <button onclick="closeCreatePanel()">Close</button>
</div>

<!-- Public Directory Panel -->
<div id="directoryPanel" class="panel" style="display:none;">
  <h3>All Public Groups</h3>
  <div id="publicList" style="max-height:300px; overflow:auto;"></div>
  <button onclick="closeDirectory()">Close</button>
</div>

<script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>
<script>
// === Firebase Init ===
const firebaseConfig = {
  apiKey: "AIzaSyBO7EHU4-_b2NHf7UFYTB8Wolv73Z0P8Fw",
  authDomain: "static-live-chatting.firebaseapp.com",
  databaseURL: "https://static-live-chatting-default-rtdb.firebaseio.com",
  projectId: "static-live-chatting",
  storageBucket: "static-live-chatting.appspot.com",
  messagingSenderId: "578562140653",
  appId: "1:578562140653:web:c12df07155627083e9dfe4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// === Global State ===
let user = localStorage.getItem("user") || "";
let pass = localStorage.getItem("pass") || "";
let currentChat = "", currentType = "", typingTimeout;
let chatUnread = {};
let chatActive = ""; // store which chat is active
let colorMap = {};   // map user -> color class
const colorClasses = ["nameColor1","nameColor2","nameColor3","nameColor4","nameColor5"];

if (user) startApp();

// === 1) Toggle password on login screen
function toggleLoginPass() {
  const pw = document.getElementById("password");
  pw.type = (pw.type === "password") ? "text" : "password";
}

// === 2) doLogin
function doLogin() {
  user = document.getElementById("username").value.trim();
  pass = document.getElementById("password").value.trim();
  if (!user) return;
  localStorage.setItem("user", user);
  localStorage.setItem("pass", pass);
  startApp();
}

// === 3) Start App
function startApp() {
  document.getElementById("login").style.display = "none";
  document.getElementById("app").style.display = "flex";
  const savedTheme = localStorage.getItem("theme") || "dark";
  document.body.classList.remove("light","blue");
  if (savedTheme === "light") document.body.classList.add("light");
  else if (savedTheme === "blue") document.body.classList.add("blue");

  loadChats();
  loadRequests();
  loadPeople();
}

// === People (public)
function loadPeople() {
  // People with no password
  db.ref("users").once("value", snap => {
    const container = document.getElementById("peopleList");
    container.innerHTML = "";
    const data = snap.val() || {};
    Object.keys(data).forEach(u => {
      if (u !== user && !(data[u].pass || "").length) {
        const div = document.createElement("div");
        div.className = "chatItem";
        div.textContent = u;
        div.onclick = () => addFriend(u);
        container.appendChild(div);
      }
    });
  });
}

function addFriend(friend) {
  // create a private chat
  const cid = [user, friend].sort().join("_");
  db.ref(`privateChats/${cid}`).once("value", s => {
    if (!s.exists()) {
      db.ref(`privateChats/${cid}`).set({});
    }
  });
  db.ref(`users/${user}/chats/${cid}`).set({ name: friend, type: "private", last: Date.now() });
  db.ref(`users/${friend}/requests/${user}`).set({ requested: true });
  openChat(cid, friend, "private");
}

// === Friend Requests
function loadRequests() {
  db.ref("users/" + user + "/requests").on("value", snap => {
    const tab = document.getElementById("requestsTab");
    tab.innerHTML = "";
    const data = snap.val() || {};
    Object.keys(data).forEach(from => {
      const div = document.createElement("div");
      div.className = "requestItem";
      div.textContent = `${from} wants to chat `;
      const accept = document.createElement("button");
      accept.textContent = "Accept";
      accept.onclick = () => {
        const id = [user, from].sort().join("_");
        db.ref(`privateChats/${id}`).set({});
        db.ref(`users/${user}/chats/${id}`).set({ name: from, type: "private", last: Date.now() });
        db.ref(`users/${user}/requests/${from}`).remove();
      };
      div.appendChild(accept);
      tab.appendChild(div);
    });
  });
}

// === Chat List
function loadChats() {
  db.ref("users/" + user + "/chats").on("value", snap => {
    const data = snap.val() || {};
    const sorted = Object.entries(data).sort((a, b) => (b[1].last||0) - (a[1].last||0));
    const container = document.getElementById("chatList");
    container.innerHTML = "";
    sorted.forEach(([id, info]) => {
      const div = document.createElement("div");
      div.className = "chatItem";
      if (id === chatActive) div.classList.add("active");
      div.textContent = info.name || id;
      const rowRight = document.createElement("div");
      rowRight.style.display = "flex";
      rowRight.style.alignItems = "center";

      // unread
      if (chatUnread[id]) {
        const badge = document.createElement("span");
        badge.className = "chatBadge";
        badge.textContent = "+" + chatUnread[id];
        rowRight.appendChild(badge);
      }

      // delete/leave chat button
      const delBtn = document.createElement("button");
      delBtn.textContent = "üóë";
      delBtn.onclick = (e) => {
        e.stopPropagation();
        confirmChatDelete(id, info);
      };
      rowRight.appendChild(delBtn);

      div.appendChild(rowRight);
      div.onclick = () => {
        openChat(id, info.name, info.type);
        highlightChat(id);
      };
      container.appendChild(div);
    });
  });
}
function highlightChat(id) {
  chatActive = id;
  const items = document.querySelectorAll(".chatItem");
  items.forEach(i => i.classList.remove("active"));
  const container = document.getElementById("chatList");
  for (let c of container.children) {
    if (c.textContent.includes(id) || c.onclick.toString().includes(id)) {
      // might skip
    }
  }
}

function confirmChatDelete(chatId, info) {
  // Only group owners can fully remove group
  if (info.type === "group") {
    db.ref("groupChats/" + chatId + "/createdBy").once("value", s => {
      const creator = s.val();
      if (creator !== user) return showNotice("You are not the owner, can't delete group chat for all. You may only leave.");
      showConfirm(`Are you sure you want to delete group: ${info.name}?`, () => {
        // remove group for all
        db.ref("groupChats/" + chatId).remove();
        db.ref(`users/${user}/chats/${chatId}`).remove();
        showNotice("Group chat removed for all members!");
      });
    });
  } else {
    showConfirm(`Are you sure you want to leave private chat with: ${info.name}?`, () => {
      db.ref(`users/${user}/chats/${chatId}`).remove();
      showNotice("You left the chat.");
    });
  }
}

// In-page confirm
function showConfirm(msg, yesCallback) {
  const p = document.getElementById("confirmPanel");
  const i = document.getElementById("confirmInner");
  i.innerHTML = `
    <h3 style='margin-top:0'>Confirm</h3>
    <p>${msg}</p>
    <div style='display:flex;justify-content:center;gap:10px;'>
      <button style='background:red;' onclick='doYes()'>‚úî</button>
      <button style='background:green;' onclick='closeConfirm()'>‚úò</button>
    </div>
  `;
  p.style.display = "flex";
  window.doYes = () => {
    p.style.display = "none";
    yesCallback();
  };
  window.closeConfirm = () => {
    p.style.display = "none";
  };
}

// In-page notice
function showNotice(msg) {
  const p = document.getElementById("noticePanel");
  const i = document.getElementById("noticeInner");
  i.innerHTML = `
    <h3 style='margin-top:0'>Notice</h3>
    <p>${msg}</p>
    <button onclick='closeNotice()'>OK</button>
  `;
  p.style.display = "flex";
}
function closeNotice() {
  document.getElementById("noticePanel").style.display = "none";
}

// === Open Chat
function openChat(id, name, type) {
  currentChat = id;
  currentType = type;
  chatUnread[id] = 0;
  highlightChat(id);

  // top bar info
  document.getElementById("chatTitle").textContent = name;
  document.getElementById("messages").innerHTML = "";
  document.getElementById("groupMembers").style.display = (type === "group") ? "block" : "none";
  document.getElementById("hiddenPassword").textContent = `(pw: ${localStorage.getItem("pass")||"none"})`;
  document.getElementById("hiddenPassword").style.display = "none";
  showLastSeenOrOnline(name);

  if (type === "group") {
    // Show group members, listen for new joins
    db.ref("groupChats/" + id + "/members").off();
    db.ref("groupChats/" + id + "/members").on("child_added", s => {
      if (s.key !== user) {
        // system message
        const joinedMsg = {
          sender: "_system",
          text: `${s.key} joined the group!`,
          timestamp: Date.now()
        };
        db.ref(`groupChats/${id}/messages`).push(joinedMsg);
      }
    });
    db.ref("groupChats/" + id + "/members").on("value", snap => {
      const mems = Object.keys(snap.val() || {});
      document.getElementById("groupMembers").textContent = "Members: " + mems.join(", ");
    });
  }

  // Listen for messages
  loadInitialMessages(id, type);
  // Listen for typing
  db.ref(`${type==="group"?"groupChats":"privateChats"}/${id}/typing`).off();
  db.ref(`${type==="group"?"groupChats":"privateChats"}/${id}/typing`).on("value", snap => {
    const typer = snap.val();
    const box = document.getElementById("typingIndicator");
    if (typer && typer !== user) {
      box.style.display = "block";
      box.textContent = `${typer} is typing...`;
    } else {
      box.style.display = "none";
    }
  });

  // Mark last
  db.ref(`users/${user}/chats/${id}/last`).set(Date.now());
}

// === Show last seen or online
function showLastSeenOrOnline(friendName) {
  // We'll just do a placeholder
  document.getElementById("lastSeenInfo").textContent = `(Online) - idle 0 min`; 
  // For real usage, you'd track presence in DB.
}

// === Top lock toggler for password
function toggleTopLock() {
  const pwd = document.getElementById("hiddenPassword");
  pwd.style.display = (pwd.style.display === "none") ? "inline" : "none";
}

// === Load initial messages
function loadInitialMessages(chatId, chatType) {
  const ref = db.ref(`${chatType==="group"?"groupChats":"privateChats"}/${chatId}/messages`);
  ref.off();
  ref
    .orderByKey()
    .limitToLast(100)
    .on("value", snap => {
      const msgDiv = document.getElementById("messages");
      msgDiv.innerHTML = "";
      const data = snap.val() || {};
      const sorted = Object.entries(data).sort((a,b) => (a[1].timestamp||0)-(b[1].timestamp||0));
      sorted.forEach(([k,v]) => {
        createMessageBubble(k, v, chatId, chatType);
      });
      msgDiv.scrollTop = 999999;
    });
}

// === Create bubble with double-click reaction
function createMessageBubble(msgId, msg, chatId, chatType) {
  const isMe = msg.sender === user;
  const bubble = document.createElement("div");
  bubble.className = "msg " + (isMe ? "me" : "them");

  // multiline check
  const lines = msg.text.split("\n");
  if (lines.length > 6) {
    // truncate to 4 lines
    const shortText = lines.slice(0,4).join("\n") + "\n(view full raw message)";
    bubble.textContent = shortText;
    bubble.onclick = () => {
      // open new blank tab with the raw text
      const blob = new Blob([msg.text], {type:"text/plain"});
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
    };
  } else {
    bubble.textContent = msg.text;
  }

  // If group, color the name
  if (chatType==="group" && msg.sender && msg.sender!=="_system" && !isMe) {
    const colorClass = getColorClass(msg.sender);
    bubble.innerHTML = `<span class='${colorClass}' style='font-weight:bold;margin-right:6px;'>${msg.sender}:</span> ` + bubble.innerHTML;
  }

  // Reaction Tag
  const reactTag = document.createElement("span");
  reactTag.className = "reactionTag";
  if (msg.reaction) {
    reactTag.textContent = msg.reaction;
  }
  bubble.appendChild(reactTag);

  // Reaction bar (hidden)
  const reactBar = document.createElement("div");
  reactBar.className = "reactionBar";
  const possibleReacts = ["‚ù§Ô∏è","üëç","üòÇ","üòÆ","üò¢"];
  possibleReacts.forEach(r => {
    const sp = document.createElement("span");
    sp.textContent = r;
    sp.onclick = (e) => {
      e.stopPropagation();
      applyReaction(chatId, chatType, msgId, r);
      reactBar.style.display = "none";
    };
    reactBar.appendChild(sp);
  });
  bubble.appendChild(reactBar);

  // double-click => show reaction bar
  bubble.addEventListener("dblclick", e => {
    e.stopPropagation();
    reactBar.style.display = reactBar.style.display==="flex" ? "none":"flex";
  });

  // timestamp
  const time = new Date(msg.timestamp||0).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
  const tspan = document.createElement("div");
  tspan.className = "timestamp " + (isMe ? "mineTime":"otherTime");
  tspan.textContent = time;
  bubble.appendChild(tspan);

  document.getElementById("messages").appendChild(bubble);
}

// apply reaction
function applyReaction(chatId, chatType, msgId, reaction) {
  db.ref(`${chatType==="group"?"groupChats":"privateChats"}/${chatId}/messages/${msgId}/reaction`).set(reaction);
}

// color class
function getColorClass(username) {
  if (!colorMap[username]) {
    const assigned = colorClasses[Math.floor(Math.random()*colorClasses.length)];
    colorMap[username] = assigned;
  }
  return colorMap[username];
}

// === Typing
function sendTyping() {
  if (!currentChat) return;
  db.ref(`${currentType==="group"?"groupChats":"privateChats"}/${currentChat}/typing`).set(user);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    db.ref(`${currentType==="group"?"groupChats":"privateChats"}/${currentChat}/typing`).set("");
  }, 2000);
}

// === Send message
function sendMessage() {
  const inp = document.getElementById("msgInput");
  const text = inp.value.trim();
  if (!text || !currentChat) return;
  const refPath = `${currentType==="group"?"groupChats":"privateChats"}/${currentChat}/messages`;
  const newMsg = {
    sender: user,
    text,
    timestamp: Date.now(),
    reaction: ""
  };
  db.ref(refPath).push(newMsg);
  inp.value = "";
  sendTyping();
}

// === toggle emoji
function toggleEmojiPicker() {
  const picker = document.getElementById("emojiPicker");
  picker.innerHTML = "";
  picker.style.display = picker.style.display==="flex"?"none":"flex";
  const emojiList = [..."üòÄüòÉüòÑüòÅüòÜüòÖüòÇü§£üòäüòáüôÇüôÉüòâüòåüòçüòòüòóüòôüòöüòãüòõüòùüòúü§™ü§®üßêü§ìüòéü•∏ü§©ü•≥üòèüòíüòûüòîüòüüòïüôÅ‚òπÔ∏èüò£üòñüò´üò©ü•∫üò¢üò≠üò§üò†üò°ü§¨ü§Øüò≥ü•µü•∂üò±üò®üò∞üò•üòìü§óü§îü§≠ü§´ü§•üò∂üòêüòë"];
  emojiList.forEach(e => {
    const sp = document.createElement("span");
    sp.textContent = e;
    sp.onclick = () => {
      document.getElementById("msgInput").value += e;
      picker.style.display="none";
    };
    picker.appendChild(sp);
  });
}

// === Lock Icon => Send local password
function toggleLock() {
  if (!currentChat||!currentType) return;
  const localPw = localStorage.getItem("pass")||"(none)";
  const text = `üîí Password: ${localPw}`;
  db.ref(`${currentType==="group"?"groupChats":"privateChats"}/${currentChat}/messages`).push({
    sender:user, text, timestamp:Date.now()
  });
}

// === Group Join / Create / Directory
function showJoinPanel(){ document.getElementById("groupJoinPanel").style.display="flex";}
function closeJoinPanel(){ document.getElementById("groupJoinPanel").style.display="none";}
function joinGroupChat() {
  const id = document.getElementById("joinGroupID").value.trim();
  const enteredPw = document.getElementById("joinGroupPassword").value.trim();
  if(!id)return;
  db.ref("groupChats/"+id).once("value",snap=>{
    const g = snap.val();
    if(!g)return showNotice("Group not found");
    if(g.type==="password" && g.password!==enteredPw)return showNotice("Wrong password");
    if(g.type==="invite" && !(g.members&&g.members[user]))return showNotice("You are not invited");
    db.ref("groupChats/"+id+"/members/"+user).set(true);
    db.ref(`users/${user}/chats/${id}`).set({name:g.name,type:"group",last:Date.now()});
    closeJoinPanel();
    openChat(id,g.name,"group");
  });
}

function showCreatePanel(){ document.getElementById("groupCreatePanel").style.display="flex";}
function closeCreatePanel(){ document.getElementById("groupCreatePanel").style.display="none";}
function createGroupChat() {
  const name = document.getElementById("groupName").value.trim();
  const type = document.getElementById("groupType").value;
  const pw = document.getElementById("groupPassword").value.trim();
  if(!name)return;
  const id = "group_"+Date.now();
  const members={};members[user]=true;
  db.ref(`groupChats/${id}`).set({name,type,password:pw,members,createdBy:user});
  db.ref(`users/${user}/chats/${id}`).set({name,type:"group",last:Date.now()});
  closeCreatePanel();
  openChat(id,name,"group");
}

function showDirectory(){ document.getElementById("directoryPanel").style.display="flex"; loadPublicDirectory();}
function closeDirectory(){ document.getElementById("directoryPanel").style.display="none";}
function loadPublicDirectory(){
  const list = document.getElementById("publicList");
  list.innerHTML = "<strong>Open Groups:</strong><br/>";
  db.ref("groupChats").once("value", snap=>{
    const groups = snap.val()||{};
    Object.entries(groups).forEach(([id,g])=>{
      if(g.type==="open"){
        const btn=document.createElement("button");
        btn.textContent = g.name+" ("+id+")";
        btn.onclick=()=>{
          db.ref(`groupChats/${id}/members/${user}`).set(true);
          db.ref(`users/${user}/chats/${id}`).set({name:g.name,type:"group",last:Date.now()});
          closeDirectory();
          openChat(id,g.name,"group");
        };
        list.appendChild(btn);
        list.appendChild(document.createElement("br"));
      }
    });
  });
}

// === Group Management
document.addEventListener("DOMContentLoaded",()=>{
  const manageBtn=document.createElement("button");
  manageBtn.textContent="üõ†";
  manageBtn.title="Manage Group";
  manageBtn.onclick=()=>{
    if(currentType==="group") openGroupManagement(currentChat);
  };
  document.getElementById("topButtons").appendChild(manageBtn);
});
function openGroupManagement(id){
  const panel=document.createElement("div");
  panel.style.position="fixed";
  panel.style.inset=0;
  panel.style.background="rgba(0,0,0,0.7)";
  panel.style.display="flex";
  panel.style.justifyContent="center";
  panel.style.alignItems="center";
  panel.style.zIndex=1001;
  const inner=document.createElement("div");
  inner.style.background="var(--chat-bg)";
  inner.style.padding="20px";
  inner.style.borderRadius="10px";
  inner.style.maxWidth="300px";
  inner.innerHTML=`
    <h3 style='margin-top:0'>Manage Group</h3>
    <label>Invite user:</label><br/>
    <input id='inviteUser' placeholder='Username' style='width:100%' /><br/>
    <label>With password:</label><br/>
    <input id='invitePass' type='password' placeholder='Optional password' style='width:100%' /><br/><br/>
    <button onclick='inviteToGroup(\"${id}\")'>Invite</button>
    <button onclick='this.parentElement.parentElement.remove()'>Close</button>
  `;
  panel.appendChild(inner);
  document.body.appendChild(panel);
}
function inviteToGroup(id){
  const username=document.getElementById("inviteUser").value.trim();
  const pw=document.getElementById("invitePass").value.trim();
  if(!username)return;
  db.ref(`groupChats/${id}/members/${username}`).set(true);
  db.ref(`users/${username}/chats/${id}`).set({name:"Group Invite",type:"group",last:Date.now()});
  if(pw) localStorage.setItem("pass",pw);
  showNotice(`User '${username}' invited to group!`);
}

// === Import/Export
function openImportExportPanel(){
  const panel=document.createElement("div");
  panel.style.position="fixed";
  panel.style.inset=0;
  panel.style.background="rgba(0,0,0,0.7)";
  panel.style.display="flex";
  panel.style.justifyContent="center";
  panel.style.alignItems="center";
  panel.style.zIndex=1001;
  const inner=document.createElement("div");
  inner.style.background="var(--chat-bg)";
  inner.style.padding="20px";
  inner.style.borderRadius="10px";
  inner.style.maxWidth="300px";
  inner.innerHTML=`
    <h3 style='margin-top:0'>Export / Import</h3>
    <button onclick='exportChatData()'>üì§ Export My Chats</button><br/><br/>
    <input type='file' onchange='importChatData(this.files[0])' /><br/><br/>
    <button onclick='this.parentElement.parentElement.remove()'>Close</button>
  `;
  panel.appendChild(inner);
  document.body.appendChild(panel);
}
function exportChatData(){
  const exportObj={};
  db.ref(`users/${user}/chats`).once("value", snap=>{
    const data=snap.val()||{};
    const promises=Object.keys(data).map(chatId=>{
      const path=(data[chatId].type==="group")?"groupChats":"privateChats";
      return db.ref(`${path}/${chatId}/messages`).once("value").then(s=>{
        exportObj[chatId]=s.val()||{};
      });
    });
    Promise.all(promises).then(()=>{
      const blob=new Blob([JSON.stringify(exportObj,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const link=document.createElement("a");
      link.href=url;
      link.download=`static-chat-backup-${user}.json`;
      link.click();
    });
  });
}
function importChatData(file){
  const rdr=new FileReader();
  rdr.onload=function(e){
    try{
      const imported=JSON.parse(e.target.result);
      Object.entries(imported).forEach(([chatId, msgs])=>{
        const path=(chatId.startsWith("group_"))?"groupChats":"privateChats";
        Object.entries(msgs).forEach(([mid,m])=>{
          db.ref(`${path}/${chatId}/messages/${mid}`).set(m);
        });
      });
      showNotice("Chat data imported successfully!");
    }catch(err){
      showNotice("Invalid backup file");
    }
  };
  rdr.readAsText(file);
}

// === Settings
function openSettings(){
  document.getElementById("settingsPanel").style.display="flex";
  document.getElementById("editUsername").value=user;
  document.getElementById("editPassword").value=pass;
  const theme=localStorage.getItem("theme")||"dark";
  document.getElementById("themeSelect").value=theme;
}
function closeSettings(){document.getElementById("settingsPanel").style.display="none";}
function saveSettings(){
  const newUser=document.getElementById("editUsername").value.trim();
  const newPass=document.getElementById("editPassword").value.trim();
  const newTheme=document.getElementById("themeSelect").value;
  if(!newUser)return;
  localStorage.setItem("user",newUser);
  localStorage.setItem("pass",newPass);
  localStorage.setItem("theme",newTheme);
  location.reload();
}

// === The End
console.log("‚úÖ Extended Static Live Chatting loaded & ready!");
</script>

<!-- Firebase Security Rules (Reference)
  {
    "rules": {
      ".read": "auth == null",
      ".write": "auth == null",
      "users": {
        "$username": { ".read":"true",".write":"true" }
      },
      "privateChats": {
        "$chatId": { ".read":"true",".write":"true" }
      },
      "groupChats": {
        "$groupId": { ".read":"true",".write":"true" }
      }
    }
  }
-->
</body>
</html>
