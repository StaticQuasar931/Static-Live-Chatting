<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Static Live Chatting ‚Äì Lag Fix</title>
  <style>
    :root {
      /* Dark theme default */
      --bg-color: #111;
      --text-color: #fff;
      --sidebar-color: #1c1c1c;
      --chat-bg: #222;
      --bubble-me: #1e90ff;
      --bubble-them: #444;
      --accent: #1e90ff;
      --badge: red;
      --chat-item-bg: #333;
    }
    body.light {
      --bg-color: #f4f4f4;
      --text-color: #000;
      --sidebar-color: #ddd;
      --chat-bg: #eee;
      --bubble-me: #007aff;
      --bubble-them: #ccc;
      --accent: #007acc;
      --chat-item-bg: #bbb;
    }
    body.blue {
      --bg-color: #0b1622;
      --text-color: #f0f8ff;
      --sidebar-color: #132336;
      --chat-bg: #1e2d40;
      --bubble-me: #1f65ff;
      --bubble-them: #41546a;
      --accent: #389fff;
      --chat-item-bg: #2e3d52;
    }
    body.green {
      --bg-color: #102a10;
      --text-color: #e8ffe8;
      --sidebar-color: #224522;
      --chat-bg: #1a331a;
      --bubble-me: #28a745;
      --bubble-them: #375a37;
      --accent: #4caf50;
      --chat-item-bg: #2b442b;
    }
    body.pink {
      --bg-color: #331024;
      --text-color: #ffe0f0;
      --sidebar-color: #441533;
      --chat-bg: #551a44;
      --bubble-me: #ff3377;
      --bubble-them: #773355;
      --accent: #ff66a2;
      --chat-item-bg: #442244;
    }

    body {
      margin:0; font-family:Arial,sans-serif;
      background:var(--bg-color); color:var(--text-color);
      height:100vh; display:flex; flex-direction:column; overflow:hidden;
    }
    input, button {
      padding:10px; font-size:16px; margin:5px;
      border-radius:6px; border:none;
    }
    button { background:var(--accent); color:#fff; cursor:pointer; }

    #app {
      display:flex; flex:1; height:100%;
    }
    #sidebar {
      width:280px; background:var(--sidebar-color);
      display:flex; flex-direction:column; padding:10px; overflow-y:auto;
    }
    #chatPanel {
      flex:1; display:flex; flex-direction:column;
      background:var(--chat-bg);
    }
    #topBar {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; font-size:18px; background:var(--chat-bg);
    }
    #messages {
      flex:1; display:flex; flex-direction:column-reverse;
      padding:15px; overflow-y:auto;
    }
    .msg {
      max-width:70%; padding:12px 16px; margin:6px 0;
      border-radius:20px; font-size:17px; line-height:1.4;
      word-wrap:break-word; position:relative; cursor:pointer;
    }
    .me {
      align-self:flex-end; background:var(--bubble-me); color:#fff;
      border-bottom-right-radius:5px;
    }
    .them {
      align-self:flex-start; background:var(--bubble-them); color:#fff;
      border-bottom-left-radius:5px;
    }
    .reactionBar {
      position:absolute; bottom:100%; left:50%;
      transform:translateX(-50%); display:none; flex-direction:row;
      gap:5px; background:rgba(0,0,0,0.6); padding:5px; border-radius:6px;
      margin-bottom:5px;
    }
    .reactionBar span { font-size:22px; cursor:pointer; }
    .reactionTag { margin-left:6px; font-size:14px; opacity:0.8; }
    .timestamp {
      position:absolute; font-size:10px; opacity:0.7; bottom:-14px;
    }
    .mineTime { right:10px; }
    .otherTime { left:10px; }
    .readReceipt { font-size:12px; opacity:0.6; margin-top:2px; }
    #typingIndicator {
      display:none; font-style:italic; font-size:14px;
      margin:0 20px 10px;
    }
    #inputArea {
      display:flex; padding:10px; background:var(--sidebar-color);
    }
    #inputArea input {
      flex:1; margin-right:5px; font-size:17px;
    }
    #emojiPicker {
      display:none; position:absolute; bottom:70px; right:15px;
      background:var(--chat-bg); padding:10px; flex-wrap:wrap;
      z-index:99; max-width:260px;
    }
    #emojiPicker span { font-size:22px; margin:6px; cursor:pointer; }
    .chatItem {
      background:var(--chat-item-bg);
      padding:10px; border-radius:6px; margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:center;
      cursor:pointer; transition:background 0.2s;
    }
    .chatItem:hover { background:var(--bubble-them); }
    .chatItem.active { outline:2px solid var(--accent); }
    .chatBadge {
      background:var(--badge); color:#fff; font-size:12px;
      padding:3px 8px; border-radius:12px; margin-left:5px;
    }
    .requestItem {
      background:var(--bubble-them); padding:10px;
      margin-bottom:5px; border-radius:6px;
    }
    #staticMenu {
      position:fixed; bottom:10px; left:10px;
      background:#1e1e1e; color:#fff; padding:5px 8px;
      border-radius:8px; font-size:13px; box-shadow:0 0 6px #0ff;
      animation:blink 2s infinite; z-index:1000;
    }
    .nameColor1{ color:#ff8888; }
    .nameColor2{ color:#88ff88; }
    .nameColor3{ color:#8888ff; }
    .nameColor4{ color:#ffff88; }
    .nameColor5{ color:#ff88ff; }

    @keyframes blink {
      0%,100% { opacity:1; }
      50% { opacity:0.6; }
    }
    /* center modals */
    .modal {
      position:fixed; inset:0; background:rgba(0,0,0,0.7);
      display:none; flex-direction:column; align-items:center; justify-content:center;
      z-index:999;
    }
    .panelContent {
      background:var(--chat-bg); padding:20px; border-radius:10px; max-width:400px;
    }
    /* center login form */
    #login {
      position:fixed; inset:0; display:flex;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,0.7); z-index:999;
    }
    #login .panelContent { max-width:300px; }

    @media(max-width:768px){
      body.mobile #sidebar { display:none; }
    }
  </style>
</head>
<body>

<script>
// If mobile
if(/Android|webOS|iPhone|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
  document.body.classList.add("mobile");
}

let user=localStorage.getItem("user")||"";
let pass=localStorage.getItem("pass")||"";

function toggleLoginPass(){
  const pw=document.getElementById("password");
  pw.type=(pw.type==="password")?"text":"password";
}
function doLogin(){
  const un=document.getElementById("username").value.trim();
  const pw=document.getElementById("password").value.trim();
  if(!un)return;
  localStorage.setItem("user",un);
  localStorage.setItem("pass",pw);
  user=un; pass=pw;
  startApp();
}
</script>

<!-- Confirm + Notice + Locked -->
<div id="confirmPanel" class="modal">
  <div class="panelContent" id="confirmInner"></div>
</div>
<div id="noticePanel" class="modal">
  <div class="panelContent" id="noticeInner"></div>
</div>
<div id="lockedPanel" class="modal">
  <div class="panelContent">
    <h3>Account Locked</h3>
    <input id="unlockPass" type="password" onkeypress="if(event.key==='Enter')tryUnlock()"/><br/>
    <button onclick="tryUnlock()">Unlock</button>
  </div>
</div>

<div id="friendsPanel" class="modal">
  <div class="panelContent" id="friendsInner"></div>
</div>
<div id="addChatPanel" class="modal">
  <div class="panelContent" id="addChatInner"></div>
</div>
<div id="groupJoinPanel" class="modal">
  <div class="panelContent">
    <h3>Join Group Chat</h3>
    <input id="joinGroupID" placeholder="Group ID" onkeypress="if(event.key==='Enter')joinGroupChat()"/><br/>
    <input id="joinGroupPassword" placeholder="Password (if needed)" onkeypress="if(event.key==='Enter')joinGroupChat()"/><br/>
    <button onclick="joinGroupChat()">Join</button>
    <button onclick="closeJoinPanel()">Close</button>
  </div>
</div>
<div id="groupCreatePanel" class="modal">
  <div class="panelContent">
    <h3>Create Group</h3>
    <input id="groupName" placeholder="Group Name" onkeypress="if(event.key==='Enter')createGroupChat()"/><br/>
    <select id="groupType">
      <option value="open">Open</option>
      <option value="password">Password</option>
      <option value="invite">Invite Only</option>
    </select><br/>
    <input id="groupPassword" placeholder="Password (optional)" onkeypress="if(event.key==='Enter')createGroupChat()"/><br/>
    <button onclick="createGroupChat()">Create</button>
    <button onclick="closeCreatePanel()">Close</button>
  </div>
</div>
<div id="directoryPanel" class="modal">
  <div class="panelContent">
    <h3>All Public Groups</h3>
    <div id="publicList" style="max-height:300px;overflow:auto;"></div>
    <button onclick="closeDirectory()">Close</button>
  </div>
</div>
<div id="editGroupPanel" class="modal">
  <div class="panelContent" id="editGroupInner"></div>
</div>

<!-- Settings Panel -->
<div id="settingsPanel" class="modal">
  <div class="panelContent">
    <h3>Settings</h3>
    <label>Username:</label><br/>
    <input id="editUsername"/><br/>
    <label>Password (Key used to message/friend requests):</label><br/>
    <input id="editPassword"/><br/>
    <p>Verification pass (5-min idle lock):</p>
    <input id="lockPass" type="password"/><br/>
    <button onclick="lockNow()">Lock Now</button>
    <button onclick="saveSettings()">Save</button>
    <button onclick="closeSettings()">Close</button><br/>
    <button onclick="openImportExportPanel()">üì§ Import/Export</button><br/>
    <button onclick="blockUserUI()">Block/Unblock Users</button>
  </div>
</div>

<!-- Login Centered -->
<div id="login" style="display:flex;">
  <div class="panelContent" style="max-width:300px;">
    <h2>Static Live Chatting</h2>
    <p>‚ö†Ô∏è Key is used for friend requests and messaging</p>
    <input id="username" placeholder="Username" onkeypress="if(event.key==='Enter')doLogin()"/><br/>
    <div style="display:flex;align-items:center;">
      <input id="password" type="password" placeholder="Key (can share with friends)" style="margin:5px 0;flex:1;"
             onkeypress="if(event.key==='Enter')doLogin()"/>
      <button style="margin:5px 0;" onclick="toggleLoginPass()">üëÅÔ∏è</button>
    </div>
    <button onclick="doLogin()">Log In</button>
  </div>
</div>

<!-- Main App -->
<div id="app" style="display:none;">
  <div id="sidebar">
    <button onclick="openFriendsPanel()">Friends</button>
    <button onclick="addFriendUI()">Add Friend</button>
    <button onclick="showAddChatPanel()">Add Chat</button>
    <h3>Friend Requests</h3>
    <div id="requestsTab"></div>
    <div id="requestsSentTab" style="margin-top:8px; color:#ccc;"></div>
    <hr/>
    <h3>Chats</h3>
    <div id="chatList"></div>
  </div>

  <div id="chatPanel">
    <div id="topBar">
      <div id="chatTitle">No Chat</div>
      <div style="display:flex;align-items:center;">
        <button id="themeBtn" onclick="toggleTheme()" style="margin-right:10px;">Theme</button>
        <button onclick="openSettings()">‚öôÔ∏è</button>
      </div>
    </div>
    <div id="groupMembers" style="padding:5px 15px;display:none;font-size:14px;"></div>
    <div id="messages"></div>
    <div id="typingIndicator"></div>
    <div id="inputArea">
      <input id="msgInput" placeholder="Type..."
             oninput="sendTyping()" onkeypress="if(event.key==='Enter')sendMessage();"/>
      <button onclick="toggleEmojiPicker()">üòÄ</button>
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="emojiPicker"></div>
  </div>
</div>

<div id="staticMenu">
  üåü More Unblocked Games by Static
</div>

<script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>
<script>

// Initialize
const firebaseConfig={
  apiKey:"AIzaSyBO7EHU4-_b2NHf7UFYTB8Wolv73Z0P8Fw",
  authDomain:"static-live-chatting.firebaseapp.com",
  databaseURL:"https://static-live-chatting-default-rtdb.firebaseio.com",
  projectId:"static-live-chatting",
  storageBucket:"static-live-chatting.appspot.com",
  messagingSenderId:"578562140653",
  appId:"1:578562140653:web:c12df07155627083e9dfe4"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let colorMap={}, blocked={}, friends={};
let currentChat="", currentType="";
let chatActive="";
let chatUnread={};

let verificationPass=localStorage.getItem("verificationPass")||"";
let isLocked=false, idleTimer=null;

//** if user stored => skip login
if(user){
  document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="flex";
    applyTheme();
    loadBlocked(); loadFriends(); loadChats(); loadRequests();
    setIdleLockTimer();
  });
}

//** idle lock
document.onmousemove=setIdleLockTimer;
document.onkeypress=setIdleLockTimer;
function setIdleLockTimer(){
  clearTimeout(idleTimer);
  if(verificationPass){
    idleTimer=setTimeout(()=>lockAccount(),5*60*1000);
  }
}
function lockNow(){
  if(!verificationPass){
    const v=document.getElementById("lockPass").value.trim();
    if(!v)return showNotice("No verification pass!");
    verificationPass=v;
    localStorage.setItem("verificationPass",v);
  }
  lockAccount();
}
function lockAccount(){
  if(isLocked)return;
  isLocked=true;
  document.getElementById("lockedPanel").style.display="flex";
  document.getElementById("unlockPass").value="";
}
function tryUnlock(){
  const up=document.getElementById("unlockPass").value.trim();
  if(up===verificationPass){
    isLocked=false;
    document.getElementById("lockedPanel").style.display="none";
    setIdleLockTimer();
  } else showNotice("Wrong verification pass!");
}
window.onbeforeunload=()=>{
  if(isLocked)return null;
  return "Are you sure you want to leave?";
};

//** theming
function toggleTheme(){
  const c=(document.body.classList.contains("light")?"light":
           document.body.classList.contains("blue")?"blue":
           document.body.classList.contains("green")?"green":
           document.body.classList.contains("pink")?"pink":"dark");
  let next="dark";
  if(c==="dark") next="light";
  else if(c==="light") next="blue";
  else if(c==="blue") next="green";
  else if(c==="green") next="pink";
  else if(c==="pink") next="dark";
  document.body.classList.remove("light","blue","green","pink");
  if(next==="light") document.body.classList.add("light");
  if(next==="blue") document.body.classList.add("blue");
  if(next==="green") document.body.classList.add("green");
  if(next==="pink") document.body.classList.add("pink");
  localStorage.setItem("theme", next);
  showNotice(`Your current theme: ${next}`);
}
function applyTheme(){
  const saved=localStorage.getItem("theme")||"dark";
  document.body.classList.remove("light","blue","green","pink");
  if(saved==="light") document.body.classList.add("light");
  else if(saved==="blue") document.body.classList.add("blue");
  else if(saved==="green") document.body.classList.add("green");
  else if(saved==="pink") document.body.classList.add("pink");
}

//** blocking/friends
function loadBlocked(){
  db.ref(`users/${user}/blocked`).on("value", snap=>{
    blocked=snap.val()||{};
  });
}
function loadFriends(){
  db.ref(`users/${user}/friends`).on("value", snap=>{
    friends=snap.val()||{};
  });
}
function blockUserUI(){
  showConfirm("Enter user to block/unblock:<br/><input id='blkU' onkeypress='if(event.key===\"Enter\")confirmYes()'/>",()=>{
    const bn=document.getElementById("blkU").value.trim();
    if(!bn)return showNotice("No user typed");
    if(blocked[bn]){
      db.ref(`users/${user}/blocked/${bn}`).remove();
      showNotice(`Unblocked ${bn}`);
    } else {
      db.ref(`users/${user}/blocked/${bn}`).set(true);
      showNotice(`Blocked ${bn}`);
    }
  });
}
function addFriendUI(){
  showConfirm("Enter friend's username:<br/><input id='addF' onkeypress='if(event.key===\"Enter\")confirmYes()'/>",()=>{
    const f=document.getElementById("addF").value.trim();
    if(!f)return showNotice("No user typed!");
    if(blocked[f])return showNotice("You blocked them. Unblock first.");
    db.ref(`users/${f}/requests/${user}`).set({requested:true});
    db.ref(`users/${user}/requestsSent/${f}`).set(true);
    db.ref(`privateChats/${[user,f].sort().join("_")}`).set({});
    showNotice(`Friend request sent to ${f}`);
  });
}
function openFriendsPanel(){
  if(isLocked)return;
  const fi=document.getElementById("friendsInner");
  fi.innerHTML="<h3>Your Friends</h3>";
  Object.keys(friends).forEach(fr=>{
    const div=document.createElement("div");
    div.style.background="var(--chat-bg)";
    div.style.padding="8px"; div.style.marginBottom="8px";
    div.style.borderRadius="6px";
    div.innerHTML=`<b>${fr}</b><br/>`;

    const bOpen=document.createElement("button");
    bOpen.textContent="Open Chat";
    bOpen.onclick=()=>{
      const cid=[user,fr].sort().join("_");
      db.ref(`privateChats/${cid}`).once("value", s=>{
        if(!s.exists()) db.ref(`privateChats/${cid}`).set({});
      });
      db.ref(`users/${user}/chats/${cid}`).set({name:fr,type:"private",last:Date.now()});
      closeFriendsPanel();
      openChat(cid,fr,"private");
    };
    div.appendChild(bOpen);

    const bInv=document.createElement("button");
    bInv.textContent="Invite Group";
    bInv.onclick=()=>pickGroupForInvite(fr);
    div.appendChild(bInv);

    const bBlk=document.createElement("button");
    bBlk.textContent=(blocked[fr])?"Unblock":"Block";
    bBlk.onclick=()=>{
      if(blocked[fr]){
        db.ref(`users/${user}/blocked/${fr}`).remove();
        showNotice(`Unblocked ${fr}`);
      } else {
        db.ref(`users/${user}/blocked/${fr}`).set(true);
        showNotice(`Blocked ${fr}`);
      }
    };
    div.appendChild(bBlk);

    fi.appendChild(div);
  });
  document.getElementById("friendsPanel").style.display="flex";
}
function closeFriendsPanel(){
  document.getElementById("friendsPanel").style.display="none";
}
function pickGroupForInvite(friend){
  db.ref(`users/${user}/chats`).once("value", snap=>{
    const data=snap.val()||{};
    const groups=Object.entries(data).filter(([id,inf])=>inf.type==="group");
    if(!groups.length)return showNotice("No group found to invite!");
    let h=`<h3>Pick Group for ${friend}</h3>`;
    groups.forEach(([gid,ginfo])=>{
      h+=`<button onclick='inviteFriendToGroup("${gid}","${friend}")'>${ginfo.name}</button><br/>`;
    });
    h+=`<button onclick='closeFriendsPanel()'>Close</button>`;
    document.getElementById("friendsInner").innerHTML=h;
  });
}
function inviteFriendToGroup(gid, friend){
  db.ref(`groupChats/${gid}/members/${friend}`).set(true);
  db.ref(`users/${friend}/chats/${gid}`).set({name:"Group Invite",type:"group",last:Date.now()});
  showNotice(`Invited ${friend} to group ${gid}`);
}

//** load chats + requests
function loadChats(){
  db.ref(`users/${user}/chats`).on("value", snap=>{
    const data=snap.val()||{};
    const sorted=Object.entries(data).sort((a,b)=>(b[1].last||0)-(a[1].last||0));
    const cList=document.getElementById("chatList");
    cList.innerHTML="";
    sorted.forEach(([id,info])=>{
      const div=document.createElement("div");
      div.className="chatItem";
      if(id===chatActive) div.classList.add("active");
      let nm=info.name||id;
      if(info.type==="private"&&blocked[nm]) nm+=" [Blocked]";
      div.textContent=nm;

      const rowRight=document.createElement("div");
      rowRight.style.display="flex"; rowRight.style.alignItems="center";
      if(chatUnread[id]){
        const bd=document.createElement("span");
        bd.className="chatBadge";
        bd.textContent="+"+chatUnread[id];
        rowRight.appendChild(bd);
      }
      const delBtn=document.createElement("button");
      delBtn.textContent="üóë";
      delBtn.onclick=(e)=>{
        e.stopPropagation();
        confirmDeleteChat(id, info);
      };
      rowRight.appendChild(delBtn);
      div.appendChild(rowRight);

      div.onclick=()=>{
        openChat(id,nm,info.type);
        highlightChat(id);
      };
      cList.appendChild(div);
    });
  });
}
function highlightChat(id){
  chatActive=id;
  document.querySelectorAll(".chatItem").forEach(i=>i.classList.remove("active"));
}
function loadRequests(){
  const tab=document.getElementById("requestsTab");
  const st=document.getElementById("requestsSentTab");
  // inbound
  db.ref(`users/${user}/requests`).on("value", snap=>{
    const data=snap.val()||{};
    tab.innerHTML="";
    // If too large, you might page them
    // For example, we only show up to 20
    let requestKeys=Object.keys(data);
    let showRequests=requestKeys.slice(0,20);
    showRequests.forEach(from=>{
      const d=document.createElement("div");
      d.className="requestItem";
      d.textContent=`${from} wants to chat `;
      const g=document.createElement("button");
      g.textContent="‚úî";
      g.style.background="green";
      g.onclick=()=>{
        if(blocked[from])return showNotice("You blocked them. Unblock first.");
        const cid=[user,from].sort().join("_");
        db.ref(`privateChats/${cid}`).set({});
        db.ref(`users/${user}/chats/${cid}`).set({name:from,type:"private",last:Date.now()});
        db.ref(`users/${user}/requests/${from}`).remove();
        db.ref(`users/${user}/friends/${from}`).set(true);
        db.ref(`users/${from}/friends/${user}`).set(true);

        // remove from their requestsSent
        db.ref(`users/${from}/requestsSent/${user}`).once("value", s2=>{
          if(s2.exists()){
            db.ref(`users/${from}/requestsSent/${user}`).remove();
            db.ref(`users/${from}/accepted/${user}`).set(true);
            setTimeout(()=>db.ref(`users/${from}/accepted/${user}`).remove(),3000);
          }
        });

        openChat(cid,from,"private");
      };
      d.appendChild(g);

      const r=document.createElement("button");
      r.textContent="‚úò";
      r.style.background="red";
      r.onclick=()=>{
        db.ref(`users/${user}/requests/${from}`).remove();
      };
      d.appendChild(r);
      tab.appendChild(d);
    });
    if(requestKeys.length>20){
      const more=document.createElement("div");
      more.textContent=`(Only showing 20 of ${requestKeys.length}...)`;
      tab.appendChild(more);
    }
  });
  // outbound
  db.ref(`users/${user}/requestsSent`).on("value", snap2=>{
    const outData=snap2.val()||{};
    st.innerHTML="<strong>Requests Sent:</strong><br/>";
    let reqKeys=Object.keys(outData);
    let showKeys=reqKeys.slice(0,20);
    showKeys.forEach(to=>{
      const d=document.createElement("div");
      d.className="requestItem";
      d.textContent=`(Pending) ${to} `;
      const c=document.createElement("button");
      c.textContent="Cancel";
      c.onclick=()=>{
        db.ref(`users/${user}/requestsSent/${to}`).remove();
        db.ref(`users/${to}/requests/${user}`).remove();
      };
      d.appendChild(c);
      st.appendChild(d);
    });
    if(reqKeys.length>20){
      const mor=document.createElement("div");
      mor.textContent=`(Only showing 20 of ${reqKeys.length}...)`;
      st.appendChild(mor);
    }
  });
  // watch accepted
  db.ref(`users/${user}/accepted`).on("child_added", s=>{
    const who=s.key;
    showNotice(`${who} accepted your request! Chat unlocked.`);
    db.ref(`users/${user}/requestsSent/${who}`).remove();
    const cid=[user,who].sort().join("_");
    db.ref(`privateChats/${cid}`).once("value", s3=>{
      if(!s3.exists()) db.ref(`privateChats/${cid}`).set({});
    });
    db.ref(`users/${user}/chats/${cid}`).set({name:who,type:"private",last:Date.now()});
    if(!currentChat) openChat(cid,who,"private");
    setTimeout(()=>db.ref(`users/${user}/accepted/${who}`).remove(),3000);
  });
}
function confirmDeleteChat(chatId, info){
  if(info.type==="group"){
    db.ref(`groupChats/${chatId}/createdBy`).once("value", s=>{
      const c=s.val();
      if(c!==user){
        showConfirm(`Leave group ${info.name}?`,()=>{
          db.ref(`groupChats/${chatId}/members/${user}`).remove();
          db.ref(`users/${user}/chats/${chatId}`).remove();
          showNotice("Left group.");
        });
      } else {
        showConfirm(`Delete group ${info.name}?`,()=>{
          db.ref(`groupChats/${chatId}`).remove();
          db.ref(`users/${user}/chats/${chatId}`).remove();
          showNotice("Group chat deleted for all!");
        });
      }
    });
  } else {
    showConfirm(`Leave private chat with ${info.name}?`,()=>{
      db.ref(`users/${user}/chats/${chatId}`).remove();
      showNotice("Private chat removed from your list.");
    });
  }
}

//** open chat with child watchers
let msgRef=null;
function openChat(cid,nm,ty){
  if(isLocked)return;
  currentChat=cid; currentType=ty;
  chatUnread[cid]=0;
  highlightChat(cid);

  document.getElementById("chatTitle").textContent=nm||cid;
  document.getElementById("messages").innerHTML="";
  document.getElementById("groupMembers").style.display=(ty==="group")?"block":"none";

  // remove old watchers
  if(msgRef) msgRef.off();

  // watch child_added for the last 100
  const path=(ty==="group"?"groupChats":"privateChats")+"/"+cid+"/messages";
  msgRef=db.ref(path).orderByKey().limitToLast(100);

  // We'll store them in memory so we can do child_removed or child_changed if needed
  let messages={};

  msgRef.on("child_added", snap=>{
    const mid=snap.key, mval=snap.val();
    messages[mid]=mval;
    addMessageToDom(mid,mval,ty);
  });
  msgRef.on("child_changed", snap=>{
    const mid=snap.key, mval=snap.val();
    messages[mid]=mval;
    // re-render that message bubble
    updateMessageBubble(mid,mval);
  });
  // optional child_removed if you allow deletes
  db.ref(`${(ty==="group"?"groupChats":"privateChats")}/${cid}/typing`).off();
  db.ref(`${(ty==="group"?"groupChats":"privateChats")}/${cid}/typing`).on("value", s=>{
    const val=s.val();
    const t=document.getElementById("typingIndicator");
    if(val && val!==user){
      t.style.display="block";
      t.textContent=`${val} is typing...`;
    } else t.style.display="none";
  });
  db.ref(`users/${user}/chats/${cid}/last`).set(Date.now());

  // optional group membership watchers
  if(ty==="group"){
    db.ref(`groupChats/${cid}/members`).on("value", sp=>{
      const mm=Object.keys(sp.val()||{});
      document.getElementById("groupMembers").textContent="Members: "+mm.join(", ");
    });
  }
}
function addMessageToDom(mid,mval,ty){
  const cont=document.getElementById("messages");
  const bubble=document.createElement("div");
  bubble.id="msg_"+mid;
  bubble.className="msg "+((mval.sender===user)?"me":"them");

  const lines=mval.text.split("\n");
  if(lines.length>6){
    bubble.textContent=lines.slice(0,4).join("\n")+"\n(view full raw message)";
    bubble.onclick=()=>{
      const blob=new Blob([mval.text],{type:"text/plain"});
      const url=URL.createObjectURL(blob);
      window.open(url,"_blank");
    };
  } else {
    bubble.textContent=mval.text;
  }
  if(ty==="group" && mval.sender!=="_system" && mval.sender!==user){
    const cc=getColorClass(mval.sender);
    bubble.innerHTML=`<span class='${cc}' style='font-weight:bold;margin-right:6px;'>${mval.sender}:</span> `+bubble.innerHTML;
  }
  if(mval.sender==="_system"){
    bubble.style.fontStyle="italic"; bubble.style.opacity="0.7";
  }

  const rt=document.createElement("span");
  rt.className="reactionTag";
  if(mval.reaction) rt.textContent=mval.reaction;
  bubble.appendChild(rt);

  const rBar=document.createElement("div");
  rBar.className="reactionBar";
  ["‚ù§Ô∏è","üëç","üòÇ","üòÆ","üò¢"].forEach(r=>{
    const sp=document.createElement("span");
    sp.textContent=r;
    sp.onclick=(e)=>{
      e.stopPropagation();
      applyReaction(mid,r);
      rBar.style.display="none";
    };
    rBar.appendChild(sp);
  });
  bubble.appendChild(rBar);

  bubble.addEventListener("dblclick", e=>{
    e.stopPropagation();
    if(isLocked)return;
    rBar.style.display=(rBar.style.display==="flex")?"none":"flex";
  });

  const time=new Date(mval.timestamp||0).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});
  const ts=document.createElement("div");
  ts.className="timestamp "+((mval.sender===user)?"mineTime":"otherTime");
  ts.textContent=time;
  bubble.appendChild(ts);

  if(ty==="group"){
    if(mval.readBy){
      const readList=Object.keys(mval.readBy).filter(u=>u!==mval.sender);
      if(readList.length>0){
        const rd=document.createElement("div");
        rd.className="readReceipt";
        rd.textContent="Seen by: "+readList.join(", ");
        bubble.appendChild(rd);
      }
    }
  } else {
    if(mval.sender===user && mval.readBy){
      const readOthers=Object.keys(mval.readBy).filter(u=>u!==user);
      if(readOthers.length>0){
        const rd=document.createElement("div");
        rd.className="readReceipt";
        rd.textContent="Seen";
        bubble.appendChild(rd);
      }
    }
  }

  cont.insertBefore(bubble, cont.firstChild);
}
function updateMessageBubble(mid,mval){
  const bubble=document.getElementById("msg_"+mid);
  if(!bubble)return;
  // we can remove or re-generate. For simplicity we re-generate quickly:
  bubble.innerHTML="";
  bubble.className="msg "+((mval.sender===user)?"me":"them");
  const lines=mval.text.split("\n");
  if(lines.length>6){
    bubble.textContent=lines.slice(0,4).join("\n")+"\n(view full raw message)";
    // no onclick re-define
  } else bubble.textContent=mval.text;
  // reaction, time, read receipts etc. (similar logic to addMessageToDom)
}
function markMessagesRead(msgKeys){
  if(!currentChat)return;
  const path=(currentType==="group"?"groupChats":"privateChats");
  msgKeys.forEach(mId=>{
    db.ref(`${path}/${currentChat}/messages/${mId}/readBy/${user}`).set(Date.now());
  });
}
function applyReaction(mid,r){
  if(!currentChat||!currentType)return;
  const path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/messages/${mid}/reaction`).set(r);
}

function sendTyping(){
  if(!currentChat||isLocked)return;
  const path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/typing`).set(user);
  setTimeout(()=>{
    db.ref(`${path}/${currentChat}/typing`).set("");
  },2000);
}
function sendMessage(){
  if(isLocked)return;
  const inp=document.getElementById("msgInput");
  const text=inp.value.trim();
  if(!text||!currentChat)return;
  if(currentType==="private"){
    // check blocked
    const nm=document.getElementById("chatTitle").textContent.replace(" [Blocked]","");
    if(blocked[nm])return showNotice("You blocked them. Unblock first!");
  }
  const path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/messages`).push({
    sender:user, text, timestamp:Date.now(),
    reaction:"",
    readBy:{[user]:Date.now()}
  });
  inp.value="";
  sendTyping();

  // optional: If many messages => truncate older than 2000
  db.ref(`${path}/${currentChat}/messages`).orderByKey().limitToFirst(1).once("value", snap=>{
    const data=snap.val()||{};
    const keys=Object.keys(data);
    if(keys.length>2000){
      // remove oldest 
      db.ref(`${path}/${currentChat}/messages/${keys[0]}`).remove();
    }
  });
}

function showAddChatPanel(){
  if(isLocked)return;
  const i=document.getElementById("addChatInner");
  i.innerHTML=`
    <h3>Add Chat</h3>
    <button onclick='showCreatePanel()'>Create Group</button><br/>
    <button onclick='showJoinPanel()'>Join Group</button><br/>
    <button onclick='closeAddChatPanel()'>Close</button>
  `;
  document.getElementById("addChatPanel").style.display="flex";
}
function closeAddChatPanel(){ document.getElementById("addChatPanel").style.display="none"; }
function closeJoinPanel(){ document.getElementById("groupJoinPanel").style.display="none"; }
function closeCreatePanel(){ document.getElementById("groupCreatePanel").style.display="none"; }
function closeDirectory(){ document.getElementById("directoryPanel").style.display="none"; }

function createGroupChat(){
  if(isLocked)return;
  const nm=document.getElementById("groupName").value.trim();
  const ty=document.getElementById("groupType").value;
  const pw=document.getElementById("groupPassword").value.trim();
  if(!nm)return;
  const gid="group_"+Date.now();
  const members={}; members[user]=true;
  db.ref(`groupChats/${gid}`).set({name:nm,type:ty,password:pw,createdBy:user,members});
  db.ref(`users/${user}/chats/${gid}`).set({name:nm,type:"group",last:Date.now()});
  closeCreatePanel(); closeAddChatPanel();
  openChat(gid,nm,"group");
}
function joinGroupChat(){
  const id=document.getElementById("joinGroupID").value.trim();
  const pw=document.getElementById("joinGroupPassword").value.trim();
  if(!id)return;
  db.ref(`groupChats/${id}`).once("value", snap=>{
    const g=snap.val();
    if(!g)return showNotice("Group not found");
    if(g.type==="password" && g.password!==pw)return showNotice("Wrong password");
    if(g.type==="invite" && !(g.members && g.members[user]))return showNotice("Not invited!");
    db.ref(`groupChats/${id}/members/${user}`).set(true);
    db.ref(`users/${user}/chats/${id}`).set({name:g.name,type:"group",last:Date.now()});
    closeJoinPanel(); closeAddChatPanel();
    openChat(id,g.name,"group");
  });
}

//** import/export
function openImportExportPanel(){
  if(isLocked)return;
  const panel=document.createElement("div");
  panel.style.position="fixed";
  panel.style.inset=0;
  panel.style.background="rgba(0,0,0,0.7)";
  panel.style.display="flex";
  panel.style.justifyContent="center";
  panel.style.alignItems="center";
  panel.style.zIndex=1001;

  const inn=document.createElement("div");
  inn.style.background="var(--chat-bg)";
  inn.style.padding="20px";
  inn.style.borderRadius="10px";
  inn.style.maxWidth="300px";
  inn.innerHTML=`
    <h3 style='margin-top:0'>Export / Import</h3>
    <button onclick='exportChatData()'>üì§ Export My Chats</button><br/><br/>
    <input type='file' onchange='importChatData(this.files[0])'/><br/><br/>
    <button onclick='this.parentElement.parentElement.remove()'>Close</button>
  `;
  panel.appendChild(inn);
  document.body.appendChild(panel);
}
function exportChatData(){
  db.ref(`users/${user}/chats`).once("value", snap=>{
    const data=snap.val()||{};
    const exportObj={};
    const tasks=Object.keys(data).map(cid=>{
      const path=(data[cid].type==="group")?"groupChats":"privateChats";
      return db.ref(`${path}/${cid}/messages`).once("value").then(ss=>{
        exportObj[cid]=ss.val()||{};
      });
    });
    Promise.all(tasks).then(()=>{
      const blob=new Blob([JSON.stringify(exportObj,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const link=document.createElement("a");
      link.href=url;
      link.download=`static-chat-backup-${user}.json
