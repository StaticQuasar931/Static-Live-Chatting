<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Static Live Chatting</title>
  <style>
    :root {
      --bg: #111; --text: #fff; --panel: #222; --btn: #1e90ff;
    }
    .light {
      --bg: #f9f9f9; --text: #111; --panel: #ddd; --btn: #007acc;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: sans-serif;
      background: var(--bg); color: var(--text);
      height: 100vh; display: flex; flex-direction: column;
      transition: background 0.3s, color 0.3s;
    }
    input, button {
      padding: 10px; font-size: 16px; border: none; border-radius: 6px;
    }
    button { background: var(--btn); color: white; cursor: pointer; }
    #login, #addFriend, #settings {
      position: fixed; inset: 0; background: var(--bg);
      display: flex; flex-direction: column; justify-content: center;
      align-items: center; z-index: 99;
    }
    #app { display: flex; flex: 1; height: 100vh; }
    #sidebar {
      width: 250px; background: var(--panel); padding: 10px;
      overflow-y: auto;
    }
    #chatPanel { flex: 1; display: flex; flex-direction: column; }
    #topBar {
      display: flex; justify-content: space-between;
      padding: 10px; background: var(--panel);
    }
    #messages {
      flex: 1; padding: 10px; overflow-y: auto;
    }
    .msg span { color: var(--btn); font-weight: bold; }
    .msg { margin-bottom: 8px; }
    .chatItem {
      background: #333; margin: 5px 0; padding: 8px;
      border-radius: 5px; cursor: pointer;
    }
    .chatItem:hover { background: #444; }
    #inputArea {
      display: flex; padding: 10px; background: var(--panel);
    }
    #inputArea input { flex: 1; margin-right: 5px; }
    #staticMenu {
      position: fixed; bottom: 10px; left: 10px;
      background: var(--btn); padding: 10px 15px;
      color: white; border-radius: 10px;
      animation: twinkle 3s infinite; z-index: 100;
    }
    @keyframes twinkle {
      0%,100% { box-shadow: 0 0 5px var(--btn); }
      50% { box-shadow: 0 0 15px var(--btn); }
    }
    #showPassToggle {
      background: none; color: var(--btn); border: none;
      margin-top: 5px; font-size: 14px; cursor: pointer;
    }
  </style>
</head>
<body>

<div id="staticMenu">
  <a href="https://sites.google.com/view/staticquasar931/gm3z" style="color:white; text-decoration:none;">
    More Unblocked Games by Static
  </a>
</div>

<div id="login">
  <h2>Static Live Chatting</h2>
  <p>‚ö†Ô∏è Do not chat sensitive info.</p>
  <input id="username" placeholder="Your nickname" />
  <input id="userpass" type="password" placeholder="Password (chat key)" />
  <button id="showPassToggle" onclick="togglePassword()">üëÅ Show Password</button>
  <p style="color: orange; font-size: 13px;">Write this down or remember it.</p>
  <button onclick="startChat()">Log In</button>
</div>

<!-- App UI (Chat + Sidebar + Settings) -->
<div id="app" style="display:none;">
  <div id="sidebar">
    <h3>Friends</h3>
    <div id="chatList"></div>
    <button onclick="openAdd()">‚ûï Add</button>
  </div>
  <div id="chatPanel">
    <div id="topBar">
      <div id="chatTitle">No Chat</div>
      <button onclick="openSettings()">‚öôÔ∏è</button>
    </div>
    <div id="messages"></div>
    <div id="inputArea">
      <input id="msgInput" placeholder="Type message..." />
      <button onclick="sendMsg()">Send</button>
    </div>
    <div id="typing" style="padding: 5px; font-size: 14px; color: gray;"></div>
  </div>
</div>

<!-- Firebase Setup -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBO7EHU4-_b2NHf7UFYTB8Wolv73Z0P8Fw",
  authDomain: "static-live-chatting.firebaseapp.com",
  databaseURL: "https://static-live-chatting-default-rtdb.firebaseio.com",
  projectId: "static-live-chatting",
  storageBucket: "static-live-chatting.appspot.com",
  messagingSenderId: "578562140653",
  appId: "1:578562140653:web:c12df07155627083e9dfe4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let user = localStorage.getItem("user") || "";
let pass = localStorage.getItem("pass") || "";
let locked = localStorage.getItem("locked") === "true";
let chat = "";

if (user && pass && !locked) {
  document.getElementById("login").style.display = "none";
  document.getElementById("app").style.display = "flex";
  loadChats();
}

function togglePassword() {
  const input = document.getElementById("userpass");
  input.type = input.type === "password" ? "text" : "password";
}

function startChat() {
  user = document.getElementById("username").value.trim();
  pass = document.getElementById("userpass").value.trim();
  if (!user || !pass) return alert("Enter username and password");
  localStorage.setItem("user", user);
  localStorage.setItem("pass", pass);
  localStorage.setItem("locked", "false");
  document.getElementById("login").style.display = "none";
  document.getElementById("app").style.display = "flex";
  loadChats();
}

function loadChats() {
  db.ref("chats/" + user).once("value", snap => {
    const chats = snap.val() || {};
    const box = document.getElementById("chatList");
    box.innerHTML = "";
    Object.keys(chats).forEach(friend => {
      const div = document.createElement("div");
      div.className = "chatItem";
      const label = chats[friend].name || friend;
      div.textContent = label;
      div.onclick = () => openChat(friend, label);
      box.appendChild(div);
    });
  });
}

function openChat(friend, label) {
  chat = friend;
  document.getElementById("chatTitle").innerHTML = `${label} <small style="font-size:12px;">(was ${friend})</small>`;
  document.getElementById("messages").innerHTML = "";

  const ref = db.ref(`messages/${user}-${friend}`);
  ref.off();
  ref.on("child_added", snap => {
    const m = snap.val();
    if (m.text === "password_changed_notice") {
      const warn = `<div class="msg"><span>SYSTEM</span>: User has changed their password, please input new password to keep messaging them.</div>`;
      document.getElementById("messages").innerHTML += warn;
    } else {
      const time = new Date(m.timestamp).toLocaleTimeString();
      const msg = `<div class="msg"><span>${m.user}</span> (${time}): ${m.text}</div>`;
      document.getElementById("messages").innerHTML += msg;
    }
  });

  document.getElementById("msgInput").oninput = () => {
    db.ref(`typing/${user}-${friend}`).set(user);
    setTimeout(() => db.ref(`typing/${user}-${friend}`).set(""), 3000);
  };

  db.ref(`typing/${friend}-${user}`).on("value", snap => {
    document.getElementById("typing").innerText = snap.val() ? `${snap.val()} is typing...` : "";
  });
}

function sendMsg() {
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if (!text || !chat) return;
  db.ref(`messages/${user}-${chat}`).push({
    user, text, timestamp: Date.now()
  });
  input.value = "";
}

// Add friend screen
function openAdd() {
  const name = prompt("Friend's name:");
  if (!name) return;
  const p = prompt("Optional password:");
  db.ref(`chats/${user}/${name}`).set({ password: p || "", name });
  db.ref(`chats/${name}/${user}`).set({ password: p || "", name: user });
  loadChats();
}

// Settings
function openSettings() {
  const newName = prompt("Change your name:");
  if (newName) {
    user = newName;
    localStorage.setItem("user", user);
    alert("Name changed. This won't affect old chat messages.");
  }

  const changePassword = confirm("Change your password?");
  if (changePassword) {
    const newPass = prompt("New password:");
    const applyAll = confirm("Apply to all chats?\n\n‚ö†Ô∏è This will expose your new password to friends.");
    pass = newPass;
    localStorage.setItem("pass", newPass);
    if (applyAll) {
      db.ref("chats/" + user).once("value", snap => {
        const data = snap.val() || {};
        Object.keys(data).forEach(friend => {
          db.ref(`chats/${user}/${friend}/password`).set(newPass);
          db.ref(`messages/${friend}-${user}`).push({
            user: "SYSTEM",
            text: "password_changed_notice",
            timestamp: Date.now()
          });
        });
      });
    }
  }

  const lock = confirm("Enable lock on logout?");
  localStorage.setItem("locked", lock);
}

window.onbeforeunload = () => {
  localStorage.setItem("user", user);
  localStorage.setItem("pass", pass);
};
</script>

</body>
</html>
