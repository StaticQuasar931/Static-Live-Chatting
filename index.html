<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Static Live Chat ‚Äì Final + Fixes</title>
  <!-- Load Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-color:#111; --text-color:#fff; --sidebar-color:#1c1c1c;
      --chat-bg:#222; --bubble-me:#1e90ff; --bubble-them:#444;
      --accent:#1e90ff; --badge:red; --chat-item-bg:#333;
    }
    body.light {
      --bg-color:#f4f4f4; --text-color:#000; --sidebar-color:#ddd;
      --chat-bg:#eee; --bubble-me:#007aff; --bubble-them:#ccc;
      --accent:#007acc; --chat-item-bg:#bbb;
    }
    body.blue {
      --bg-color:#0b1622; --text-color:#f0f8ff; --sidebar-color:#132336;
      --chat-bg:#1e2d40; --bubble-me:#1f65ff; --bubble-them:#41546a;
      --accent:#389fff; --chat-item-bg:#2e3d52;
    }
    body.green {
      --bg-color:#102a10; --text-color:#e8ffe8; --sidebar-color:#224522;
      --chat-bg:#1a331a; --bubble-me:#28a745; --bubble-them:#375a37;
      --accent:#4caf50; --chat-item-bg:#2b442b;
    }
    body.pink {
      --bg-color:#331024; --text-color:#ffe0f0; --sidebar-color:#441533;
      --chat-bg:#551a44; --bubble-me:#ff3377; --bubble-them:#773355;
      --accent:#ff66a2; --chat-item-bg:#442244;
    }
    body.purple {
      --bg-color:#200428; --text-color:#f5e7ff; --sidebar-color:#301438;
      --chat-bg:#3a2048; --bubble-me:#b15cff; --bubble-them:#5c316e;
      --accent:#d277ff; --chat-item-bg:#4a2858;
    }

    body {
      margin:0; font-family:Arial,sans-serif;
      background:var(--bg-color); color:var(--text-color);
      height:100vh; display:flex; flex-direction:column; overflow:hidden;
    }
    input, button {
      padding:10px; font-size:16px; margin:5px; border-radius:6px; border:none;
    }
    button { background:var(--accent); color:#fff; cursor:pointer; }

    #app { display:flex; flex:1; height:100%; }
    #sidebar {
      width:280px; background:var(--sidebar-color);
      display:flex; flex-direction:column; padding:10px; overflow-y:auto;
    }
    #chatPanel {
      flex:1; display:flex; flex-direction:column; background:var(--chat-bg);
      position:relative;
    }
    #topBar {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; font-size:18px; background:var(--chat-bg);
    }
    #messages {
      flex:1; display:flex; flex-direction:column; padding:15px; overflow-y:auto;
    }
    .msg {
      max-width:70%; padding:12px 16px; margin:6px auto;
      border-radius:20px; font-size:17px; line-height:1.4; word-wrap:break-word;
      position:relative; cursor:pointer;
    }
    .me {
      align-self:flex-end; background:var(--bubble-me); color:#fff; margin-left:auto;
      border-bottom-right-radius:5px;
    }
    .them {
      align-self:flex-start; background:var(--bubble-them); color:#fff; margin-right:auto;
      border-bottom-left-radius:5px;
    }
    .centerSys {
      align-self:center; background:rgba(255,255,255,0.2);
      font-style:italic; text-align:center; width:auto; margin-left:auto; margin-right:auto;
    }
    .reactionTag {
      font-size:14px; opacity:0.8; position:absolute; top:5px; right:10px;
    }
    .reactionBar {
      position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
      display:none; flex-direction:row; gap:5px; background:rgba(0,0,0,0.6);
      padding:5px; border-radius:6px; margin-bottom:5px;
    }
    .reactionBar span { font-size:22px; cursor:pointer; }
    .timestamp {
      position:absolute; font-size:10px; opacity:0.7; bottom:-14px;
    }
    .mineTime { right:10px; }
    .otherTime { left:10px; }
    .readReceipt {
      font-size:12px; opacity:0.6; margin-top:2px;
    }
    #typingIndicator {
      display:none; font-style:italic; font-size:14px; margin:0 20px 10px;
    }
    #inputArea {
      display:flex; padding:10px; background:var(--sidebar-color);
    }
    #inputArea input { flex:1; margin-right:5px; font-size:17px; }
    #emojiPicker {
      display:none; position:absolute; bottom:70px; right:15px; background:var(--chat-bg);
      padding:10px; flex-wrap:wrap; z-index:99; max-width:340px; max-height:180px; overflow:auto;
    }
    #emojiPicker span { font-size:22px; margin:6px; cursor:pointer; }
    .chatItem {
      background:var(--chat-item-bg); padding:10px; border-radius:6px; margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:center;
      cursor:pointer; transition:background 0.2s;
    }
    .chatItem:hover { background:var(--bubble-them); }
    .chatItem.active { outline:2px solid var(--accent); }
    .chatBadge {
      background:var(--badge); color:#fff; font-size:12px; padding:3px 8px; border-radius:12px; margin-left:5px;
    }
    .requestItem {
      background:var(--bubble-them); padding:10px; margin-bottom:5px; border-radius:6px;
    }
    #staticMenu {
      position:fixed; bottom:10px; left:10px; background:#1e1e1e; color:#fff; padding:5px 8px;
      border-radius:8px; font-size:13px; box-shadow:0 0 6px #0ff; animation:blink 2s infinite; z-index:1000;
    }
    a.staticLink { color:#0ff; text-decoration:none; }
    @keyframes blink {
      0%,100% { opacity:1; }
      50% { opacity:0.6; }
    }
    .modal {
      position:fixed; inset:0; background:rgba(0,0,0,0.7);
      display:none; flex-direction:column; align-items:center; justify-content:center; z-index:999;
    }
    .modalContent {
      background:var(--chat-bg); padding:20px; border-radius:10px; max-width:400px; position:relative;
    }
    .closeBtn {
      position:absolute; top:10px; right:10px; background:red; color:#fff; border:none; cursor:pointer;
      border-radius:4px; padding:3px 8px;
    }
    #login {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.7); z-index:999;
    }
    #slashAutocomplete {
      display:none; position:absolute; background:var(--chat-bg);
      border-radius:6px; padding:5px; max-width:220px; z-index:9999;
    }
    #slashAutocomplete button {
      width:100%; display:block; text-align:left; margin:5px 0; padding:6px; border-radius:4px; border:none;
      background:var(--accent); cursor:pointer;
    }
    #loadMoreBtn {
      display:none; position:absolute; top:15px; left:50%; transform:translateX(-50%);
      background:var(--accent); color:#fff; border:none; border-radius:6px;
      padding:5px; cursor:pointer; opacity:0.8; z-index:10;
    }
  </style>
</head>
<body>
<script>
// =========== Basic beep for new messages when tab is hidden and notifications are blocked
let beepAudio=new Audio("");
beepAudio.src="data:audio/wav;base64,UklGRiwAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=";
// The above is a minimal blank wave file. If you want real beep, you‚Äôd store a real base64 wave.

function beep(){
  // If the user has not interacted, the beep might be blocked. We'll attempt anyway:
  beepAudio.play().catch(e=>console.log("Sound might be blocked:",e));
}

// =========== Title +n for missed
function updateTitle(){
  let total=Object.values(chatUnread).reduce((a,b)=>a+b,0);
  if(total>0) document.title=`(${total}) Static Live Chat`;
  else document.title="Static Live Chat";
}

// =========== Attempt to avoid re-subscribing watchers on same chat
let currentChat="", currentType="";
let watchersActiveFor="";
let beepOnHidden=true;
document.addEventListener("visibilitychange",()=>{
  beepOnHidden=!document.hidden;
});

// =========== Firebase init or fallback
if(typeof firebase==="undefined"){
  console.log("Firebase not loaded or blocked!");
  window.firebase={ initializeApp:()=>{}, database:()=>({ref:()=>({})}) };
}
let db=null;
try{
  const config={
    apiKey:"AIzaSyBO7EHU4-_b2NHf7UFYTB8Wolv73Z0P8Fw",
    authDomain:"static-live-chatting.firebaseapp.com",
    databaseURL:"https://static-live-chatting-default-rtdb.firebaseio.com",
    projectId:"static-live-chatting",
    storageBucket:"static-live-chatting.appspot.com",
    messagingSenderId:"578562140653",
    appId:"1:578562140653:web:c12df07155627083e9dfe4"
  };
  firebase.initializeApp(config);
  db=firebase.database();
}catch(e){
  db={ref:()=>({once:()=>{},on:()=>{},set:()=>{},push:()=>({})})};
  console.log("Could not init firebase DB: ",e);
}

// =========== Device ID + DisplayName
function genId(){return "dev_"+Math.random().toString(36).slice(2)+"_"+Date.now();}
let myId=localStorage.getItem("myDeviceId");
if(!myId){
  myId=genId();
  localStorage.setItem("myDeviceId",myId);
}
let displayName=localStorage.getItem("displayName")||"";
let pass=localStorage.getItem("pass")||"";

// =========== On DOM load
window.addEventListener("DOMContentLoaded",()=>{
  if(displayName){
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="flex";
    applyTheme();
    loadBlocked(); loadFriends(); loadRequests();
    initChatWatchers();
    setupHelpChat();
    updateTitle();
  }
});

// =========== Toggle password
function toggleLoginPass(){
  let pw=document.getElementById("password");
  pw.type=(pw.type==="password")?"text":"password";
}

// =========== doLogin
function doLogin(){
  let nm=document.getElementById("username").value.trim();
  let p=document.getElementById("password").value.trim();
  if(!nm){ showNotice("Name can't be empty!"); return;}
  db.ref("displayNames/"+nm).once("value",(snap)=>{
    let val=snap.val();
    if(val && val!==myId){
      showNotice("That name is used by another device. Try another name.");
      return;
    }
    displayName=nm; pass=p;
    localStorage.setItem("displayName",nm);
    localStorage.setItem("pass",p);
    db.ref("displayNames/"+nm).set(myId);
    db.ref(`users/${myId}/displayName`).set(nm);
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="flex";
    applyTheme(); loadBlocked(); loadFriends(); loadRequests();
    initChatWatchers(); setupHelpChat();
    showNotice(`Logged in as ${nm}`);
    updateTitle();
  });
}

// =========== Theming
function applyTheme(){
  let saved=localStorage.getItem("theme")||"dark";
  document.body.classList.remove("light","blue","green","pink","purple");
  if(["light","blue","green","pink","purple"].includes(saved)){
    document.body.classList.add(saved);
  }
  setThemeLabel(saved);
}
function toggleTheme(){
  let c= (document.body.classList.contains("light")?"light":
          document.body.classList.contains("blue")?"blue":
          document.body.classList.contains("green")?"green":
          document.body.classList.contains("pink")?"pink":
          document.body.classList.contains("purple")?"purple":"dark");
  let next="dark";
  if(c==="dark") next="light";
  else if(c==="light") next="blue";
  else if(c==="blue") next="green";
  else if(c==="green") next="pink";
  else if(c==="pink") next="purple";
  else if(c==="purple") next="dark";
  document.body.classList.remove("light","blue","green","pink","purple");
  if(next!=="dark") document.body.classList.add(next);
  localStorage.setItem("theme", next);
  setThemeLabel(next);
}
function setThemeLabel(t){
  document.getElementById("themeBtn").textContent=`${t}: Theme`;
}

// =========== Confirm + Notice
function showConfirm(msg, yesCb){
  let mo=document.createElement("div");
  mo.style.position="fixed"; mo.style.inset=0; mo.style.background="rgba(0,0,0,0.7)";
  mo.style.display="flex"; mo.style.justifyContent="center"; mo.style.alignItems="center"; mo.style.zIndex=999;
  mo.innerHTML=`
    <div style="background:var(--chat-bg);padding:20px;border-radius:10px;max-width:400px;position:relative;">
      <h3>Confirm</h3>
      <p>${msg}</p>
      <div style="text-align:center;">
        <button style="background:green;" id="yBtn">Yes</button>
        <button style="background:red;" id="nBtn">No</button>
      </div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.querySelector("#yBtn").onclick=()=>{
    document.body.removeChild(mo);
    yesCb();
  };
  mo.querySelector("#nBtn").onclick=()=> document.body.removeChild(mo);
}
function showNotice(msg){
  let mo=document.createElement("div");
  mo.style.position="fixed"; mo.style.inset=0; mo.style.background="rgba(0,0,0,0.7)";
  mo.style.display="flex"; mo.style.justifyContent="center"; mo.style.alignItems="center"; mo.style.zIndex=999;
  mo.innerHTML=`
    <div style="background:var(--chat-bg);padding:20px;border-radius:10px;max-width:400px;position:relative;">
      <h3>Notice</h3>
      <p>${msg}</p>
      <div style="text-align:center;">
        <button style="background:var(--accent);" id="okBtn">OK</button>
      </div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.querySelector("#okBtn").onclick=()=>{
    document.body.removeChild(mo);
  };
}

// =========== ‚ÄúHelp‚Äù chat pinned
function setupHelpChat(){
  db.ref(`users/${myId}/chats/help_chat`).set({
    name:"Help (info)",type:"help",last:0
  });
}
function openHelpChat(){
  if(currentChat==="help_chat")return; // avoid watchers reattach
  currentChat="help_chat"; currentType="help"; watchersActiveFor="help_chat";
  highlightChat("help_chat");
  document.getElementById("chatTitle").textContent="Help & Info";
  let msgA=document.getElementById("messages");
  msgA.innerHTML="";
  let bigM=document.createElement("div");
  bigM.className="msg centerSys";
  bigM.innerHTML=`
    <strong>HELP & INFO</strong><br/>
    - slash commands: /tod truth, /tod dare, /title, /cf heads, /coin flip tails, /rps rock, etc<br/>
    - friend requests by displayName<br/>
    - group creation or join + open groups listing<br/>
    - double click msg => reaction<br/>
    - right click msg (if owner in group) => remove<br/>
    - beep if new msg arrives while tab hidden & notifications blocked
  `;
  msgA.appendChild(bigM);
  document.getElementById("groupMembers").style.display="none";
  document.getElementById("msgInput").disabled=true;
  document.getElementById("loadMoreBtn").style.display="none";
}

// =========== watchers for user
let blocked={}, friends={};
function loadBlocked(){
  db.ref(`users/${myId}/blocked`).on("value",(snap)=>{
    blocked=snap.val()||{};
  });
}
function loadFriends(){
  db.ref(`users/${myId}/friends`).on("value",(snap)=>{
    friends=snap.val()||{};
  });
}
function initChatWatchers(){
  db.ref(`users/${myId}/chats`).on("value",(snap)=>{
    let data=snap.val()||{};
    attachAllChatWatchers(data);
    updateChatListUI(data);
    updateTitle();
  });
}
let chatUnread={};

//** watchers for new msgs => unread
function attachAllChatWatchers(chats){
  Object.keys(chats).forEach(chatId=>{
    if(chatId==="help_chat") return;
    let info=chats[chatId];
    let path=(info.type==="group"?"groupChats":"privateChats")+"/"+chatId+"/messages";
    db.ref(path).off("child_added", handleNewMsg);
    db.ref(path).on("child_added", handleNewMsg);
    function handleNewMsg(snap){
      // if we are in that chat => no increment
      if(chatId===currentChat){
        // mark it read immediately
        let msg=snap.val();
        markMessageRead(chatId,snap.key,msg);
        return;
      }
      chatUnread[chatId]=(chatUnread[chatId]||0)+1;
      updateTitle();
      // beep if tab hidden
      if(document.hidden && beepOnHidden) beep();
    }
  });
}

function highlightChat(cId){
  // we can do a simple approach
}

//** update chat list
function updateChatListUI(chats){
  let arr=Object.entries(chats||{}).sort((a,b)=>{
    if(a[0]==="help_chat") return 1;
    if(b[0]==="help_chat") return -1;
    return (b[1].last||0)-(a[1].last||0);
  });
  let cl=document.getElementById("chatList");
  cl.innerHTML="";
  arr.forEach(([cid,info])=>{
    let dv=document.createElement("div");
    dv.className="chatItem";
    if(cid===currentChat) dv.classList.add("active");
    let nm=info.name||cid;
    if(info.type==="private" && blocked[nm]) nm+=" [Blocked]";
    if(info.type==="help") nm="Help (info)";
    dv.textContent=nm;
    let rowR=document.createElement("div");
    rowR.style.display="flex"; rowR.style.alignItems="center";
    if(chatUnread[cid]){
      let bd=document.createElement("span");
      bd.className="chatBadge";
      bd.textContent="+"+chatUnread[cid];
      rowR.appendChild(bd);
    }
    if(info.type!=="help"){
      let delBtn=document.createElement("button");
      delBtn.textContent="üóë";
      delBtn.onclick=(ev)=>{
        ev.stopPropagation();
        confirmDeleteChat(cid,info);
      };
      rowR.appendChild(delBtn);
    }
    dv.appendChild(rowR);
    dv.onclick=()=>{
      if(cid===currentChat) return; // fix bug with re-click same chat => re watchers
      if(info.type==="help") openHelpChat();
      else openChat(cid,nm,info.type);
    };
    cl.appendChild(dv);
  });
}

//** open chat
let messagesRef=null; let childAddedRef=null; let childChangedRef=null;
let watchersActiveFor="";
let oldestStamp=Number.MAX_SAFE_INTEGER;
let hasMoreOld=false;

function openChat(cId, name, cType){
  // reset watchers if we switch chat
  currentChat=cId; currentType=cType;
  watchersActiveFor=cId;
  chatUnread[cId]=0; updateTitle();
  highlightChat(cId);
  document.getElementById("chatTitle").textContent=name;
  let gm=document.getElementById("groupMembers");
  gm.style.display=(cType==="group")?"block":"none";
  let inp=document.getElementById("msgInput");
  inp.disabled=(cType==="help");
  let msgA=document.getElementById("messages");
  msgA.innerHTML="";
  document.getElementById("loadMoreBtn").style.display="none";

  if(messagesRef){
    if(childAddedRef) messagesRef.off("child_added",childAddedRef);
    if(childChangedRef) messagesRef.off("child_changed",childChangedRef);
  }
  let path=(cType==="group"?"groupChats":"privateChats")+"/"+cId+"/messages";
  messagesRef=db.ref(path);
  messagesRef.orderByChild("timestamp").limitToLast(50).once("value",(snap)=>{
    let data=snap.val()||{};
    let arr=Object.entries(data).sort((a,b)=>(a[1].timestamp||0)-(b[1].timestamp||0));
    if(arr.length>0) oldestStamp=arr[0][1].timestamp;
    else oldestStamp=Number.MAX_SAFE_INTEGER;
    arr.forEach(([mId,mVal])=> createBubble(cId,mId,mVal,true));
    if(arr.length>=50){
      hasMoreOld=true;
      document.getElementById("loadMoreBtn").style.display="block";
    } else hasMoreOld=false;
    attachChatListeners();
    msgA.scrollTop=msgA.scrollHeight;
    db.ref(`users/${myId}/chats/${cId}/last`).set(Date.now());
    // mark older read
    arr.forEach(([mId,mVal])=> markMessageRead(cId,mId,mVal));
  });

  if(cType==="group"){
    let gRef=db.ref(`groupChats/${cId}`);
    gRef.on("value",(snap)=>{
      let g=snap.val()||{};
      let mm=Object.keys(g.members||{});
      let out=mm.map(mdid=>{
        // highlight if mdid===owner
        let isOwner=(mdid===g.createdBy);
        // need deviceID => displayName map
        return `[${deviceIDtoName(mdid)}${isOwner?"*":""}]`;
      });
      gm.textContent="Members: "+out.join(", ");
    });
    // for "Edit Group Chat" if user===owner
    if(cId!=="help_chat"){
      // we can add a small button in topBar or groupMembers area
      // if user===g.createdBy => show "Edit Group" button
    }
  }
}

//** attach chat watchers
function attachChatListeners(){
  childAddedRef=messagesRef.orderByChild("timestamp").startAt(Date.now()).on("child_added",(snap)=>{
    if(currentChat!==watchersActiveFor) return; // if user has switched
    let val=snap.val();
    createBubble(currentChat,snap.key,val,true);
    document.getElementById("messages").scrollTop=document.getElementById("messages").scrollHeight;
    markMessageRead(currentChat,snap.key,val);
    if(document.hidden && beepOnHidden) beep();
  });
  childChangedRef=messagesRef.on("child_changed",(snap)=>{
    if(currentChat!==watchersActiveFor) return;
    let val=snap.val();
    updateBubble(snap.key,val);
  });
}

function createBubble(chatId,mId,val,toEnd){
  if(!val) return;
  let area=document.getElementById("messages");
  if(document.getElementById("msg_"+mId))return;
  let bub=document.createElement("div");
  bub.id="msg_"+mId;
  bub.className="msg";
  // if the device ID is found, we map to displayName in group chats
  // if val.sender===myId => "me"
  // else if val.sender==="_system" => center
  // else => "them"
  if(val.sender===myId) bub.classList.add("me");
  else if(val.sender==="_system") bub.classList.add("centerSys");
  else bub.classList.add("them");

  // "In group chats make it say the name, not the user id." => we do deviceID -> displayName
  let effectiveName=val.sender;
  if(val.sender!==myId && val.sender!=="_system"){
    effectiveName=deviceIDtoName(val.sender);
  }
  let text=val.text||"";
  // if slash command
  // we do "Coinflip: user" "Truth: <stuff>" etc
  if(val.sender==="_system"){
    // text is already system
    bub.innerHTML=text;
  } else if(currentType==="group" && val.sender!==myId && val.sender!=="_system"){
    bub.innerHTML=`<span style="font-weight:bold">${effectiveName}:</span> ${text}`;
  } else {
    bub.innerHTML=text;
  }

  // reaction
  let rt=document.createElement("span");
  rt.className="reactionTag";
  if(val.reaction) rt.textContent=val.reaction;
  bub.appendChild(rt);

  let rBar=document.createElement("div");
  rBar.className="reactionBar";
  ["‚ù§Ô∏è","üëç","üòÇ","üòÆ","üò¢"].forEach(r=>{
    let sp=document.createElement("span");
    sp.textContent=r;
    sp.onclick=(ev)=>{
      ev.stopPropagation();
      applyReaction(mId,r);
      rBar.style.display="none";
    };
    rBar.appendChild(sp);
  });
  bub.appendChild(rBar);

  bub.addEventListener("dblclick",(ev)=>{
    if(currentType==="help") return;
    rBar.style.display=(rBar.style.display==="flex")?"none":"flex";
  });
  bub.addEventListener("contextmenu",(ev)=>{
    ev.preventDefault();
    if(currentType==="group"){
      db.ref(`groupChats/${currentChat}/createdBy`).once("value",(snap)=>{
        if(snap.val()===myId){
          showConfirm("Remove this message?",()=>{
            db.ref(`groupChats/${currentChat}/messages/${mId}`).remove();
            let ex=document.getElementById("msg_"+mId);
            if(ex) ex.remove();
          });
        }
      });
    }
  });

  let ts=document.createElement("div");
  ts.className="timestamp";
  let t=val.timestamp? new Date(val.timestamp).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}): "";
  ts.textContent=t;
  bub.appendChild(ts);
  if(val.sender===myId) ts.classList.add("mineTime");
  else if(val.sender==="_system"){}
  else ts.classList.add("otherTime");

  if(toEnd) area.appendChild(bub);
  else area.prepend(bub);
  area.scrollTop=area.scrollHeight;
}
function updateBubble(mId,val){
  let b=document.getElementById("msg_"+mId);
  if(!b)return;
  let rt=b.querySelector(".reactionTag");
  if(rt) rt.textContent=val.reaction||"";
}

//** read receipts
function markMessageRead(chatId,mId,val){
  if(!val) return;
  let p=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${p}/${chatId}/messages/${mId}/readBy/${myId}`).set(Date.now());
  chatUnread[chatId]=0;
  updateTitle();
}

//** load older
function loadOlderMessages(){
  if(!currentChat||currentChat==="help_chat"||!hasMoreOld) return;
  document.getElementById("loadMoreBtn").disabled=true;
  let p=(currentType==="group"?"groupChats":"privateChats")+"/"+currentChat+"/messages";
  messagesRef.orderByChild("timestamp").endAt(oldestStamp-1).limitToLast(50).once("value",(snap)=>{
    let data=snap.val()||{};
    let arr=Object.entries(data).sort((a,b)=>(a[1].timestamp||0)-(b[1].timestamp||0));
    if(!arr.length){
      showNotice("No older messages found!");
      hasMoreOld=false;
      document.getElementById("loadMoreBtn").style.display="none";
      return;
    }
    oldestStamp=arr[0][1].timestamp;
    arr.forEach(([mId,mVal])=> createBubble(currentChat,mId,mVal,false));
    if(arr.length<50){
      hasMoreOld=false;
      document.getElementById("loadMoreBtn").style.display="none";
    }
    // read them
    arr.forEach(([mId,mVal])=> markMessageRead(currentChat,mId,mVal));
    document.getElementById("loadMoreBtn").disabled=false;
  });
}

//** slash commands
function processSlashCommand(cmd){
  let parts=cmd.split(" ");
  let slash=parts[0];
  if(slash==="/tod"){
    if(parts[1]==="truth"){
      let t= nextTruth();
      sendSystemMessage(`Truth: ${t}`);
    } else if(parts[1]==="dare"){
      let d= nextDare();
      sendSystemMessage(`Dare: ${d}`);
    } else showNotice("Usage: /tod truth or /tod dare");
  } else if(slash==="/title"){
    let text=parts.slice(1).join(" ");
    if(!text){showNotice("Usage: /title Something");return;}
    sendSystemMessage(`Title: << ${text} >>`);
  } else if(slash==="/cf"|| slash==="/coin"){
    let guess="";
    if(slash==="/cf") guess=parts[1]||"";
    else if(slash==="/coin"&&parts[1]==="flip") guess=parts[2]||"";
    guess=guess.toLowerCase();
    if(guess!=="heads"&&guess!=="tails"){
      showNotice("Usage: /cf heads/tails or /coin flip heads/tails");
      return;
    }
    let side=Math.random()<0.5? "heads":"tails";
    let result=(side===guess)? `Coinflip: ${displayName} (${guess}) wins!` : `Coinflip: ${displayName} (${guess}) loses, ${side} wins!`;
    sendSystemMessage(result);
  } else if(slash==="/rps"){
    // /rps rock|paper|scissors
    let userChoice=parts[1]||"";
    userChoice=userChoice.toLowerCase();
    if(!["rock","paper","scissors"].includes(userChoice)){
      showNotice("Usage: /rps rock|paper|scissors");
      return;
    }
    let opts=["rock","paper","scissors"];
    let comp=opts[Math.floor(Math.random()*opts.length)];
    let out="";
    if(userChoice===comp) out="Tie!";
    else if((userChoice==="rock"&&comp==="scissors")||
            (userChoice==="paper"&&comp==="rock")||
            (userChoice==="scissors"&&comp==="paper")){
      out=`${displayName} wins! (${userChoice} vs ${comp})`;
    } else out=`${displayName} loses! (${userChoice} vs ${comp})`;
    sendSystemMessage("RPS: "+out);
  } else showNotice(`Unknown command: ${cmd}`);
}

//** adding the T/D queue
let bigTruths=["What's your biggest fear?","Ever skip class?","Weirdest dream?"];
let bigDares=["Dance for 10s","Pretend to meow 3 times"];
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ let j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
shuffle(bigTruths); shuffle(bigDares);
function nextTruth(){ let x=bigTruths.shift(); bigTruths.push(x); return x; }
function nextDare(){ let x=bigDares.shift(); bigDares.push(x); return x; }
function sendSystemMessage(txt){
  if(!currentChat||currentType==="help")return;
  let p=(currentType==="group"?"groupChats":"privateChats")+"/"+currentChat+"/messages";
  db.ref(p).push({sender:"_system", text:txt, timestamp:Date.now(), reaction:"", readBy:{}});
}

//** Toggling emoji
function toggleEmojiPicker(){
  let ep=document.getElementById("emojiPicker");
  if(ep.style.display==="flex"){
    ep.style.display="none";
    return;
  }
  ep.innerHTML="";
  ep.style.display="flex";
  let big=[... "üòÄüòÉüòÑüòÅüòÜüòÖüòÇü§£üòäüòáüôÇüôÉüòâüòåüòçüòòü•∞üòóüòôüòöüòãüòõüòùüòúü§™ü§®üßêü§ìüòéü•∏ü§©ü•≥üòèüòíüòûüòîüòüüòïüôÅ‚òπÔ∏èüò£üòñüò´üò©ü•∫üò¢üò≠üò§üò†üò°ü§¨ü§Øüò≥ü•µü•∂üò±üò®üò∞üò•üòìü§óü§îü§≠ü§´ü§•üò∂üòêüòëüôÑüòØüò¶üòßüòÆüò≤ü•±üò¥üò™üòµüòµ‚Äçüí´üò∑ü§íü§ïü§¢ü§Æü§ßüòáüòàüëøüëªüíÄ‚ò†Ô∏èüëΩü§ñüéÉüò∫üò∏üòπüòªüòºüòΩüôÄüòøüòæ"];
  big.forEach(em=>{
    let s=document.createElement("span");
    s.textContent=em;
    s.onclick=()=>{
      let inp=document.getElementById("msgInput");
      inp.value+=em;
      ep.style.display="none";
    };
    ep.appendChild(s);
  });
}

//** presence for typing
function sendTyping(){
  if(!currentChat||currentType==="help") return;
  let p=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${p}/${currentChat}/typing`).set(myId);
  setTimeout(()=> db.ref(`${p}/${currentChat}/typing`).set(""),2000);
}
function attachTypingListener(){}
function deviceIDtoName(devId){
  // We'll store an in-memory map devId->displayName
  // We can do a quick fetch from /users/{devId}/displayName if not cached
  if(!displayNameCache[devId]){
    db.ref(`users/${devId}/displayName`).once("value",(snap)=>{
      let val=snap.val()||devId; // fallback
      displayNameCache[devId]=val;
    });
    return devId; // fallback until loaded
  }
  return displayNameCache[devId];
}
let displayNameCache={};

//** add friend
function addFriendUI(){
  // same code
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:300px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Add Friend by Name</h3>
      <input id="friendNameInput" placeholder="Friend's DisplayName"/><br/>
      <button id="friendSendBtn">Send Request</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{
    if(ev.target===mo) document.body.removeChild(mo);
  });
  mo.querySelector("#friendSendBtn").onclick=()=>{
    let n=mo.querySelector("#friendNameInput").value.trim();
    if(!n){ showNotice("No name typed!"); return; }
    if(n===displayName){ showNotice("Can't friend yourself!"); return; }
    if(blocked[n]){ showNotice("You blocked them. Unblock first!"); return; }
    db.ref("displayNames/"+n).once("value",(sn)=>{
      let dev=sn.val();
      if(!dev){ showNotice(`No user named ${n} found!`); return; }
      if(friends[n]){ showNotice(`Already friends with ${n}!`); return; }
      db.ref(`users/${myId}/requestsSent/${n}`).once("value",(s2)=>{
        if(s2.exists()){ showNotice("Already pending request with them."); return;}
        db.ref(`users/${dev}/requests/${displayName}`).set({requested:true});
        db.ref(`users/${myId}/requestsSent/${n}`).set(true);
        db.ref(`privateChats/${[myId,dev].sort().join("_")}`).set({});
        showNotice(`Friend request sent to ${n}`);
        document.body.removeChild(mo);
      });
    });
  };
}

//** open friends
function openFriendsPanel(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Your Friends</h3>
      <div id="frList"></div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{ if(ev.target===mo) document.body.removeChild(mo);});
  let fl=mo.querySelector("#frList");
  if(!friends||!Object.keys(friends).length){
    fl.textContent="No friends yet!";
  } else {
    Object.keys(friends).forEach(n=>{
      let d=document.createElement("div");
      d.style.background="var(--chat-bg)"; d.style.padding="8px"; d.style.marginBottom="8px";
      d.style.borderRadius="6px"; d.textContent=`Name: ${n}`;
      fl.appendChild(d);
    });
  }
}

//** group creation
function showAddChatPanel(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Add Chat</h3>
      <button onclick="showCreatePanel();document.body.removeChild(this.closest('.modal'))">Create Group</button><br/>
      <button onclick="showJoinPanel();document.body.removeChild(this.closest('.modal'))">Join Group</button><br/>
      <button onclick="showPublicDirectory();document.body.removeChild(this.closest('.modal'))">Open Groups</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{ if(ev.target===mo) document.body.removeChild(mo);});
}
function showCreatePanel(){/* same approach omitted for brevity */}
function showJoinPanel(){/* same */}
function showPublicDirectory(){/* same */}
function confirmDeleteChat(chatId, info){/* same code with "owner" highlight etc. */}

//** Settings with logout
function openSettings(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:320px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Settings</h3>
      <label>Display Name:</label><br/>
      <input id="editName" value="${displayName}"/><br/>
      <label>Password (friend requests):</label><br/>
      <input id="editPass" value="${pass}"/><br/>
      <button id="saveSetBtn">Save</button>
      <hr/>
      <button id="logoutBtn" style="background:darkred;">Log Out</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{ if(ev.target===mo) document.body.removeChild(mo);});
  mo.querySelector("#saveSetBtn").onclick=()=>{
    let newN=mo.querySelector("#editName").value.trim();
    let newP=mo.querySelector("#editPass").value.trim();
    if(!newN){ showNotice("Name can't be empty!");return;}
    db.ref("displayNames/"+newN).once("value",(snap)=>{
      let val=snap.val();
      if(val && val!==myId){
        showNotice("That name is used by another device. Try another name.");
        return;
      }
      displayName=newN; pass=newP;
      localStorage.setItem("displayName",newN);
      localStorage.setItem("pass",newP);
      db.ref("displayNames/"+newN).set(myId);
      db.ref(`users/${myId}/displayName`).set(newN);
      showNotice("Settings saved!");
      document.body.removeChild(mo);
    });
  };
  mo.querySelector("#logoutBtn").onclick=()=>{
    showConfirm("Are you sure to log out?",()=>{
      localStorage.removeItem("myDeviceId");
      localStorage.removeItem("displayName");
      localStorage.removeItem("pass");
      location.reload();
    });
  };
}

console.log("All code loaded ‚Äì addresses new requests: user-labeled coinflip, better group name, beep on hidden, no re-click watchers, purple theme, etc.");
</script>

<!-- LOGIN UI -->
<div id="login" style="display:flex;">
  <div style="background:var(--chat-bg);padding:20px;border-radius:10px;position:relative;">
    <h2>Static Live Chat</h2>
    <label>Display Name (unique):</label><br/>
    <input id="username" placeholder="Name" onkeypress="if(event.key==='Enter')doLogin()"/><br/>
    <label>Password (optional, friend requests):</label><br/>
    <div style="display:flex;">
      <input id="password" type="password" style="flex:1;" onkeypress="if(event.key==='Enter')doLogin()"/>
      <button onclick="toggleLoginPass()">üëÅÔ∏è</button>
    </div>
    <button onclick="doLogin()">Log In</button>
  </div>
</div>

<!-- MAIN APP UI -->
<div id="app" style="display:none;">
  <div id="sidebar">
    <button onclick="openFriendsPanel()">Friends</button>
    <button onclick="addFriendUI()">Add Friend</button>
    <button onclick="showAddChatPanel()">Add Chat</button>
    <h3>Friend Requests</h3>
    <div id="requestsTab"></div>
    <div id="requestsSentTab" style="margin-top:8px;color:#ccc;"></div>
    <hr/>
    <h3>Chats</h3>
    <div id="chatList"></div>
  </div>
  <div id="chatPanel">
    <div id="topBar">
      <div id="chatTitle">No Chat</div>
      <div>
        <button id="themeBtn" onclick="toggleTheme()">Dark: Theme</button>
        <button onclick="openSettings()">‚öôÔ∏è Settings</button>
      </div>
    </div>
    <div id="groupMembers" style="padding:5px 15px; display:none; font-size:14px;"></div>
    <button id="loadMoreBtn" style="display:none;" onclick="loadOlderMessages()">Load Older</button>
    <div id="messages"></div>
    <div id="typingIndicator" style="display:none;"></div>
    <div id="inputArea">
      <input id="msgInput" placeholder="Type '/' for commands" oninput="slashAutoInput(event)" onkeypress="if(event.key==='Enter')sendMessage();"/>
      <button onclick="toggleEmojiPicker()">üòÄ</button>
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="emojiPicker"></div>
    <div id="slashAutocomplete"></div>
  </div>
</div>

<div id="staticMenu">
  <a href="https://sites.google.com/view/staticquasar931" target="_blank" class="staticLink">More Unblocked Games by Static</a>
</div>

<!-- Example database rules:
{
  "rules": {
    ".read":true,
    ".write":true,
    "users":{
      "$devId":{".read":true,".write":true}
    },
    "privateChats":{
      "$chatId":{".read":true,".write":true}
    },
    "groupChats":{
      "$chatId":{".read":true,".write":true}
    },
    "displayNames":{
      "$name":{".read":true,".write":true}
    }
  }
}
-->
</body>
</html>
