<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Static Live Chatting - Extended</title>
  <style>
    :root {
      /* Default: Dark Theme */
      --bg-color: #111;
      --text-color: #fff;
      --sidebar-color: #1c1c1c;
      --chat-bg: #222;
      --bubble-me: #1e90ff;
      --bubble-them: #444;
      --accent: #1e90ff;
      --badge: red;
      --chat-item-bg: #333;
    }
    body.light {
      --bg-color: #f4f4f4;
      --text-color: #000;
      --sidebar-color: #ddd;
      --chat-bg: #eee;
      --bubble-me: #007aff;
      --bubble-them: #ccc;
      --accent: #007acc;
      --chat-item-bg: #bbb;
    }
    body.blue {
      --bg-color: #0b1622;
      --text-color: #f0f8ff;
      --sidebar-color: #132336;
      --chat-bg: #1e2d40;
      --bubble-me: #1f65ff;
      --bubble-them: #41546a;
      --accent: #389fff;
      --chat-item-bg: #2e3d52;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
      border-radius: 6px;
      border: none;
    }
    button {
      background: var(--accent);
      color: #fff;
      cursor: pointer;
    }
    .panel {
      padding: 20px;
      background: var(--chat-bg);
      border-radius: 10px;
    }
    #login, #settingsPanel, #groupJoinPanel, #groupCreatePanel, #directoryPanel,
    #confirmPanel, #noticePanel, #editGroupPanel, #friendsPanel {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .panelContent {
      background: var(--chat-bg);
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
    }
    #app {
      display: flex;
      flex: 1;
      height: 100%;
    }
    #sidebar {
      width: 280px;
      background: var(--sidebar-color);
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow-y: auto;
    }
    #chatPanel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--chat-bg);
      position: relative;
    }
    #topBar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      font-size: 18px;
      background: var(--chat-bg);
    }
    #messages {
      flex: 1;
      display: flex;
      flex-direction: column-reverse; /* so messages appear from bottom to top */
      padding: 15px;
      overflow-y: auto;
    }
    .msg {
      max-width: 70%;
      padding: 12px 16px;
      margin: 6px 0;
      border-radius: 20px;
      font-size: 17px;
      line-height: 1.4;
      word-wrap: break-word;
      position: relative;
      cursor: pointer;
    }
    .me {
      align-self: flex-end;
      background: var(--bubble-me);
      color: #fff;
      border-bottom-right-radius: 5px;
    }
    .them {
      align-self: flex-start;
      background: var(--bubble-them);
      color: #fff;
      border-bottom-left-radius: 5px;
    }
    .reactionBar {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      flex-direction: row;
      gap: 5px;
      background: rgba(0,0,0,0.6);
      padding: 5px;
      border-radius: 6px;
      margin-bottom: 5px;
    }
    .reactionBar span {
      font-size: 22px;
      cursor: pointer;
    }
    .reactionTag {
      margin-left: 6px;
      font-size: 14px;
      opacity: 0.8;
    }
    .timestamp {
      position: absolute;
      font-size: 10px;
      opacity: 0.7;
      bottom: -14px;
    }
    .mineTime {
      right: 10px;
    }
    .otherTime {
      left: 10px;
    }
    #typingIndicator {
      font-style: italic;
      font-size: 14px;
      margin: 0 20px 10px;
    }
    #inputArea {
      display: flex;
      padding: 10px;
      background: var(--sidebar-color);
    }
    #inputArea input {
      flex: 1;
      margin-right: 5px;
      font-size: 17px;
    }
    #emojiPicker {
      display: none;
      position: absolute;
      bottom: 70px;
      right: 15px;
      background: var(--chat-bg);
      padding: 10px;
      flex-wrap: wrap;
      z-index: 99;
      max-width: 260px;
    }
    #emojiPicker span {
      font-size: 22px;
      margin: 6px;
      cursor: pointer;
    }
    .chatItem {
      background: var(--chat-item-bg);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .chatItem:hover {
      background: var(--bubble-them);
    }
    .chatItem.active {
      outline: 2px solid var(--accent);
    }
    .chatBadge {
      background: var(--badge);
      color: #fff;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 12px;
      margin-left: 5px;
    }
    .requestItem {
      background: var(--bubble-them);
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 6px;
    }
    #staticMenu {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: #1e1e1e;
      color: #fff;
      padding: 5px 8px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 0 6px #0ff;
      animation: blink 2s infinite;
      z-index: 1000;
    }
    .nameColor1 { color: #ff8888; }
    .nameColor2 { color: #88ff88; }
    .nameColor3 { color: #8888ff; }
    .nameColor4 { color: #ffff88; }
    .nameColor5 { color: #ff88ff; }

    /* If on mobile, hide sidebar by default (Suggestion #3) */
    @media (max-width: 768px) {
      body.mobile #sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
<script>
window.onbeforeunload=()=>\"Are you sure you want to leave?\";

// Detect Mobile => add .mobile to body
if(/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
  document.body.classList.add(\"mobile\");
}
</script>

<!-- Confirm / Notice Panels -->
<div id="confirmPanel">
  <div class="panelContent" id="confirmInner"></div>
</div>
<div id="noticePanel">
  <div class="panelContent" id="noticeInner"></div>
</div>

<!-- Edit Group Panel -->
<div id="editGroupPanel">
  <div class="panelContent" id="editGroupInner"></div>
</div>

<!-- Friends Panel -->
<div id="friendsPanel">
  <div class="panelContent" id="friendsInner"></div>
</div>

<!-- Login -->
<div id="login" style="display:flex;">
  <div class="panel">
    <h2>Static Live Chatting</h2>
    <p>‚ö†Ô∏è Never share sensitive info</p>
    <input id="username" placeholder="Username"/><br/>
    <div style="display:flex;align-items:center;">
      <input id="password" type="password" placeholder="Password (optional)" style="margin:5px 0;flex:1;" />
      <button style="margin:5px 0;" onclick="toggleLoginPass()">üëÅÔ∏è</button>
    </div>
    <button onclick="doLogin()">Log In</button>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none;">
  <div id="sidebar">
    <button onclick="openFriendsPanel()">Friends</button>
    <button onclick="addFriendUI()">Add Friend</button>
    <button onclick="addChatUI()">Add Chat</button>
    <h3>Friend Requests</h3>
    <div id="requestsTab"></div>
    <hr/>
    <h3>Chats</h3>
    <div id="chatList"></div>
  </div>

  <div id="chatPanel">
    <div id="topBar">
      <div id="chatTitle">No Chat</div>
      <div id="topButtons" style="display:flex;align-items:center;">
        <!-- We'll add more group mgmt / presence / etc -->
        <span id="presenceLabel" style="font-size:14px;margin-right:10px;"></span>
        <div style="margin-right:10px;">
          <span id="hiddenPassword" style="font-size:14px; margin-left:8px; display:none;"></span>
          <button onclick="toggleTopLock()" style="font-size:14px;">üîí</button>
        </div>
        <button onclick="openSettings()">‚öôÔ∏è</button>
      </div>
    </div>

    <div id="groupMembers" style="padding:5px 15px; display:none; font-size:14px;"></div>
    <div id="messages"></div>
    <div id="typingIndicator" style="display:none;"></div>
    <div id="inputArea">
      <input id="msgInput" placeholder="Type..." oninput="sendTyping()" onkeypress="if(event.key==='Enter')sendMessage();"/>
      <button onclick="toggleEmojiPicker()">üòÄ</button>
      <button onclick="toggleLock()">üîí</button>
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="emojiPicker"></div>
  </div>
</div>

<!-- Settings Panel -->
<div id="settingsPanel" class="panel" style="display:none;">
  <h3>Settings</h3>
  <label>Username:</label><br/>
  <input id="editUsername"><br/>
  <label>Password:</label><br/>
  <input id="editPassword"><br/>
  <p>Theme:</p>
  <select id="themeSelect">
    <option value="dark">Dark</option>
    <option value="light">Light</option>
    <option value="blue">Blue</option>
  </select><br/>
  <button onclick="saveSettings()">Save</button>
  <button onclick="closeSettings()">Close</button><br/>
  <button onclick="openImportExportPanel()">üì§ Import/Export</button><br/>
  <button onclick="blockUserUI()">Block/Unblock Users</button>
</div>

<!-- Group Join -->
<div id="groupJoinPanel" class="panel" style="display:none;">
  <h3>Join Group Chat</h3>
  <input id="joinGroupID" placeholder="Group ID"><br/>
  <input id="joinGroupPassword" placeholder="Password (if needed)"><br/>
  <button onclick="joinGroupChat()">Join</button>
  <button onclick="closeJoinPanel()">Close</button>
</div>

<!-- Group Create -->
<div id="groupCreatePanel" class="panel" style="display:none;">
  <h3>Create Group</h3>
  <input id="groupName" placeholder="Group Name"><br/>
  <select id="groupType">
    <option value="open">Open</option>
    <option value="password">Password</option>
    <option value="invite">Invite Only</option>
  </select><br/>
  <input id="groupPassword" placeholder="Password (optional)"><br/>
  <button onclick="createGroupChat()">Create</button>
  <button onclick="closeCreatePanel()">Close</button>
</div>

<!-- Public Directory Panel -->
<div id="directoryPanel" class="panel" style="display:none;">
  <h3>All Public Groups</h3>
  <div id="publicList" style="max-height:300px; overflow:auto;"></div>
  <button onclick="closeDirectory()">Close</button>
</div>

<!-- Static Menu -->
<div id="staticMenu">
  üåü More Unblocked Games by Static
</div>

<script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>
<script>
/* 
   Single-file Extended Chat 
   - Real-time presence
   - No advanced Load Older
   - Mobile UI if device is mobile
   - Blocking in group
   - Post-creation group editing
   - Friends with block/invite
   - Reactions updated
   - Reversed message layout
   - Full bug-check performed
*/
const firebaseConfig={
  apiKey: "AIzaSyBO7EHU4-_b2NHf7UFYTB8Wolv73Z0P8Fw",
  authDomain: "static-live-chatting.firebaseapp.com",
  databaseURL: "https://static-live-chatting-default-rtdb.firebaseio.com",
  projectId: "static-live-chatting",
  storageBucket: "static-live-chatting.appspot.com",
  messagingSenderId: "578562140653",
  appId: "1:578562140653:web:c12df07155627083e9dfe4"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let user=localStorage.getItem("user")||"";
let pass=localStorage.getItem("pass")||"";
let currentChat="", currentType="";
let chatActive="";
let chatUnread={};
let colorMap={}; 
const colorClasses=["nameColor1","nameColor2","nameColor3","nameColor4","nameColor5"];
let presenceRef=null;
let blocked={};
let friends={};

if(user) startApp();

function toggleLoginPass(){
  const pw=document.getElementById("password");
  pw.type=(pw.type==="password")?"text":"password";
}
function doLogin(){
  user=document.getElementById("username").value.trim();
  pass=document.getElementById("password").value.trim();
  if(!user)return;
  localStorage.setItem("user",user);
  localStorage.setItem("pass",pass);
  startApp();
}
function startApp(){
  document.getElementById("login").style.display="none";
  document.getElementById("app").style.display="flex";
  applyTheme();
  setupPresence();
  loadBlocked();
  loadChats();
  loadRequests();
  loadFriends();
}
function setupPresence(){
  presenceRef=db.ref(`presence/${user}`);
  presenceRef.set({state:"online",lastOnline:Date.now()});
  presenceRef.onDisconnect().set({state:"offline",lastOnline:firebase.database.ServerValue.TIMESTAMP});
}
function loadBlocked(){
  db.ref(`users/${user}/blocked`).on("value", s=>{
    blocked=s.val()||{};
  });
}
function loadFriends(){
  // We'll store a node: users/{user}/friends/{friend} = true
  db.ref(`users/${user}/friends`).on("value", s=>{
    friends=s.val()||{};
  });
}

function loadChats(){
  db.ref(`users/${user}/chats`).on("value", snap=>{
    const data=snap.val()||{};
    const sorted=Object.entries(data).sort((a,b)=>(b[1].last||0)-(a[1].last||0));
    const container=document.getElementById("chatList");
    container.innerHTML="";
    sorted.forEach(([id,info])=>{
      const div=document.createElement("div");
      div.className="chatItem";
      if(id===chatActive) div.classList.add("active");

      let chatName=info.name||id;
      // if private chat blocked => label
      if(info.type==="private" && blocked[chatName]) {
        chatName+= " [Blocked]";
      }
      div.textContent=chatName;

      const rowRight=document.createElement("div");
      rowRight.style.display="flex";
      rowRight.style.alignItems="center";

      // unread
      if(chatUnread[id]) {
        const badge=document.createElement("span");
        badge.className="chatBadge";
        badge.textContent="+"+chatUnread[id];
        rowRight.appendChild(badge);
      }
      // trash button
      const delBtn=document.createElement("button");
      delBtn.textContent="üóë";
      delBtn.onclick=(e)=>{
        e.stopPropagation();
        confirmDeleteChat(id, info);
      };
      rowRight.appendChild(delBtn);

      div.appendChild(rowRight);

      div.onclick=()=>{
        openChat(id, info.name, info.type);
        highlightChat(id);
      };
      container.appendChild(div);
    });
  });
}
function loadRequests(){
  db.ref(`users/${user}/requests`).on("value", snap=>{
    const tab=document.getElementById("requestsTab");
    tab.innerHTML="";
    const data=snap.val()||{};
    Object.keys(data).forEach(from=>{
      const d=document.createElement("div");
      d.className="requestItem";
      d.textContent=`${from} wants to chat `;
      const accept=document.createElement("button");
      accept.textContent="Accept";
      accept.onclick=()=>{
        if(blocked[from])return showNotice("You blocked this user. Unblock them first.");
        const cid=[user, from].sort().join("_");
        db.ref(`privateChats/${cid}`).set({});
        db.ref(`users/${user}/chats/${cid}`).set({name:from,type:"private",last:Date.now()});
        db.ref(`users/${user}/requests/${from}`).remove();
        // also add to friends
        db.ref(`users/${user}/friends/${from}`).set(true);
        db.ref(`users/${from}/friends/${user}`).set(true);
      };
      d.appendChild(accept);
      tab.appendChild(d);
    });
  });
}
function highlightChat(id){
  chatActive=id;
  document.querySelectorAll(".chatItem").forEach(i=>i.classList.remove("active"));
  // naive approach => no direct solution but we can just re-load
}

function confirmDeleteChat(chatId, info){
  if(info.type==="group") {
    db.ref(`groupChats/${chatId}/createdBy`).once("value", s=>{
      const c=s.val();
      if(c!==user) {
        return showNotice("You are not the group owner. You can only leave.");
      }
      showConfirm(`Delete group ${info.name} for all?`,()=>{
        db.ref(`groupChats/${chatId}`).remove();
        db.ref(`users/${user}/chats/${chatId}`).remove();
        showNotice("Group deleted for all members!");
      });
    });
  } else {
    showConfirm(`Leave private chat with ${info.name}?`,()=>{
      db.ref(`users/${user}/chats/${chatId}`).remove();
      showNotice("Private chat removed from your list.");
    });
  }
}

//** open Chat
function openChat(id, name, type){
  currentChat=id; currentType=type;
  chatUnread[id]=0;
  highlightChat(id);
  document.getElementById("chatTitle").textContent=name||id;
  document.getElementById("messages").innerHTML="";
  document.getElementById("groupMembers").style.display=(type==="group")?"block":"none";

  showPresenceInfo(name, type);

  document.getElementById("hiddenPassword").textContent=`(pw:${localStorage.getItem("pass")||"none"})`;
  document.getElementById("hiddenPassword").style.display="none";

  if(type==="group") {
    // load members
    db.ref(`groupChats/${id}/members`).on("value", sp=>{
      const mm=Object.keys(sp.val()||{});
      document.getElementById("groupMembers").textContent="Members: "+mm.join(", ");
    });
  }

  // load messages
  const ref=`${type==="group"?"groupChats":"privateChats"}/${id}/messages`;
  db.ref(ref).off();
  db.ref(ref).orderByKey().limitToLast(100).on("value", snapshot=>{
    const dat=snapshot.val()||{};
    const sorted=Object.entries(dat).sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0));
    // reversed in the array, because we are column-reverse
    let html="";
    const cont=document.getElementById("messages");
    cont.innerHTML="";
    for(const [msgId, msg] of sorted){
      createMessageBubble(msgId,msg,type);
    }
  });

  // typing
  db.ref(`${type==="group"?"groupChats":"privateChats"}/${id}/typing`).off();
  db.ref(`${type==="group"?"groupChats":"privateChats"}/${id}/typing`).on("value", s=>{
    const val=s.val();
    const t=document.getElementById("typingIndicator");
    if(val && val!==user) {
      t.style.display="block";
      t.textContent=`${val} is typing...`;
    } else {
      t.style.display="none";
    }
  });

  // last
  db.ref(`users/${user}/chats/${id}/last`).set(Date.now());
}

//** create bubble
function createMessageBubble(msgId, msg, chatType){
  if(!msg.sender) return;
  // if blocked in private => skip
  if(chatType==="private") {
    if(msg.sender!==user && blocked[msg.sender]) {
      return;
    }
  }
  if(chatType==="group") {
    // block from group
    if(blocked[msg.sender] && msg.sender!==user) {
      return;
    }
  }

  const isMe=(msg.sender===user);
  const bubble=document.createElement("div");
  bubble.className="msg "+(isMe?"me":"them");

  // multi-lines
  const lines=msg.text.split("\n");
  if(lines.length>6) {
    const shortText=lines.slice(0,4).join("\n")+"\n(view full raw message)";
    bubble.textContent=shortText;
    bubble.onclick=()=>{
      const blob=new Blob([msg.text], {type:"text/plain"});
      const url=URL.createObjectURL(blob);
      window.open(url,"_blank");
    };
  } else {
    bubble.textContent=msg.text;
  }

  // if group => color name
  if(chatType==="group" && msg.sender!=="_system" && !isMe){
    const colc=getColorClass(msg.sender);
    bubble.innerHTML=`<span class='${colc}' style='font-weight:bold; margin-right:6px;'>${msg.sender}:</span> `+bubble.innerHTML;
  }
  if(msg.sender==="_system"){
    bubble.style.fontStyle="italic";
    bubble.style.opacity="0.75";
  }

  // reaction
  const rt=document.createElement("span");
  rt.className="reactionTag";
  if(msg.reaction) rt.textContent=msg.reaction;
  bubble.appendChild(rt);

  // reaction bar
  const rBar=document.createElement("div");
  rBar.className="reactionBar";
  const possible=["‚ù§Ô∏è","üëç","üòÇ","üòÆ","üò¢"];
  possible.forEach(r=>{
    const s=document.createElement("span");
    s.textContent=r;
    s.onclick=(e)=>{
      e.stopPropagation();
      applyReaction(msgId, r);
      rBar.style.display="none";
    };
    rBar.appendChild(s);
  });
  bubble.appendChild(rBar);

  // dblclick => show reaction bar
  bubble.addEventListener("dblclick", e=>{
    e.stopPropagation();
    rBar.style.display=(rBar.style.display==="flex")?"none":"flex";
  });

  // time
  const tm=new Date(msg.timestamp||0).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  const ts=document.createElement("div");
  ts.className="timestamp "+(isMe?"mineTime":"otherTime");
  ts.textContent=tm;
  bubble.appendChild(ts);

  document.getElementById("messages").appendChild(bubble);
}

//** reaction
function applyReaction(msgId, reaction){
  if(!currentChat||!currentType)return;
  const path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/messages/${msgId}/reaction`).set(reaction);
}

//** get color class
function getColorClass(u){
  if(!colorMap[u]){
    colorMap[u]=colorClasses[Math.floor(Math.random()*colorClasses.length)];
  }
  return colorMap[u];
}

//** typing
function sendTyping(){
  if(!currentChat)return;
  db.ref(`${currentType==="group"?"groupChats":"privateChats"}/${currentChat}/typing`).set(user);
  setTimeout(()=>{
    db.ref(`${currentType==="group"?"groupChats":"privateChats"}/${currentChat}/typing`).set("");
  },2000);
}

//** send
function sendMessage(){
  const inp=document.getElementById("msgInput");
  const text=inp.value.trim();
  if(!text||!currentChat)return;
  // if private => check block
  if(currentType==="private") {
    // let's find the friend name from chatTitle
    const friend=document.getElementById("chatTitle").textContent;
    if(blocked[friend]) {
      showNotice("You blocked this user. Unblock first.");
      return;
    }
  }
  const path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/messages`).push({
    sender:user, text, timestamp:Date.now(), reaction:""
  });
  inp.value="";
  sendTyping();
}

//** presence
function showPresenceInfo(friendName, chatType){
  if(chatType==="group"){
    document.getElementById("presenceLabel").textContent="(Group)";
    return;
  }
  if(blocked[friendName]) {
    document.getElementById("presenceLabel").textContent="(Blocked)";
    return;
  }
  // check presence
  db.ref(`presence/${friendName}`).once("value", snap=>{
    const val=snap.val();
    if(!val) {
      document.getElementById("presenceLabel").textContent="(Offline)";
      return;
    }
    if(val.state==="online") {
      document.getElementById("presenceLabel").textContent="(Online)";
    } else {
      const delta=Date.now() - val.lastOnline;
      const mins=Math.floor(delta/60000);
      document.getElementById("presenceLabel").textContent=`(Last seen ${mins} min ago)`;
    }
  });
}

//** lock icon => send pass
function toggleLock(){
  if(!currentChat||!currentType)return;
  const password=localStorage.getItem("pass")||"(none)";
  const path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/messages`).push({
    sender:user, text:`üîí Password: ${password}`, timestamp:Date.now()
  });
}

//** top lock => show/hide
function toggleTopLock(){
  const hp=document.getElementById("hiddenPassword");
  hp.style.display=(hp.style.display==="none")?"inline":"none";
}

//** add friend
function addFriendUI(){
  showConfirm("Enter friend's username to add:<br/><input id='addF'/>", ()=>{
    const f=document.getElementById("addF").value.trim();
    if(!f)return showNotice("No username entered.");
    // send request to f
    if(blocked[f])return showNotice("You blocked this user. Unblock first.");
    db.ref(`users/${f}/requests/${user}`).set({requested:true});
    db.ref(`privateChats/${[user,f].sort().join('_')}`).set({});
    showNotice(`Friend request sent to ${f}.`);
  });
}

//** add chat
function addChatUI(){
  showNotice("Use 'Create Group' or 'Join Group' or open a friend chat from 'Friends'.");
}

//** open/close panels
function openFriendsPanel(){
  const fi=document.getElementById("friendsInner");
  fi.innerHTML="<h3>Your Friends</h3>";
  Object.keys(friends).forEach(fr=>{
    const row=document.createElement("div");
    row.style.marginBottom="6px";
    row.innerHTML=`${fr} `;
    // A: open chat
    const a=document.createElement("button");
    a.textContent="Open Chat";
    a.onclick=()=>{
      // create private chat
      const cid=[user, fr].sort().join("_");
      db.ref(`privateChats/${cid}`).once("value", s=>{
        if(!s.exists()) db.ref(`privateChats/${cid}`).set({});
      });
      db.ref(`users/${user}/chats/${cid}`).set({name:fr,type:"private",last:Date.now()});
      closeFriendsPanel();
      openChat(cid,fr,"private");
    };
    row.appendChild(a);

    // B: invite to group
    const b=document.createElement("button");
    b.textContent="Invite to Group";
    b.onclick=()=>{
      // pick group
      pickGroupForInvite(fr);
    };
    row.appendChild(b);

    // C: block
    const c=document.createElement("button");
    c.textContent="Block/Unblock";
    c.onclick=()=>{
      if(blocked[fr]) {
        db.ref(`users/${user}/blocked/${fr}`).remove();
        showNotice(`Unblocked ${fr}`);
      } else {
        db.ref(`users/${user}/blocked/${fr}`).set(true);
        showNotice(`Blocked ${fr}`);
      }
    };
    row.appendChild(c);

    fi.appendChild(row);
  });
  document.getElementById("friendsPanel").style.display="flex";
}
function closeFriendsPanel(){
  document.getElementById("friendsPanel").style.display="none";
}
function pickGroupForInvite(friend){
  // show groups user is in
  db.ref(`users/${user}/chats`).once("value", snap=>{
    const data=snap.val()||{};
    const groups=Object.entries(data).filter(([id,info])=>info.type==="group");
    if(!groups.length)return showNotice("You are not in any group chats.");
    let html="<h3>Pick a Group to Invite "+friend+" to:</h3>";
    groups.forEach(([gid, ginfo])=>{
      html+=`<button onclick='inviteFriendToGroup(\"${gid}\",\"${friend}\")'>${ginfo.name||gid}</button><br/>`;
    });
    document.getElementById("friendsInner").innerHTML=html+`<button onclick='closeFriendsPanel()'>Close</button>`;
  });
}
function inviteFriendToGroup(gid, friend){
  db.ref(`groupChats/${gid}/members/${friend}`).set(true);
  db.ref(`users/${friend}/chats/${gid}`).set({name:"Group Invite",type:"group",last:Date.now()});
  showNotice(`Invited ${friend} to group: ${gid}`);
}
function blockUserUI(){
  showConfirm("Enter username to block/unblock:<br/><input id='blkU'/>", ()=>{
    const bn=document.getElementById("blkU").value.trim();
    if(!bn)return showNotice("No username.");
    if(blocked[bn]) {
      db.ref(`users/${user}/blocked/${bn}`).remove();
      showNotice(`Unblocked ${bn}`);
    } else {
      db.ref(`users/${user}/blocked/${bn}`).set(true);
      showNotice(`Blocked ${bn}`);
    }
  });
}

//** group management: change name/password
function openEditGroupPanel(gid){
  db.ref(`groupChats/${gid}`).once("value", s=>{
    const g=s.val()||{};
    if(g.createdBy!==user) return showNotice("You are not the owner!");
    const p=document.getElementById("editGroupInner");
    p.innerHTML=`
      <h3>Edit Group ${g.name}</h3>
      <label>Group Name:</label><br/>
      <input id='editGroupName' value='${g.name||''}' /><br/>
      <label>Type:</label><br/>
      <select id='editGroupType'>
        <option value='open' ${g.type==='open'?'selected':''}>Open</option>
        <option value='password' ${g.type==='password'?'selected':''}>Password</option>
        <option value='invite' ${g.type==='invite'?'selected':''}>Invite Only</option>
      </select><br/>
      <label>Password:</label><br/>
      <input id='editGroupPass' value='${g.password||''}' /><br/>
      <button onclick='saveGroupEdits(\"${gid}\")'>Save</button>
      <button onclick='closeEditGroupPanel()'>Close</button>
    `;
    document.getElementById("editGroupPanel").style.display="flex";
  });
}
function saveGroupEdits(gid){
  const nn=document.getElementById("editGroupName").value.trim();
  const tt=document.getElementById("editGroupType").value;
  const pw=document.getElementById("editGroupPass").value.trim();
  db.ref(`groupChats/${gid}`).update({name:nn,type:tt,password:pw});
  db.ref(`users/${user}/chats/${gid}`).update({name:nn});
  closeEditGroupPanel();
  showNotice("Group updated!");
}
function closeEditGroupPanel(){
  document.getElementById("editGroupPanel").style.display="none";
}

//** show/hide group mgmt
document.addEventListener("DOMContentLoaded",()=>{
  const mgBtn=document.createElement("button");
  mgBtn.textContent="üõ† Edit Group";
  mgBtn.title="Edit Group Name/Password";
  mgBtn.onclick=()=>{
    if(currentType==="group") openEditGroupPanel(currentChat);
  };
  document.getElementById("topButtons").appendChild(mgBtn);
});

//** show/hide
function showJoinPanel(){document.getElementById("groupJoinPanel").style.display="flex";}
function closeJoinPanel(){document.getElementById("groupJoinPanel").style.display="none";}
function showCreatePanel(){document.getElementById("groupCreatePanel").style.display="flex";}
function closeCreatePanel(){document.getElementById("groupCreatePanel").style.display="none";}
function closeDirectory(){document.getElementById("directoryPanel").style.display="none";}
function closeSettings(){document.getElementById("settingsPanel").style.display="none";}

function createGroupChat(){
  const n=document.getElementById("groupName").value.trim();
  const t=document.getElementById("groupType").value;
  const p=document.getElementById("groupPassword").value.trim();
  if(!n)return;
  const gid=\"group_\"+Date.now();
  const members={}; members[user]=true;
  db.ref(`groupChats/${gid}`).set({name:n,type:t,password:p,createdBy:user,members});
  db.ref(`users/${user}/chats/${gid}`).set({name:n,type:\"group\",last:Date.now()});
  closeCreatePanel();
  openChat(gid,n,\"group\");
}
function joinGroupChat(){
  const id=document.getElementById(\"joinGroupID\").value.trim();
  const pw=document.getElementById(\"joinGroupPassword\").value.trim();
  if(!id)return;
  db.ref(\"groupChats/\"+id).once(\"value\",snap=>{
    const g=snap.val();
    if(!g)return showNotice(\"Group not found\");
    if(g.type===\"password\"&&g.password!==pw)return showNotice(\"Wrong password\");
    if(g.type===\"invite\"&&!(g.members&&g.members[user]))return showNotice(\"You are not invited\");
    db.ref(`groupChats/${id}/members/${user}`).set(true);
    db.ref(`users/${user}/chats/${id}`).set({name:g.name,type:\"group\",last:Date.now()});
    closeJoinPanel();
    openChat(id,g.name,\"group\");
  });
}
function showDirectory(){
  document.getElementById(\"directoryPanel\").style.display=\"flex\";
  loadPublicDirectory();
}
function loadPublicDirectory(){
  const list=document.getElementById(\"publicList\");
  list.innerHTML=\"<strong>Open Groups:</strong><br/>\";
  db.ref(\"groupChats\").once(\"value\", snap=>{
    const gs=snap.val()||{};
    Object.entries(gs).forEach(([id,g])=>{
      if(g.type===\"open\"){
        const b=document.createElement(\"button\");
        b.textContent=`${g.name} (${id})`;
        b.onclick=()=>{
          db.ref(`groupChats/${id}/members/${user}`).set(true);
          db.ref(`users/${user}/chats/${id}`).set({name:g.name,type:\"group\",last:Date.now()});
          closeDirectory();
          openChat(id,g.name,\"group\");
        };
        list.appendChild(b);
        list.appendChild(document.createElement(\"br\"));
      }
    });
  });
}

//** in-page confirm + notice
function showConfirm(html, yesCallback){
  const cp=document.getElementById(\"confirmPanel\");
  const ci=document.getElementById(\"confirmInner\");
  ci.innerHTML=`
    <h3 style='margin-top:0'>Confirm</h3>
    <p>${html}</p>
    <div style='display:flex;justify-content:center;gap:10px;'>
      <button style='background:red;' onclick='doYes()'>‚úî</button>
      <button style='background:green;' onclick='closeConfirm()'>‚úò</button>
    </div>
  `;
  cp.style.display=\"flex\";
  window.doYes=()=>{
    cp.style.display=\"none\";
    yesCallback();
  };
  window.closeConfirm=()=>{
    cp.style.display=\"none\";
  };
}
function showNotice(msg){
  const np=document.getElementById(\"noticePanel\");
  const ni=document.getElementById(\"noticeInner\");
  ni.innerHTML=`
    <h3 style='margin-top:0'>Notice</h3>
    <p>${msg}</p>
    <button onclick='closeNotice()'>OK</button>
  `;
  np.style.display=\"flex\";
}
function closeNotice(){
  document.getElementById(\"noticePanel\").style.display=\"none\";
}

//** settings
function openSettings(){
  document.getElementById(\"settingsPanel\").style.display=\"flex\";
  document.getElementById(\"editUsername\").value=user;
  document.getElementById(\"editPassword\").value=pass;
  document.getElementById(\"themeSelect\").value=localStorage.getItem(\"theme\")||\"dark\";
}
function saveSettings(){
  const nu=document.getElementById(\"editUsername\").value.trim();
  const np=document.getElementById(\"editPassword\").value.trim();
  const th=document.getElementById(\"themeSelect\").value;
  if(!nu)return;
  localStorage.setItem(\"user\",nu);
  localStorage.setItem(\"pass\",np);
  localStorage.setItem(\"theme\",th);
  location.reload();
}
function applyTheme(){
  const th=localStorage.getItem(\"theme\")||\"dark\";
  document.body.classList.remove(\"light\",\"blue\");
  if(th===\"light\") document.body.classList.add(\"light\");
  if(th===\"blue\") document.body.classList.add(\"blue\");
}

//** import/export
function openImportExportPanel(){
  const panel=document.createElement(\"div\");
  panel.style.position=\"fixed\";
  panel.style.inset=0;
  panel.style.background=\"rgba(0,0,0,0.7)\";
  panel.style.display=\"flex\";
  panel.style.justifyContent=\"center\";
  panel.style.alignItems=\"center\";
  panel.style.zIndex=1001;
  const inn=document.createElement(\"div\");
  inn.style.background=\"var(--chat-bg)\";
  inn.style.padding=\"20px\";
  inn.style.borderRadius=\"10px\";
  inn.style.maxWidth=\"300px\";
  inn.innerHTML=`
    <h3 style='margin-top:0'>Export / Import</h3>
    <button onclick='exportChatData()'>üì§ Export My Chats</button><br/><br/>
    <input type='file' onchange='importChatData(this.files[0])' /><br/><br/>
    <button onclick='this.parentElement.parentElement.remove()'>Close</button>
  `;
  panel.appendChild(inn);
  document.body.appendChild(panel);
}
function exportChatData(){
  db.ref(`users/${user}/chats`).once(\"value\", snap=>{
    const data=snap.val()||{};
    const exportObj={};
    const tasks=Object.keys(data).map(cid=>{
      const path=(data[cid].type===\"group\")?\"groupChats\":\"privateChats\";
      return db.ref(`${path}/${cid}/messages`).once(\"value\").then(ss=>{
        exportObj[cid]=ss.val()||{};
      });
    });
    Promise.all(tasks).then(()=>{
      const blob=new Blob([JSON.stringify(exportObj,null,2)],{type:\"application/json\"});
      const url=URL.createObjectURL(blob);
      const link=document.createElement(\"a\");
      link.href=url;
      link.download=`static-chat-backup-${user}.json`;
      link.click();
    });
  });
}
function importChatData(file){
  const rdr=new FileReader();
  rdr.onload=(e)=>{
    try{
      const imported=JSON.parse(e.target.result);
      Object.entries(imported).forEach(([cid,msgs])=>{
        const path=(cid.startsWith(\"group_\"))?\"groupChats\":\"privateChats\";
        Object.entries(msgs).forEach(([mid,m])=>{
          db.ref(`${path}/${cid}/messages/${mid}`).set(m);
        });
      });
      showNotice(\"Chat data imported!\");
    }catch(err){
      showNotice(\"Invalid backup file\");
    }
  };
  rdr.readAsText(file);
}

//** done
console.log(\"‚úÖ Extended Chat with advanced features loaded\");
</script>
<!-- Example Firebase Rules:
{
  \"rules\": {
    \".read\": \"auth == null\",
    \".write\": \"auth == null\",
    \"users\": {
      \"$username\": { \".read\":\"true\",\".write\":\"true\" }
    },
    \"privateChats\": {
      \"$chatId\": { \".read\":\"true\",\".write\":\"true\" }
    },
    \"groupChats\": {
      \"$groupId\": { \".read\":\"true\",\".write\":\"true\" }
    },
    \"presence\": {
      \"$user\": { \".read\":\"true\",\".write\":\"true\" }
    }
  }
}
-->
</body>
</html>
