<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Static Live Chatting</title>
  <style>
    :root {
      --bg-color: #111;
      --text-color: #fff;
      --sidebar-color: #222;
      --chat-bg: #333;
      --msg-bg: #444;
      --hover-bg: #555;
      --accent: #1e90ff;
    }
    body.light {
      --bg-color: #f0f0f0;
      --text-color: #000;
      --sidebar-color: #e0e0e0;
      --chat-bg: #ccc;
      --msg-bg: #ddd;
      --hover-bg: #bbb;
      --accent: #007acc;
    }
    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
      border-radius: 5px;
      border: none;
    }
    button { background: var(--accent); color: white; cursor: pointer; }
    #login, #settings {
      position: fixed; inset: 0;
      background: var(--bg-color);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 999;
    }
    #app { display: flex; flex: 1; height: 100%; }
    #sidebar {
      width: 260px; background: var(--sidebar-color);
      display: flex; flex-direction: column;
      padding: 10px; overflow-y: auto;
    }
    #chatPanel {
      flex: 1; display: flex; flex-direction: column;
      position: relative;
    }
    #topBar {
      background: var(--chat-bg);
      padding: 10px;
      display: flex; justify-content: space-between;
      align-items: center;
    }
    #chatTitle {
      font-weight: bold;
    }
    #messages {
      flex: 1; padding: 10px;
      overflow-y: auto;
    }
    #inputArea {
      background: var(--sidebar-color);
      display: flex; padding: 10px;
    }
    #inputArea input { flex: 1; margin-right: 6px; }
    #emojiPicker {
      display: none; flex-wrap: wrap;
      max-width: 250px; background: var(--chat-bg);
      position: absolute; bottom: 70px; right: 10px;
      z-index: 99; padding: 10px;
    }
    #emojiPicker span {
      font-size: 20px; margin: 5px; cursor: pointer;
    }
    .msg span {
      color: var(--accent); font-weight: bold;
    }
    .chatItem {
      background: var(--msg-bg);
      padding: 8px; margin-bottom: 6px;
      border-radius: 5px; cursor: pointer;
    }
    .chatItem:hover { background: var(--hover-bg); }
    #typingIndicator {
      padding: 5px 10px;
      font-style: italic;
      font-size: 12px;
    }
    #chatPasswordDisplay {
      font-size: 12px;
      padding-left: 10px;
    }
    #requestsTab, #sentRequestsTab {
      font-size: 13px;
      padding: 5px;
      margin-top: 10px;
    }
    #staticMenu {
      position: fixed;
      bottom: 10px; left: 10px;
      background: #1e1e1e; color: white;
      padding: 10px; border-radius: 10px;
      box-shadow: 0 0 10px #0ff;
      animation: blink 2s infinite;
      z-index: 1000;
    }
    #staticMenuClose {
      position: absolute;
      top: 2px;
      right: 6px;
      cursor: pointer;
      color: red;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
  </style>
</head>
<body>

<div id="login">
  <h2>Static Live Chatting</h2>
  <p>‚ö†Ô∏è Do not share passwords or sensitive info.</p>
  <input id="username" placeholder="Nickname" />
  <input id="password" type="password" placeholder="Password (optional)" />
  <button onclick="togglePassword()">üëÅ Show Password</button>
  <button onclick="login()">Log In</button>
</div>

<div id="app" style="display:none;">
  <div id="sidebar">
    <h3>Chats</h3>
    <div id="chatList"></div>
    <hr/>
    <h4>Incoming Requests</h4>
    <div id="requestsTab"></div>
    <h4>Sent Requests</h4>
    <div id="sentRequestsTab"></div>
    <hr/>
    <button onclick="openGroup()">‚ûï Create Group</button>
    <button onclick="addFriendChat()">üë§ Add Friend</button>
    <button onclick="openSettings()">‚öôÔ∏è Settings</button>
    <button onclick="toggleTheme()">üåì Theme</button>
  </div>
  <div id="chatPanel">
    <div id="topBar">
      <div id="chatTitle">No Chat</div>
      <div style="display:flex; align-items:center;">
        <div id="chatPasswordDisplay" style="display:none;"></div>
        <button onclick="toggleChatPass()">üîì</button>
        <button onclick="openSettings()">‚öôÔ∏è</button>
      </div>
    </div>
    <div id="messages"></div>
    <div id="typingIndicator" style="display:none;">User is typing...</div>
    <div id="inputArea">
      <input id="msgInput" placeholder="Type message..." oninput="sendTyping()" onkeypress="if(event.key==='Enter')sendMessage();"/>
      <button onclick="toggleEmojiPicker()">üòÄ</button>
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="emojiPicker"></div>
  </div>
</div>

<div id="settings" style="display:none;">
  <h2>Settings</h2>
  <label>Username: <input id="editUsername" /></label><br/>
  <label>Password: <input id="editPassword" /></label><br/>
  <p>Changing password may break old chats (A) or affect only new ones (B).</p>
  <button onclick="saveSettings('A')">Save (Affect Past)</button>
  <button onclick="saveSettings('B')">Save (Future Only)</button>
  <button onclick="showBlocked()">üö´ Blocked Users</button>
  <button onclick="closeSettings()">Close</button>
</div>

<div id="staticMenu">
  <span id="staticMenuClose" onclick="closeStaticMenu()">‚úñ</span>
  üåü More Unblocked Games by Static
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>
<script>
window.onbeforeunload = function () {
  return "Are you sure you want to leave? Your progress may not be saved.";
};

const config = {
  apiKey: "AIzaSyBO7EHU4-_b2NHf7UFYTB8Wolv73Z0P8Fw",
  authDomain: "static-live-chatting.firebaseapp.com",
  databaseURL: "https://static-live-chatting-default-rtdb.firebaseio.com",
  projectId: "static-live-chatting",
  storageBucket: "static-live-chatting.appspot.com",
  messagingSenderId: "578562140653",
  appId: "1:578562140653:web:c12df07155627083e9dfe4"
};
firebase.initializeApp(config);
const db = firebase.database();

let user = localStorage.getItem("user") || "";
let pass = localStorage.getItem("pass") || "";
let blocked = JSON.parse(localStorage.getItem("blocked") || "[]");
let currentChat = "", currentType = "", currentPassword = "";
let typingTimeout;

if (user && !localStorage.getItem("locked")) {
  document.getElementById("login").style.display = "none";
  document.getElementById("app").style.display = "flex";
  loadChats(); loadRequests();
}
if (localStorage.getItem("theme") === "light") document.body.classList.add("light");

function login() {
  user = document.getElementById("username").value.trim();
  pass = document.getElementById("password").value.trim();
  if (!user) return;
  localStorage.setItem("user", user);
  localStorage.setItem("pass", pass);
  document.getElementById("login").style.display = "none";
  document.getElementById("app").style.display = "flex";
  loadChats(); loadRequests();
  if (Notification.permission === "granted") {
    new Notification("Static Chat Ready", { body: "You're now online." });
  }
}

function togglePassword() {
  const input = document.getElementById("password");
  input.type = input.type === "password" ? "text" : "password";
}

function loadChats() {
  db.ref("users/" + user + "/chats").on("value", snap => {
    const data = snap.val() || {};
    const list = Object.entries(data).sort((a, b) => (b[1].last || 0) - (a[1].last || 0));
    const container = document.getElementById("chatList");
    container.innerHTML = "";
    list.forEach(([id, info]) => {
      const div = document.createElement("div");
      div.className = "chatItem";
      div.textContent = info.name || id;
      div.onclick = () => openChat(id, info.name, info.type, info.password, info.oldName);
      container.appendChild(div);
    });
  });
}

function openChat(id, name, type = "private", password = "", oldName = "") {
  currentChat = id; currentType = type; currentPassword = password;
  const displayName = oldName ? `${name} (used to be ${oldName})` : name;
  document.getElementById("chatTitle").textContent = displayName;
  document.getElementById("chatPasswordDisplay").textContent = password ? `Password: ${password}` : "";
  const passDisplay = document.getElementById("chatPasswordDisplay");
  passDisplay.style.display = "none";

  const ref = db.ref(`${type}Chats/${id}/messages`);
  ref.off(); document.getElementById("messages").innerHTML = "";
  ref.on("child_added", snap => {
    const msg = snap.val();
    if (blocked.includes(msg.sender)) return;
    const time = new Date(msg.timestamp).toLocaleTimeString();
    document.getElementById("messages").innerHTML += `<div class="msg"><span>${msg.sender}</span> (${time}): ${msg.text}</div>`;
    document.getElementById("messages").scrollTop = 999999;
  });

  db.ref(`${type}Chats/${id}/typing`).on("value", snap => {
    const typer = snap.val();
    document.getElementById("typingIndicator").style.display = (typer && typer !== user) ? "block" : "none";
  });

  db.ref(`users/${user}/chats/${id}/last`).set(Date.now());
}

function toggleChatPass() {
  const el = document.getElementById("chatPasswordDisplay");
  el.style.display = el.style.display === "none" ? "inline" : "none";
}

function sendTyping() {
  if (!currentChat) return;
  db.ref(`${currentType}Chats/${currentChat}/typing`).set(user);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    db.ref(`${currentType}Chats/${currentChat}/typing`).set("");
  }, 1500);
}

function sendMessage() {
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if (!text || !currentChat) return;
  db.ref(`${currentType}Chats/${currentChat}/messages`).push({
    sender: user, text, timestamp: Date.now()
  });
  input.value = "";
  sendTyping();
}

function toggleEmojiPicker() {
  const picker = document.getElementById("emojiPicker");
  picker.innerHTML = "";
  picker.style.display = picker.style.display === "flex" ? "none" : "flex";
  const emojis = [..."üòÄüòéüòÇüî•‚ù§Ô∏èüëçüò¢üò°ü•≥üéâüíØü§ñüíÄüò≠üôÉüëè‚ú®üß†üò¥ü´°üöÄüåàüéÆüçïüì±üìßüìåüí¨üí°üß°ü•∫üëÄ‚úÖüì£üïπÔ∏èüòÜüòçü§©ü´∂ü§ìüó®Ô∏èüîíüí≠üíªüìöüí§"];
  emojis.forEach(e => {
    const span = document.createElement("span");
    span.textContent = e;
    span.onclick = () => {
      document.getElementById("msgInput").value += e;
      picker.style.display = "none";
    };
    picker.appendChild(span);
  });
}

function openGroup() {
  const name = prompt("Group name:");
  const pw = prompt("Password (optional):");
  const id = "group_" + Date.now();
  db.ref(`groupChats/${id}`).set({ name, password: pw, createdBy: user });
  db.ref(`users/${user}/chats/${id}`).set({ name, password: pw, type: "group", last: Date.now() });
  openChat(id, name, "group", pw);
}

function addFriendChat() {
  const friend = prompt("Friend's username:");
  if (!friend) return;
  const id = [user, friend].sort().join("_");
  db.ref(`privateChats/${id}`).set({});
  db.ref(`users/${user}/chats/${id}`).set({ name: friend, type: "private", last: Date.now() });
  db.ref(`users/${friend}/requests/${user}`).set({ requested: true });
  db.ref(`users/${user}/sent/${friend}`).set({ sent: true });
  openChat(id, friend, "private");
}

function loadRequests() {
  db.ref(`users/${user}/requests`).on("value", snap => {
    const tab = document.getElementById("requestsTab");
    tab.innerHTML = "";
    Object.keys(snap.val() || {}).forEach(from => {
      const div = document.createElement("div");
      div.textContent = `From: ${from} `;
      const btn = document.createElement("button");
      btn.textContent = "Accept";
      btn.onclick = () => {
        const id = [user, from].sort().join("_");
        db.ref(`privateChats/${id}`).set({});
        db.ref(`users/${user}/chats/${id}`).set({ name: from, type: "private", last: Date.now() });
        db.ref(`users/${user}/requests/${from}`).remove();
        db.ref(`users/${from}/sent/${user}`).remove();
        openChat(id, from, "private");
      };
      div.appendChild(btn);
      tab.appendChild(div);
    });
  });

  db.ref(`users/${user}/sent`).on("value", snap => {
    const tab = document.getElementById("sentRequestsTab");
    tab.innerHTML = "";
    Object.keys(snap.val() || {}).forEach(to => {
      const div = document.createElement("div");
      div.textContent = `To: ${to} (pending)`;
      tab.appendChild(div);
    });
  });
}

function openSettings() {
  document.getElementById("editUsername").value = user;
  document.getElementById("editPassword").value = pass;
  document.getElementById("settings").style.display = "flex";
}

function closeSettings() {
  document.getElementById("settings").style.display = "none";
}

function saveSettings(mode) {
  const newUser = document.getElementById("editUsername").value.trim();
  const newPass = document.getElementById("editPassword").value.trim();
  if (!newUser) return;
  localStorage.setItem("user", newUser);
  localStorage.setItem("pass", newPass);
  if (mode === "A" && currentChat) {
    db.ref(`users/${newUser}/chats/${currentChat}/password`).set(newPass);
  }
  location.reload();
}

function toggleTheme() {
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
}

function showBlocked() {
  const name = prompt("Blocked:\n" + blocked.join(", ") + "\nType name to block/unblock:");
  if (!name) return;
  if (blocked.includes(name)) {
    blocked = blocked.filter(n => n !== name);
  } else {
    blocked.push(name);
  }
  localStorage.setItem("blocked", JSON.stringify(blocked));
}

function closeStaticMenu() {
  document.getElementById("staticMenu").style.display = "none";
  setTimeout(() => {
    document.getElementById("staticMenu").style.display = "block";
  }, 180000);
}
</script>
</body>
</html>
