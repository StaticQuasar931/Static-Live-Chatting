<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Static Live Chat</title>
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>
  <style>
    /* ===== Theme Variables ===== */
    :root {
      --bg-color: #111;
      --text-color: #fff;
      --sidebar-color: #1c1c1c;
      --chat-bg: #222;
      --bubble-to: #1e90ff;
      --bubble-from: #444;
      --bubble-console: rgba(255, 255, 255, 0.2);
      --accent: #1e90ff;
      --badge: red;
      --chat-item-bg: #333;
      --font-size-msg: 14px;
      --max-bubble-width: 65%;
      /* Tweak bubble corners for a nicer shape. */
      --bubble-border-radius: 16px 16px 10px 10px;
      --shadow-msg: 0px 2px 5px rgba(0, 0, 0, 0.4);
    }
    body.light {
      --bg-color: #f4f4f4;
      --text-color: #000;
      --sidebar-color: #ddd;
      --chat-bg: #eee;
      --bubble-to: #007aff;
      --bubble-from: #ccc;
      --bubble-console: rgba(0, 0, 0, 0.1);
      --accent: #007acc;
      --chat-item-bg: #bbb;
    }
    body.blue {
      --bg-color: #0b1622;
      --text-color: #f0f8ff;
      --sidebar-color: #132336;
      --chat-bg: #1e2d40;
      --bubble-to: #1f65ff;
      --bubble-from: #41546a;
      --bubble-console: rgba(255, 255, 255, 0.2);
      --accent: #389fff;
      --chat-item-bg: #2e3d52;
    }
    body.green {
      --bg-color: #102a10;
      --text-color: #e8ffe8;
      --sidebar-color: #224522;
      --chat-bg: #1a331a;
      --bubble-to: #28a745;
      --bubble-from: #375a37;
      --bubble-console: rgba(255, 255, 255, 0.2);
      --accent: #4caf50;
      --chat-item-bg: #2b442b;
    }
    body.pink {
      --bg-color: #331024;
      --text-color: #ffe0f0;
      --sidebar-color: #441533;
      --chat-bg: #551a44;
      --bubble-to: #ff3377;
      --bubble-from: #773355;
      --bubble-console: rgba(255, 255, 255, 0.2);
      --accent: #ff66a2;
      --chat-item-bg: #442244;
    }
    body.purple {
      --bg-color: #2e1033;
      --text-color: #f4e4ff;
      --sidebar-color: #42154a;
      --chat-bg: #551a66;
      --bubble-to: #9b59b6;
      --bubble-from: #7e3f9f;
      --bubble-console: rgba(255, 255, 255, 0.2);
      --accent: #b86af1;
      --chat-item-bg: #4d1460;
    }

    /* ===== Global Layout ===== */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
      border-radius: 6px;
      border: none;
    }
    button {
      background: var(--accent);
      color: #fff;
      cursor: pointer;
    }

    /* ===== Main App ===== */
    #app {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #sidebar {
      width: 280px;
      background: var(--sidebar-color);
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow-y: auto;
    }
    #chatPanel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--chat-bg);
      position: relative;
    }
    #topBar, #inputArea {
      flex-shrink: 0;
    }
    #topBar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--chat-bg);
      font-size: 18px;
    }
    #chatTitle {
      font-weight: bold;
    }
    #messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      background: var(--chat-bg);
    }

    /* ===== Message Bubbles ===== */
    .msg {
      display: inline-block;
      max-width: var(--max-bubble-width);
      margin: 8px 0;
      border-radius: var(--bubble-border-radius);
      font-size: var(--font-size-msg);
      line-height: 1.4;
      word-wrap: break-word;
      position: relative;
      box-shadow: var(--shadow-msg);
      background-clip: padding-box;
      padding: 10px 14px;
    }
    .to {
      align-self: flex-end;
      background: var(--bubble-to);
      color: #fff;
      text-align: right;
    }
    .from {
      align-self: flex-start;
      background: var(--bubble-from);
      color: #fff;
      text-align: left;
    }
    .console {
      align-self: center;
      background: var(--bubble-console);
      font-style: italic;
      text-align: center;
    }
    .reactionTag {
      font-size: 14px;
      opacity: 0.8;
      position: absolute;
      top: 5px;
      right: 10px;
    }
    .reactionBar {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      flex-direction: row;
      gap: 5px;
      background: rgba(0, 0, 0, 0.6);
      padding: 5px;
      border-radius: 6px;
      margin-bottom: 5px;
    }
    .reactionBar span {
      font-size: 22px;
      cursor: pointer;
    }
    .timestamp {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }

    /* ===== Input Area ===== */
    #typingIndicator {
      display: none;
      font-style: italic;
      font-size: 14px;
      margin: 0 20px 10px;
    }
    #inputArea {
      display: flex;
      padding: 10px;
      background: var(--sidebar-color);
    }
    #inputArea input {
      flex: 1;
      margin-right: 5px;
      font-size: 17px;
    }

    /* ===== Chat List & Items ===== */
    .chatItem {
      background: var(--chat-item-bg);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }
    .chatItem:hover {
      background: var(--bubble-from);
    }
    .chatItem.active {
      outline: 2px solid var(--accent);
    }
    .chatBadge {
      background: var(--badge);
      color: #fff;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 12px;
      margin-left: 5px;
    }
    .requestItem {
      background: var(--bubble-from);
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 6px;
    }

    /* ===== Extra Panels ===== */
    #emojiPicker {
      display: none;
      position: absolute;
      bottom: 70px;
      right: 15px;
      background: var(--chat-bg);
      padding: 10px;
      flex-wrap: wrap;
      z-index: 99;
      max-width: 340px;
      max-height: 180px;
      overflow: auto;
    }
    #emojiPicker span {
      font-size: 22px;
      margin: 6px;
      cursor: pointer;
    }

    #slashAutocomplete {
      display: none;
      position: absolute;
      background: var(--chat-bg);
      border-radius: 6px;
      padding: 5px;
      max-width: 220px;
      z-index: 9999;
    }
    #slashAutocomplete button {
      width: 100%;
      display: block;
      text-align: left;
      margin: 5px 0;
      padding: 6px;
      border-radius: 4px;
      border: none;
      background: var(--accent);
      cursor: pointer;
    }
    #loadMoreBtn {
      display: none;
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 5px;
      cursor: pointer;
      opacity: 0.8;
      z-index: 10;
    }

    /* ===== Modal Styles ===== */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modalContent {
      background: var(--chat-bg);
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      position: relative;
      text-align: center;
    }
    .closeBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      color: #fff;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      padding: 3px 8px;
    }

    /* ===== Notification Container ===== */
    #notificationContainer {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1100;
    }
    .notification {
      background: var(--accent);
      color: #fff;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 6px;
      opacity: 0.9;
      font-size: 16px;
      box-shadow: var(--shadow-msg);
      transition: opacity 0.5s;
    }

    /* ===== Login Screen ===== */
    #login {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      z-index: 999;
    }

    /* ===== Static Menu ===== */
    #staticMenu {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: #1e1e1e;
      color: #fff;
      padding: 5px 8px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 0 6px #0ff;
      animation: blink 2s infinite;
      z-index: 1000;
    }
    a.staticLink {
      color: #0ff;
      text-decoration: none;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
  </style>
</head>
<body>
<script>
/* =============== Firebase Initialization =============== */
const config = {
  apiKey: "AIzaSyBO7EHU4-_b2NHf7UFYTB8Wolv73Z0P8Fw",
  authDomain: "static-live-chatting.firebaseapp.com",
  databaseURL: "https://static-live-chatting-default-rtdb.firebaseio.com",
  projectId: "static-live-chatting",
  storageBucket: "static-live-chatting.appspot.com",
  messagingSenderId: "578562140653",
  appId: "1:578562140653:web:c12df07155627083e9dfe4"
};
firebase.initializeApp(config);
const db = firebase.database();

/* =============== Notification Sound =============== */
let notifAudio = null;
window.addEventListener("DOMContentLoaded", () => {
  notifAudio = document.getElementById("notifSound");
});

/* =============== Basic Helpers =============== */
function showNotice(msg) {
  const container = document.getElementById("notificationContainer");
  const note = document.createElement("div");
  note.className = "notification";
  note.textContent = msg;
  container.appendChild(note);
  setTimeout(() => { note.style.opacity = 0; }, 3000);
  setTimeout(() => { container.removeChild(note); }, 3500);
}
function showConfirm(msg) {
  return new Promise(resolve => {
    const mo = document.createElement("div");
    mo.className = "modal";
    mo.style.display = "flex";
    mo.innerHTML = `
      <div class="modalContent">
        <h3>Confirm</h3>
        <p>${msg}</p>
        <button id="yesBtn" style="background:green;">Yes</button>
        <button id="noBtn" style="background:red;">No</button>
      </div>
    `;
    document.body.appendChild(mo);
    mo.querySelector("#yesBtn").onclick = () => {
      document.body.removeChild(mo);
      resolve(true);
    };
    mo.querySelector("#noBtn").onclick = () => {
      document.body.removeChild(mo);
      resolve(false);
    };
  });
}
function debounce(fn, delay) {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), delay);
  };
}

/* =============== Local Device Setup =============== */
function genId() {
  return "dev_" + Math.random().toString(36).slice(2) + "_" + Date.now();
}
let myId = localStorage.getItem("myDeviceId");
if (!myId) {
  myId = genId();
  localStorage.setItem("myDeviceId", myId);
}
let displayName = localStorage.getItem("displayName") || "";
let pass = localStorage.getItem("pass") || "";

/* =============== Global Vars =============== */
let currentChat = "", currentType = "";
let messagesRef = null, childAddedRef = null, childChangedRef = null;
let oldestStamp = Number.MAX_SAFE_INTEGER, hasMoreOld = false;
let blocked = {}, friends = {};
let chatUnread = {};
let lastMessageTime = 0;

const slashCmds = [
  "/roll","/ping","/8ball","/roast","/tod truth","/tod dare","/title",
  "/cf heads","/cf tails","/coin flip heads","/coin flip tails",
  "/ship","/rps","/guessnumber","/vote"
];

const debouncedUpdateTitle = debounce(() => {
  let total = Object.values(chatUnread).reduce((a,b)=>a+b,0);
  document.title = total > 0 ? `(+${total}) Static Live Chat` : "Static Live Chat";
}, 300);
const debouncedUpdateChatListUI = debounce(updateChatListUI, 300);

/* =============== On Load =============== */
window.addEventListener("DOMContentLoaded", () => {
  document.addEventListener("keydown",(ev) => {
    if (ev.key === "Escape") {
      document.querySelectorAll(".modal").forEach(m => m.style.display="none");
    }
  });
  if (displayName) {
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "flex";
    applyTheme();
    loadBlocked();
    loadFriends();
    loadRequests();
    initChatWatchers();
    setupHelpChat(); // Insert help info in help_chat
  }
});

/* =============== Setup Help Chat =============== */
function setupHelpChat() {
  // Create a help_chat reference in user/chats if it doesn't exist
  db.ref(`users/${myId}/chats/help_chat`).once("value",(snap)=>{
    if(!snap.exists()) {
      db.ref(`users/${myId}/chats/help_chat`).set({ name:"Help (info)", type:"help", last:0 });
    }
  });
}

/* =============== Theming =============== */
function applyTheme() {
  const t = localStorage.getItem("theme") || "dark";
  document.body.className = "";
  if (t !== "dark") document.body.classList.add(t);
  setThemeLabel(t);
}
function toggleTheme() {
  const themes = ["dark","light","blue","green","pink","purple"];
  let current = "dark";
  for(let th of themes) {
    if(document.body.classList.contains(th)) current=th;
  }
  let idx = themes.indexOf(current);
  let next = themes[(idx+1)%themes.length];
  document.body.className = "";
  if(next!=="dark") document.body.classList.add(next);
  localStorage.setItem("theme", next);
  setThemeLabel(next);
}
function setThemeLabel(x) {
  document.getElementById("themeBtn").textContent = x + ": Theme";
}

/* =============== Login + Settings =============== */
function toggleLoginPass() {
  let pw = document.getElementById("password");
  pw.type = (pw.type==="password")?"text":"password";
}
function doLogin() {
  let nm = document.getElementById("username").value.trim();
  let p = document.getElementById("password").value.trim();
  if(!nm) { showNotice("Name can't be empty!"); return; }
  db.ref("displayNames/"+nm).once("value",(snap)=>{
    let val = snap.val();
    if(val && val!==myId) {
      showNotice("That display name is used by another device!");
      return;
    }
    displayName = nm; pass=p;
    localStorage.setItem("displayName", nm);
    localStorage.setItem("pass", p);
    db.ref("displayNames/"+nm).set(myId);
    db.ref(`users/${myId}/displayName`).set(nm);
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "flex";
    applyTheme();
    loadBlocked();
    loadFriends();
    loadRequests();
    initChatWatchers();
    setupHelpChat();
    showNotice("Logged in as " + nm);
  });
}
function openSettings() {
  let mo = document.createElement("div");
  mo.className = "modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:320px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Settings</h3>
      <label>Display Name:</label><br/>
      <input id="editName" value="${displayName}"/><br/>
      <label>Password (optional friend key):</label><br/>
      <input id="editPass" value="${pass}"/><br/>
      <button id="saveSetBtn">Save</button>
      <hr/>
      <h4>Blocked Users</h4>
      <div id="blockedList"></div>
      <hr/>
      <button id="logoutBtn" style="background:darkred;">Log Out</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.querySelector("#saveSetBtn").onclick=()=>{
    let newN = mo.querySelector("#editName").value.trim();
    let newP = mo.querySelector("#editPass").value.trim();
    if(!newN) { showNotice("Name can't be empty!"); return; }
    db.ref("displayNames/"+newN).once("value",(snap)=>{
      let val = snap.val();
      if(val && val!==myId) {
        showNotice("That name is taken!");
        return;
      }
      displayName=newN; pass=newP;
      localStorage.setItem("displayName",newN);
      localStorage.setItem("pass",newP);
      db.ref("displayNames/"+newN).set(myId);
      db.ref(`users/${myId}/displayName`).set(newN);
      showNotice("Settings saved!");
      document.body.removeChild(mo);
    });
  };
  mo.querySelector("#logoutBtn").onclick=()=>{
    showConfirm("Are you sure to log out?").then(ok=>{
      if(ok){
        localStorage.removeItem("myDeviceId");
        localStorage.removeItem("displayName");
        localStorage.removeItem("pass");
        location.reload();
      }
    });
  };
  loadBlockedForSettings(mo.querySelector("#blockedList"));
}
function loadBlockedForSettings(container) {
  db.ref(`users/${myId}/blocked`).once("value",(snap)=>{
    let bl = snap.val()||{};
    container.innerHTML="";
    if(!Object.keys(bl).length) container.textContent="No blocked users.";
    else {
      Object.keys(bl).forEach(u=>{
        let d=document.createElement("div");
        d.textContent = u+" ";
        let b=document.createElement("button");
        b.textContent="Unblock";
        b.onclick=()=>{
          db.ref(`users/${myId}/blocked/${u}`).remove();
          showNotice("Unblocked "+u);
          loadBlockedForSettings(container);
        };
        d.appendChild(b);
        container.appendChild(d);
      });
    }
  });
}

/* =============== Friends & Requests =============== */
let friendMenu = null;
function openFriendsPanel() {
  let mo = document.createElement("div");
  mo.className = "modal";
  mo.innerHTML=`
    <div class="modalContent" style="max-height:400px;overflow:auto;position:relative;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Your Friends</h3>
      <div id="frList"></div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  let fl=mo.querySelector("#frList");
  if(!friends || !Object.keys(friends).length) {
    fl.textContent="No friends yet!";
  } else {
    Object.keys(friends).forEach(n=>{
      let d=document.createElement("div");
      d.style.background="var(--chat-bg)";
      d.style.padding="8px";
      d.style.marginBottom="8px";
      d.style.borderRadius="6px";
      d.textContent=n;
      fl.appendChild(d);
    });
  }
}
function addFriendUI() {
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:300px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Add Friend by Name</h3>
      <input id="friendNameInput" placeholder="Friend's display name"/><br/>
      <button id="friendSendBtn">Send Request</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.querySelector("#friendSendBtn").onclick=()=>{
    let n=mo.querySelector("#friendNameInput").value.trim();
    if(!n) { showNotice("No name typed!"); return; }
    if(n===displayName) { showNotice("Can't friend yourself!"); return; }
    if(blocked[n]) { showNotice("You blocked them. Unblock first!"); return; }
    db.ref("displayNames/"+n).once("value",(snap)=>{
      let dev = snap.val();
      if(!dev) { showNotice("No user named "+n); return; }
      if(friends[n]) { showNotice("Already friends with "+n); return; }
      db.ref(`users/${myId}/requestsSent/${n}`).once("value",(s2)=>{
        if(s2.exists()) { showNotice("Already pending request."); return; }
        db.ref(`users/${dev}/requests/${displayName}`).set({requested:true});
        db.ref(`users/${myId}/requestsSent/${n}`).set(true);
        db.ref(`privateChats/${[myId,dev].sort().join("_")}`).set({});
        showNotice("Request sent to "+n);
        document.body.removeChild(mo);
      });
    });
  };
}

/* =============== Group Chat Creation & Join =============== */
function showAddChatPanel() {
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Add Chat</h3>
      <button onclick="showCreatePanel();document.body.removeChild(this.closest('.modal'))">Create Group</button><br/>
      <button onclick="showJoinPanel();document.body.removeChild(this.closest('.modal'))">Join Group</button><br/>
      <button onclick="showPublicDirectory();document.body.removeChild(this.closest('.modal'))">Open Groups</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
}
function showCreatePanel() {
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:300px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Create Group</h3>
      <input id="groupName" placeholder="Group Name"/><br/>
      <select id="groupType">
        <option value="open">Open</option>
        <option value="password">Password</option>
        <option value="invite">Invite Only</option>
      </select><br/>
      <input id="groupPassword" placeholder="Password (optional)"/><br/>
      <button id="createGroupBtn">Create</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.querySelector("#createGroupBtn").onclick=()=>{
    let nm=mo.querySelector("#groupName").value.trim();
    let ty=mo.querySelector("#groupType").value;
    let pw=mo.querySelector("#groupPassword").value.trim();
    if(!nm) { showNotice("No group name!"); return; }
    let gid="group_"+Date.now();
    db.ref(`groupChats/${gid}`).set({
      name:nm,
      type:ty,
      password:pw,
      createdBy:myId,
      members:{ [myId]:true, owner:myId },
      banned:{}
    });
    db.ref(`users/${myId}/chats/${gid}`).set({name:nm,type:"group",last:Date.now()});
    showNotice("Group created!");
    document.body.removeChild(mo);
    openChat(gid,nm,"group");
  };
}
function showJoinPanel() {
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:300px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Join Group Chat</h3>
      <input id="joinGroupID" placeholder="Group ID"/><br/>
      <input id="joinGroupPassword" placeholder="Password (if needed)"/><br/>
      <button id="joinGroupBtn">Join</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.querySelector("#joinGroupBtn").onclick=()=>{
    let id=mo.querySelector("#joinGroupID").value.trim();
    let pw=mo.querySelector("#joinGroupPassword").value.trim();
    if(!id) { showNotice("No group ID typed!"); return; }
    db.ref(`groupChats/${id}`).once("value",(snap)=>{
      let g=snap.val();
      if(!g) { showNotice("Group not found!"); return; }
      if(g.type==="password" && g.password!==pw) { showNotice("Wrong password!"); return; }
      if(g.type==="invite" && !g.members[myId]) { showNotice("Not invited!"); return; }
      // Check if banned
      if(g.banned && g.banned[myId]) { showNotice("You are banned from this group!"); return; }
      db.ref(`groupChats/${id}/members/${myId}`).set(true);
      db.ref(`users/${myId}/chats/${id}`).set({name:g.name,type:"group",last:Date.now()});
      document.body.removeChild(mo);
      openChat(id,g.name,"group");
    });
  };
}
function showPublicDirectory() {
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Public Groups</h3>
      <div id="publicList" style="max-height:200px;overflow:auto;"></div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  db.ref("groupChats").once("value",(snap)=>{
    let data=snap.val()||{};
    let pl=mo.querySelector("#publicList");
    pl.innerHTML="";
    Object.entries(data).forEach(([gid,g])=>{
      if(g.type==="open") {
        let b=document.createElement("button");
        b.textContent=`${g.name} (${gid})`;
        b.onclick=()=>{
          if(g.banned && g.banned[myId]) { showNotice("You are banned from this group!"); return; }
          db.ref(`groupChats/${gid}/members/${myId}`).set(true);
          db.ref(`users/${myId}/chats/${gid}`).set({name:g.name,type:"group",last:Date.now()});
          document.body.removeChild(mo);
          openChat(gid,g.name,"group");
        };
        pl.appendChild(b);
        pl.appendChild(document.createElement("br"));
      }
    });
  });
}

/* =============== Kicking / Banning in Group =============== */
function openGroupEditPanel(gid) {
  // We assume user is owner
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:320px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Edit Group</h3>
      <label>New Name:</label><br/>
      <input id="grpRename"/><br/>
      <button id="renameBtn">Rename</button><br/><br/>
      <label>Kick / Ban user by display name:</label><br/>
      <input id="kickName"/><br/>
      <button id="kickBtn" style="background:orange;">Kick</button>
      <button id="banBtn" style="background:red;">Ban</button><br/><br/>
      <label>Change Password (if type='password'):</label><br/>
      <input id="grpNewPass"/><br/>
      <button id="passBtn">Set Password</button><br/><br/>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  // watchers
  mo.querySelector("#renameBtn").onclick=()=>{
    let newN=mo.querySelector("#grpRename").value.trim();
    if(!newN) return;
    db.ref(`groupChats/${gid}/name`).set(newN);
    db.ref(`users/${myId}/chats/${gid}/name`).set(newN);
    showNotice("Renamed group to "+newN);
  };
  mo.querySelector("#kickBtn").onclick=()=>{
    let name=mo.querySelector("#kickName").value.trim();
    if(!name) return;
    // find device from displayNames
    db.ref("displayNames/"+name).once("value",(snap)=>{
      let dev = snap.val();
      if(!dev) { showNotice("No user named "+name); return; }
      // remove from members
      db.ref(`groupChats/${gid}/members/${dev}`).remove();
      db.ref(`users/${dev}/chats/${gid}`).remove();
      showNotice("Kicked user: "+name);
    });
  };
  mo.querySelector("#banBtn").onclick=()=>{
    let name=mo.querySelector("#kickName").value.trim();
    if(!name) return;
    db.ref("displayNames/"+name).once("value",(snap)=>{
      let dev=snap.val();
      if(!dev) { showNotice("No user named "+name); return; }
      db.ref(`groupChats/${gid}/members/${dev}`).remove();
      db.ref(`groupChats/${gid}/banned/${dev}`).set(true);
      db.ref(`users/${dev}/chats/${gid}`).remove();
      showNotice("Banned user: "+name);
    });
  };
  mo.querySelector("#passBtn").onclick=()=>{
    let newP=mo.querySelector("#grpNewPass").value.trim();
    db.ref(`groupChats/${gid}/password`).set(newP);
    showNotice("Set group password to "+newP);
  };
}

/* =============== Requests / Blocked Watchers =============== */
function loadRequests() {
  db.ref(`users/${myId}/requests`).on("value",(snap)=>{
    let data=snap.val()||{};
    let tab=document.getElementById("requestsTab");
    tab.innerHTML="";
    Object.keys(data).forEach(from=>{
      let di=document.createElement("div");
      di.className="requestItem";
      di.textContent=`${from} wants to chat. `;
      let accept=document.createElement("button");
      accept.textContent="✔"; accept.style.background="green";
      accept.onclick=()=>{
        if(blocked[from]) { showNotice("Unblock them first!"); return; }
        db.ref("displayNames/"+from).once("value",(sn2)=>{
          let dev=sn2.val();
          if(!dev) { showNotice("No user named "+from); return; }
          let cid=[myId,dev].sort().join("_");
          db.ref(`privateChats/${cid}`).once("value",(sn3)=>{
            if(!sn3.exists()) {
              db.ref(`privateChats/${cid}`).set({members:{[myId]:true,[dev]:true},createdAt:Date.now()});
            }
          });
          db.ref(`users/${myId}/chats/${cid}`).set({name:from,type:"private",last:Date.now()});
          db.ref(`users/${myId}/requests/${from}`).remove();
          db.ref(`users/${myId}/friends/${from}`).set(true);
          db.ref(`users/${dev}/friends/${displayName}`).set(true);
          db.ref(`users/${dev}/accepted/${displayName}`).set(true);
          db.ref(`privateChats/${cid}/messages`).push({
            sender:"_system",
            text:`${from} accepted your friend request!`,
            timestamp:Date.now(),
            reaction:"",
            readBy:{[dev]:Date.now()}
          });
          openChat(cid, from,"private");
        });
      };
      di.appendChild(accept);
      let deny=document.createElement("button");
      deny.textContent="✘"; deny.style.background="red";
      deny.onclick=()=> db.ref(`users/${myId}/requests/${from}`).remove();
      di.appendChild(deny);
      tab.appendChild(di);
    });
  });
  db.ref(`users/${myId}/requestsSent`).on("value",(snap2)=>{
    let st=document.getElementById("requestsSentTab");
    st.innerHTML="<strong>Requests Sent:</strong><br/>";
    let out=snap2.val()||{};
    Object.keys(out).forEach(n=>{
      let dv=document.createElement("div");
      dv.className="requestItem";
      dv.textContent=`(Pending) ${n} `;
      let c=document.createElement("button");
      c.textContent="Cancel";
      c.onclick=()=>{
        db.ref(`users/${myId}/requestsSent/${n}`).remove();
        db.ref("displayNames/"+n).once("value",(sn3)=>{
          let dev=sn3.val();
          if(dev) db.ref(`users/${dev}/requests/${displayName}`).remove();
        });
      };
      dv.appendChild(c);
      st.appendChild(dv);
    });
  });
  db.ref(`users/${myId}/accepted`).on("child_added",(sn4)=>{
    let who=sn4.key;
    showNotice(`${who} accepted your friend request!`);
    db.ref(`users/${myId}/requestsSent/${who}`).remove();
    db.ref("displayNames/"+who).once("value",(sn5)=>{
      let dev=sn5.val();
      if(!dev) return;
      let cid=[myId,dev].sort().join("_");
      db.ref(`privateChats/${cid}`).once("value",(sn6)=>{
        if(!sn6.exists()) db.ref(`privateChats/${cid}`).set({members:{[myId]:true,[dev]:true},createdAt:Date.now()});
      });
      db.ref(`users/${myId}/chats/${cid}`).set({name:who,type:"private",last:Date.now()});
    });
    setTimeout(()=> db.ref(`users/${myId}/accepted/${who}`).remove(),3000);
  });
}
function loadBlocked() {
  db.ref(`users/${myId}/blocked`).on("value",(snap)=>{
    blocked=snap.val()||{};
  });
}
function loadFriends() {
  db.ref(`users/${myId}/friends`).on("value",(snap)=>{
    friends=snap.val()||{};
  });
}

/* =============== Chat Watchers =============== */
function initChatWatchers() {
  db.ref(`users/${myId}/chats`).on("value",(snap)=>{
    let data=snap.val()||{};
    attachAllChatWatchers(data);
    debouncedUpdateChatListUI(data);
  });
}
function attachAllChatWatchers(chats) {
  Object.keys(chats).forEach(cid=>{
    if(cid==="help_chat") return;
    let info=chats[cid];
    let path=(info.type==="group"?"groupChats":"privateChats")+"/"+cid+"/messages";
    db.ref(path).off("child_added", handleMsg);
    db.ref(path).on("child_added", handleMsg);
    function handleMsg(s) {
      if(cid===currentChat) return;
      chatUnread[cid]=(chatUnread[cid]||0)+1;
      if(chats[cid]) chats[cid].last=s.val().timestamp;
      debouncedUpdateChatListUI(chats);
      debouncedUpdateTitle();
      // Play notif if not open
      if(currentChat!==cid && notifAudio) {
        notifAudio.play().catch(()=>{});
      }
    }
  });
}
function updateChatListUI(chats) {
  let arr=Object.entries(chats).sort((a,b)=>(b[1].last||0)-(a[1].last||0));
  let cl=document.getElementById("chatList");
  cl.innerHTML="";
  arr.forEach(([cid,info])=>{
    let dv=document.createElement("div");
    dv.className="chatItem";
    if(cid===currentChat) dv.classList.add("active");
    let nm=info.name||cid;
    if(info.type==="private" && blocked[nm]) nm+=" [Blocked]";
    if(info.type==="help") nm="Help (info)";
    dv.textContent=nm;
    let row=document.createElement("div");
    row.style.display="flex"; row.style.alignItems="center";
    if(chatUnread[cid]){
      let bd=document.createElement("span");
      bd.className="chatBadge";
      bd.textContent="+"+chatUnread[cid];
      row.appendChild(bd);
    }
    if(info.type!=="help") {
      let del=document.createElement("button");
      del.textContent="🗑";
      del.onclick=(ev)=>{
        ev.stopPropagation();
        confirmDeleteChat(cid,info);
      };
      row.appendChild(del);
    }
    dv.appendChild(row);
    dv.onclick=()=>openChat(cid,nm,info.type);
    cl.appendChild(dv);
  });
  debouncedUpdateTitle();
}
function confirmDeleteChat(cid, info) {
  if(info.type==="group") {
    db.ref(`groupChats/${cid}/createdBy`).once("value",(snap)=>{
      let own=snap.val();
      if(own!==myId) {
        showConfirm(`Leave group ${info.name}?`).then(ok=>{
          if(ok){
            db.ref(`groupChats/${cid}/members/${myId}`).remove();
            db.ref(`users/${myId}/chats/${cid}`).remove();
            showNotice("Left group chat.");
          }
        });
      } else {
        showConfirm(`Delete group ${info.name}?`).then(ok=>{
          if(ok){
            db.ref(`groupChats/${cid}`).remove();
            db.ref(`users/${myId}/chats/${cid}`).remove();
            showNotice("Group deleted for all.");
          }
        });
      }
    });
  } else {
    showConfirm(`Remove private chat with ${info.name}?`).then(ok=>{
      if(ok){
        db.ref(`users/${myId}/chats/${cid}`).remove();
        showNotice("Chat removed from your side.");
      }
    });
  }
}

/* =============== Open Chat =============== */
function openChat(cid, name, type) {
  currentChat=cid; currentType=type;
  chatUnread[cid]=0;
  debouncedUpdateTitle();
  if(type==="group") {
    document.getElementById("chatTitle").innerHTML=`<span>${name}</span> <span style="font-size:12px;">(Group)</span>`;
  } else if(type==="help") {
    document.getElementById("chatTitle").textContent="Help & Info";
  } else {
    document.getElementById("chatTitle").textContent=name;
  }
  let gm=document.getElementById("groupMembers");
  gm.style.display=(type==="group")?"block":"none";
  let inp=document.getElementById("msgInput");
  inp.disabled=(type==="help");
  let area=document.getElementById("messages");
  area.innerHTML="";
  document.getElementById("loadMoreBtn").style.display="none";
  if(messagesRef) {
    if(childAddedRef) messagesRef.off("child_added", childAddedRef);
    if(childChangedRef) messagesRef.off("child_changed", childChangedRef);
  }
  let path=(type==="group"?"groupChats":"privateChats")+"/"+cid+"/messages";
  messagesRef=db.ref(path);
  messagesRef.orderByChild("timestamp").limitToLast(100).once("value",(snap)=>{
    let data=snap.val()||{};
    let arr=Object.entries(data).sort((a,b)=>(a[1].timestamp||0)-(b[1].timestamp||0));
    if(arr.length>0) oldestStamp=arr[0][1].timestamp||Number.MAX_SAFE_INTEGER;
    else oldestStamp=Number.MAX_SAFE_INTEGER;
    arr.forEach(([mId,mVal])=>createBubble(mId,mVal,true));
    if(arr.length>=100) {
      hasMoreOld=true;
      document.getElementById("loadMoreBtn").style.display="block";
    } else hasMoreOld=false;
    childAddedRef=messagesRef.orderByChild("timestamp").startAt(Date.now()).on("child_added",(sn)=>{
      let v=sn.val();
      createBubble(sn.key,v,true);
      autoScroll();
      markMsgRead(sn.key,v);
    });
    childChangedRef=messagesRef.on("child_changed",(sn)=>updateBubble(sn.key,sn.val()));
    autoScroll();
    // Mark existing read
    arr.forEach(([mId,mVal])=>markMsgRead(mId,mVal));
  });
  if(type==="group") {
    db.ref(`groupChats/${cid}/members`).on("value",(snap)=>{
      let mm=snap.val()||{};
      let own=mm.owner||null;
      let others=Object.keys(mm).filter(uid=>uid!=="owner" && uid!==own);
      if(own===myId) {
        // show edit group button
        let btn=document.createElement("button");
        btn.textContent="Edit Group";
        btn.style.marginLeft="10px";
        btn.onclick=()=>openGroupEditPanel(cid);
        gm.innerHTML="";
        gm.appendChild(btn);
      } else gm.innerHTML="";
      if(own) {
        db.ref(`users/${own}/displayName`).once("value",(s)=>{
          let ownerName=s.val()||own;
          let str=`<span style='color:gold;font-weight:bold;'>${ownerName} (Owner)</span>`;
          Promise.all(others.map(uid=> db.ref(`users/${uid}/displayName`).once("value").then(x=> x.val()||uid)))
          .then(nms=>{
            nms.sort();
            nms.forEach(nn=> { str+=" • "+nn; });
            let sp=document.createElement("span");
            sp.innerHTML=str;
            gm.appendChild(sp);
          });
        });
      }
    });
  }
}

/* =============== Load Older =============== */
function loadOlderMessages() {
  if(!currentChat||!hasMoreOld) return;
  let btn=document.getElementById("loadMoreBtn");
  btn.disabled=true;
  messagesRef.orderByChild("timestamp").endAt(oldestStamp-1).limitToLast(50).once("value",(snap)=>{
    let data=snap.val()||{};
    let arr=Object.entries(data).sort((a,b)=>(a[1].timestamp||0)-(b[1].timestamp||0));
    if(arr.length<1) {
      showNotice("No older messages found!");
      hasMoreOld=false;
      btn.style.display="none";
      btn.disabled=false;
      return;
    }
    oldestStamp=arr[0][1].timestamp;
    arr.forEach(([mId,mVal])=>createBubble(mId,mVal,false));
    if(arr.length<50) {
      hasMoreOld=false;
      btn.style.display="none";
    }
    arr.forEach(([mId,mVal])=>markMsgRead(mId,mVal));
    btn.disabled=false;
  });
}

/* =============== Bubbles =============== */
function createBubble(mId, val, toEnd) {
  let area=document.getElementById("messages");
  if(document.getElementById("msg_"+mId)) return;
  let bubble=document.createElement("div");
  bubble.id="msg_"+mId;
  bubble.className="msg";
  if(val.sender===myId) bubble.classList.add("to");
  else if(val.sender==="_system") bubble.classList.add("console");
  else bubble.classList.add("from");
  let p=document.createElement("p");
  p.textContent=val.text||"";
  bubble.appendChild(p);
  let rt=document.createElement("span");
  rt.className="reactionTag";
  if(val.reaction) rt.textContent=val.reaction;
  bubble.appendChild(rt);
  let rBar=document.createElement("div");
  rBar.className="reactionBar";
  ["❤️","👍","👎","😂","😮","😢"].forEach(emo=>{
    let s=document.createElement("span");
    s.textContent=emo;
    s.onclick=(ev)=>{
      ev.stopPropagation();
      applyReaction(mId,emo);
      rBar.style.display="none";
    };
    rBar.appendChild(s);
  });
  bubble.appendChild(rBar);
  bubble.addEventListener("dblclick",(ev)=>{
    rBar.style.display=(rBar.style.display==="flex")?"none":"flex";
  });
  bubble.addEventListener("contextmenu",(ev)=>{
    ev.preventDefault();
    if(currentType==="group") {
      db.ref(`groupChats/${currentChat}/createdBy`).once("value",(sn)=>{
        if(sn.val()===myId) {
          showConfirm("Remove this message?").then(ok=>{
            if(ok) {
              db.ref(`groupChats/${currentChat}/messages/${mId}`).remove();
              let ex=document.getElementById("msg_"+mId);
              if(ex) ex.remove();
            }
          });
        }
      });
    }
  });
  let ts=document.createElement("div");
  ts.className="timestamp";
  let t=val.timestamp? new Date(val.timestamp).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}):"";
  ts.textContent=t;
  bubble.appendChild(ts);
  if(toEnd) area.appendChild(bubble);
  else area.prepend(bubble);
  setTimeout(()=> autoScroll(), 50);
}
function updateBubble(mId, val) {
  let b=document.getElementById("msg_"+mId);
  if(!b) return;
  let rt=b.querySelector(".reactionTag");
  if(rt) rt.textContent=val.reaction||"";
}
function markMsgRead(mId,val) {
  if(!currentChat||currentType==="help") return;
  let path=(currentType==="group"?"groupChats":"privateChats")+"/"+currentChat+"/messages/"+mId+"/readBy/"+myId;
  db.ref(path).set(Date.now());
}

/* =============== Auto-Scroll =============== */
function autoScroll() {
  let msgs=document.getElementById("messages");
  const nearBottom= msgs.scrollTop+msgs.clientHeight >= msgs.scrollHeight-50;
  if(nearBottom) msgs.scrollTop=msgs.scrollHeight;
}

/* =============== Typing + Emoji =============== */
function attachTypingListener() {
  if(!currentChat||currentType==="help") return;
  let path=(currentType==="group"?"groupChats":"privateChats")+"/"+currentChat+"/typing";
  db.ref(path).off();
  db.ref(path).on("value",(snap)=>{
    let val=snap.val();
    let t=document.getElementById("typingIndicator");
    if(val && val!==displayName) {
      t.style.display="block";
      t.textContent= val+" is typing...";
    } else t.style.display="none";
  });
}
function sendTyping() {
  if(!currentChat||currentType==="help") return;
  let path=(currentType==="group"?"groupChats":"privateChats")+"/"+currentChat+"/typing";
  db.ref(path).set(displayName);
  setTimeout(()=> db.ref(path).set(""),2000);
}
function toggleEmojiPicker() {
  let ep=document.getElementById("emojiPicker");
  ep.style.display=(ep.style.display==="flex")?"none":"flex";
  if(ep.style.display==="flex") {
    ep.innerHTML="";
    ep.style.flexWrap="wrap";
    let bigSet=[... "😀😃😄😁😆😅😂🤣😉😊😎😍😘😗😙😚😋😜😝😛🤑🤨🧐🤓😳😏😒😞😔😟😕🙁☹️😣😖😫😩😢😭😤😠😡🤬😶😐😑🙄😯😦😧😮😲🤯😳🥵🥶😱😨😰😥😓🤗🤔🤭🤫🤥😶😐😑😯😧😮😲🥱😴😪😵🤐🥴🤢🤮🤧😇😈👿🤡👻💀👽🤖😺😸😹😻😼😽🙀😿😾"];
    bigSet.forEach(em=>{
      let s=document.createElement("span");
      s.textContent=em;
      s.onclick=()=>{
        let inp=document.getElementById("msgInput");
        inp.value+=em;
        ep.style.display="none";
      };
      ep.appendChild(s);
    });
  }
}

/* =============== Slash Autocomplete =============== */
function slashAutoInput(e) {
  let val=e.target.value;
  let sc=document.getElementById("slashAutocomplete");
  if(!val.startsWith("/")) { sc.style.display="none"; return; }
  sc.innerHTML="";
  let rect=e.target.getBoundingClientRect();
  sc.style.left= (rect.left)+"px";
  sc.style.top= (rect.top - 115)+"px";
  let hits=slashCmds.filter(c=> c.startsWith(val));
  if(!hits.length){ sc.style.display="none"; return; }
  hits.slice(0,8).forEach(h=>{
    let b=document.createElement("button");
    b.textContent=h;
    b.onclick=()=>{
      e.target.value=h+" ";
      sc.style.display="none";
    };
    sc.appendChild(b);
  });
  sc.style.display="block";
}

/* =============== Send & Process Slash =============== */
function canSendMessage() {
  let now=Date.now();
  if(now-lastMessageTime<500) {
    showNotice("Wait 0.5s between messages.");
    return false;
  }
  lastMessageTime=now;
  return true;
}
function sendMessage() {
  if(!currentChat||currentType==="help") return;
  if(!canSendMessage()) return;
  let inp=document.getElementById("msgInput");
  let txt=inp.value.trim();
  if(!txt) return;
  document.getElementById("slashAutocomplete").style.display="none";
  if(txt.startsWith("/")) {
    processSlashCommand(txt);
    inp.value="";
    return;
  }
  let path=(currentType==="group"?"groupChats":"privateChats")+"/"+currentChat+"/messages";
  db.ref(path).push({
    sender:myId,
    text:txt,
    timestamp:Date.now(),
    reaction:"",
    readBy:{ [myId]:Date.now() }
  });
  inp.value="";
  setTimeout(()=> autoScroll(),50);
  sendTyping();
}
function processSlashCommand(cmd) {
  let parts=cmd.split(" ");
  let slash=parts[0].toLowerCase();
  if(slash==="/roll") {
    let sides=parseInt(parts[1],10)||6;
    let r=Math.floor(Math.random()*sides)+1;
    sendSystemMessage(`🎲 Rolled a ${sides}-sided die: ${r}`);
  }
  else if(slash==="/ping") {
    let t0=Date.now();
    db.ref("pingTest").set({time:t0},()=>{
      let dt=Date.now()-t0;
      sendSystemMessage(`Ping: ${dt}ms`);
    });
  }
  else if(slash==="/8ball") {
    let q=cmd.slice(7).trim();
    if(!q) { showNotice("Usage: /8ball [question]"); return; }
    let answers=["Yes","No","Maybe","Ask again later","Definitely","Certainly not"];
    let pick=answers[Math.floor(Math.random()*answers.length)];
    sendSystemMessage(`8ball: ${pick}`);
  }
  else if(slash==="/roast") {
    let roasts=[
      "Your code has more bugs than a beehive.",
      "You're slower than dial-up internet.",
      "At least your chat is entertaining."
    ];
    let pick=roasts[Math.floor(Math.random()*roasts.length)];
    sendSystemMessage(`Roast: ${pick}`);
  }
  else if(slash==="/tod") {
    if(parts[1]==="truth") {
      let truths=["What's your biggest fear?","Have you ever lied to your best friend?","What's your most embarrassing moment?"];
      let pick=truths[Math.floor(Math.random()*truths.length)];
      sendSystemMessage(`Truth: ${pick}`);
    } else if(parts[1]==="dare") {
      let dares=["Dance like a robot for 15 seconds.","Talk in a baby voice for 3 messages.","Pretend you're an alien for 10 seconds."];
      let pick=dares[Math.floor(Math.random()*dares.length)];
      sendSystemMessage(`Dare: ${pick}`);
    } else showNotice("Usage: /tod truth or /tod dare");
  }
  else if(slash==="/title") {
    let text=parts.slice(1).join(" ");
    if(!text) { showNotice("Usage: /title something"); return; }
    sendSystemMessage(`<< ${text} >>`);
  }
  else if(slash==="/cf"|| slash==="/coin") {
    let guess="";
    if(slash==="/cf") guess=parts[1]||"";
    else if(parts[1]==="flip") guess=parts[2]||"";
    guess=guess.toLowerCase();
    if(guess!=="heads"&& guess!=="tails") { showNotice("Usage: /cf heads or /coin flip tails"); return; }
    let side=Math.random()<0.5?"heads":"tails";
    sendSystemMessage(`Coinflip: ${side} => you chose ${guess} => ${side===guess?"You win!":"You lose."}`);
  }
  else if(slash==="/ship") {
    let n=parts[1]||"";
    if(!n) { showNotice("Usage: /ship [name]"); return; }
    let half=Math.floor(displayName.length/2);
    let half2=Math.floor(n.length/2);
    let merged= displayName.slice(0,half)+ n.slice(half2);
    sendSystemMessage(`Ship: ${displayName} + ${n} => ${merged} 💘`);
  }
  else if(slash==="/rps") {
    sendSystemMessage(`[RPS] ${displayName} played rock (placeholder)`);
  }
  else if(slash==="/guessnumber") {
    sendSystemMessage(`[GuessNumber] Range 1-10, waiting for guess... (placeholder)`);
  }
  else if(slash==="/vote") {
    let rest=cmd.slice(slash.length).trim();
    let ps=rest.split("|").map(x=>x.trim());
    if(ps.length<2) { showNotice("Usage: /vote question|opt1|opt2"); return; }
    let q=ps[0];
    let opts=ps.slice(1);
    let out=`Vote: ${q}\n`;
    opts.forEach(o=> out+="- "+o+"\n");
    sendSystemMessage(out);
  }
  else {
    showNotice("Unknown slash command: "+cmd);
  }
}
function sendSystemMessage(txt) {
  if(!currentChat||currentType==="help") return;
  let path=(currentType==="group"?"groupChats":"privateChats")+"/"+currentChat+"/messages";
  db.ref(path).push({
    sender:"_system",
    text:txt,
    timestamp:Date.now(),
    reaction:"",
    readBy:{[myId]:Date.now()}
  });
}
</script>

<!-- ===== Notification Container ===== -->
<div id="notificationContainer"></div>
<audio id="notifSound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YRAAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" preload="auto"></audio>

<!-- ===== Login UI ===== -->
<div id="login" style="display:flex;">
  <div style="background:var(--chat-bg);padding:20px;border-radius:10px;position:relative;">
    <h2>Static Live Chat</h2>
    <label>Display Name (unique):</label><br/>
    <input id="username" placeholder="Name" onkeypress="if(event.key==='Enter')doLogin()"/><br/>
    <label>Password (optional):</label><br/>
    <div style="display:flex;">
      <input id="password" type="password" style="flex:1;" onkeypress="if(event.key==='Enter')doLogin()"/>
      <button onclick="toggleLoginPass()">👁️</button>
    </div>
    <button onclick="doLogin()">Log In</button>
  </div>
</div>

<!-- ===== Main App UI ===== -->
<div id="app" style="display:none;">
  <div id="sidebar">
    <button onclick="openFriendsPanel()">Friends</button>
    <button onclick="addFriendUI()">Add Friend</button>
    <button onclick="showAddChatPanel()">Add Chat</button>
    <h3>Friend Requests</h3>
    <div id="requestsTab"></div>
    <div id="requestsSentTab" style="margin-top:8px;color:#ccc;"></div>
    <hr/>
    <h3>Chats</h3>
    <div id="chatList"></div>
  </div>
  <div id="chatPanel">
    <div id="topBar">
      <div id="chatTitle">No Chat</div>
      <div class="top-right">
        <button id="themeBtn" onclick="toggleTheme()">Dark: Theme</button>
        <button onclick="openSettings()">⚙️ Settings</button>
      </div>
    </div>
    <div id="groupMembers" style="padding:5px 15px; display:none; font-size:14px;"></div>
    <button id="loadMoreBtn" style="display:none;" onclick="loadOlderMessages()">Load Older</button>
    <div id="messages"></div>
    <div id="typingIndicator" style="display:none;"></div>
    <div id="inputArea">
      <input id="msgInput" placeholder="Type '/' for commands" oninput="slashAutoInput(event)" onkeypress="if(event.key==='Enter'){ sendMessage(); sendTyping(); }"/>
      <button onclick="toggleEmojiPicker()">😀</button>
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="emojiPicker"></div>
    <div id="slashAutocomplete"></div>
  </div>
</div>

<!-- ===== Static Menu ===== -->
<div id="staticMenu">
  <a href="https://sites.google.com/view/staticquasar931" target="_blank" class="staticLink">More Unblocked Games by Static</a>
</div>
</body>
</html>
