<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <!-- Title or Favicon (if desired) -->
  <!-- <title>My Awesome Chat</title>
  <link rel="icon" href="myfavicon.ico" type="image/x-icon"/> -->
  <title>Static Live Chat – Device-based with Commands</title>
  <style>
    :root {
      --bg-color:#111; --text-color:#fff; --sidebar-color:#1c1c1c;
      --chat-bg:#222; --bubble-me:#1e90ff; --bubble-them:#444;
      --accent:#1e90ff; --badge:red; --chat-item-bg:#333;
    }
    body.light {
      --bg-color:#f4f4f4; --text-color:#000; --sidebar-color:#ddd;
      --chat-bg:#eee; --bubble-me:#007aff; --bubble-them:#ccc;
      --accent:#007acc; --chat-item-bg:#bbb;
    }
    body.blue {
      --bg-color:#0b1622; --text-color:#f0f8ff; --sidebar-color:#132336;
      --chat-bg:#1e2d40; --bubble-me:#1f65ff; --bubble-them:#41546a;
      --accent:#389fff; --chat-item-bg:#2e3d52;
    }
    body.green {
      --bg-color:#102a10; --text-color:#e8ffe8; --sidebar-color:#224522;
      --chat-bg:#1a331a; --bubble-me:#28a745; --bubble-them:#375a37;
      --accent:#4caf50; --chat-item-bg:#2b442b;
    }
    body.pink {
      --bg-color:#331024; --text-color:#ffe0f0; --sidebar-color:#441533;
      --chat-bg:#551a44; --bubble-me:#ff3377; --bubble-them:#773355;
      --accent:#ff66a2; --chat-item-bg:#442244;
    }
    body {
      margin:0; font-family:Arial,sans-serif;
      background:var(--bg-color); color:var(--text-color);
      height:100vh; display:flex; flex-direction:column; overflow:hidden;
    }
    input, button {
      padding:10px; font-size:16px; margin:5px;
      border-radius:6px; border:none;
    }
    button { background:var(--accent); color:#fff; cursor:pointer; }

    #app { display:flex; flex:1; height:100%; }
    #sidebar {
      width:280px; background:var(--sidebar-color);
      display:flex; flex-direction:column; padding:10px; overflow-y:auto;
    }
    #chatPanel {
      flex:1; display:flex; flex-direction:column; background:var(--chat-bg);
      position:relative;
    }
    #topBar {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; font-size:18px; background:var(--chat-bg);
    }
    #messages {
      flex:1; display:flex; flex-direction:column; padding:15px; overflow-y:auto;
    }
    .msg {
      max-width:70%; padding:12px 16px; margin:6px auto;
      border-radius:20px; font-size:17px; line-height:1.4; word-wrap:break-word;
      position:relative; cursor:pointer;
    }
    .me {
      align-self:flex-end; background:var(--bubble-me); color:#fff; margin-left:auto;
      border-bottom-right-radius:5px;
    }
    .them {
      align-self:flex-start; background:var(--bubble-them); color:#fff; margin-right:auto;
      border-bottom-left-radius:5px;
    }
    .centerSys {
      align-self:center; background:rgba(255,255,255,0.2);
      font-style:italic; text-align:center;
      margin-left:auto; margin-right:auto; max-width:none !important; width:auto;
    }
    .reactionTag {
      font-size:14px; opacity:0.8; position:absolute; top:5px; right:10px;
    }
    .reactionBar {
      position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
      display:none; flex-direction:row; gap:5px; background:rgba(0,0,0,0.6);
      padding:5px; border-radius:6px; margin-bottom:5px;
    }
    .reactionBar span { font-size:22px; cursor:pointer; }
    .timestamp {
      position:absolute; font-size:10px; opacity:0.7; bottom:-14px;
    }
    .mineTime { right:10px; }
    .otherTime { left:10px; }
    .readReceipt {
      font-size:12px; opacity:0.6; margin-top:2px;
    }
    #typingIndicator {
      display:none; font-style:italic; font-size:14px; margin:0 20px 10px;
    }
    #inputArea {
      display:flex; padding:10px; background:var(--sidebar-color);
    }
    #inputArea input { flex:1; margin-right:5px; font-size:17px; }
    #emojiPicker {
      display:none; position:absolute; bottom:70px; right:15px; background:var(--chat-bg);
      padding:10px; flex-wrap:wrap; z-index:99; max-width:340px; max-height:180px; overflow:auto;
    }
    #emojiPicker span { font-size:22px; margin:6px; cursor:pointer; }
    .chatItem {
      background:var(--chat-item-bg); padding:10px; border-radius:6px; margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:center;
      cursor:pointer; transition:background 0.2s;
    }
    .chatItem:hover { background:var(--bubble-them); }
    .chatItem.active { outline:2px solid var(--accent); }
    .chatBadge {
      background:var(--badge); color:#fff; font-size:12px; padding:3px 8px; border-radius:12px; margin-left:5px;
    }
    .requestItem {
      background:var(--bubble-them); padding:10px; margin-bottom:5px; border-radius:6px;
    }
    #staticMenu {
      position:fixed; bottom:10px; left:10px; background:#1e1e1e; color:#fff; padding:5px 8px;
      border-radius:8px; font-size:13px; box-shadow:0 0 6px #0ff; animation:blink 2s infinite; z-index:1000;
    }
    a.staticLink { color:#0ff; text-decoration:none; }

    @keyframes blink {
      0%,100% { opacity:1; }
      50% { opacity:0.6; }
    }
    .modal {
      position:fixed; inset:0; background:rgba(0,0,0,0.7);
      display:none; flex-direction:column; align-items:center; justify-content:center; z-index:999;
    }
    .modalContent {
      background:var(--chat-bg); padding:20px; border-radius:10px; max-width:400px; position:relative;
    }
    .closeBtn {
      position:absolute; top:10px; right:10px; background:red; color:#fff; border:none; cursor:pointer;
      border-radius:4px; padding:3px 8px;
    }
    #login {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.7); z-index:999;
    }
    /* Slash command autocomplete on / press */
    #slashAutocomplete {
      display:none; position:absolute; bottom:120px; left:20px; z-index:101;
      background:var(--chat-bg); padding:8px; border-radius:6px; max-width:250px;
    }
    #slashAutocomplete button {
      display:block; width:100%; text-align:left; padding:5px;
      background:var(--accent); margin-bottom:5px; border:none; border-radius:4px;
    }
  </style>
</head>
<body>
<script>
// =============== Device ID & Display Name Setup =================
function genDeviceId(){
  return "dev_"+Math.random().toString(36).slice(2)+"_"+Date.now();
}
let myId=localStorage.getItem("myDeviceId");
if(!myId){
  myId=genDeviceId();
  localStorage.setItem("myDeviceId",myId);
}
let displayName=localStorage.getItem("displayName")||"";
let pass=localStorage.getItem("pass")||"";

// ============ Slash Commands Data =============
const bigTruthsQueue=[
  "What is your biggest secret crush?",
  "Have you ever cheated on a test?",
  "What’s the most embarrassing thing you’ve done in public?",
  "Have you ever lied to get out of trouble?",
  "What’s the strangest dream you’ve ever had?",
  "If you could be invisible for a day, what’s the first thing you’d do?",
  "What’s a silly fear you have?",
  "Have you ever broken the law?",
  "What’s your worst habit?",
  "Have you ever pretended to like a gift you hated?",
  "What’s your guilty pleasure movie or show?",
  "Have you ever stolen anything?",
  "What’s the meanest thing you’ve said to someone?",
  "If you had one wish, what would it be?",
  "What’s the last thing you searched for on your phone?",
  "Have you ever faked being sick to skip something?",
  "Who is your secret role model?",
  "What’s your silliest nickname?",
  "What’s something you’re really bad at?",
  "What’s your biggest pet peeve?",
  "What’s the weirdest food combo you love?",
  "Have you ever stalked someone on social media?",
  "Who was your first crush?",
  "What’s one thing you’d change about your family?"
  // etc. Enough so we won't repeat quickly
];
const bigDaresQueue=[
  "Do a silly dance for 20 seconds.",
  "Text someone random ‘I love cheese!’",
  "Talk in a weird accent for your next 3 sentences.",
  "Let someone else post on your social media (or pretend).",
  "Attempt to stand on one foot for 60 seconds.",
  "Call a friend and sing them a random song snippet.",
  "Spin around 10 times and then walk in a straight line.",
  "Act like a monkey for 30 seconds.",
  "Pretend you’re an alien for 1 minute.",
  "Do 5 push-ups, 5 jumping jacks, 5 sit-ups right now.",
  "Pretend to open an invisible umbrella and walk around.",
  "Eat a spoonful of a weird food combo (or pretend).",
  "Try to mimic the voice of someone in the room (or yourself?).",
  "Say the alphabet backwards as fast as you can.",
  "Balance a random object on your head for 1 min.",
  "Try to lick your elbow on cam.",
  "Wear a piece of clothing backwards for the rest of the game.",
  "Speak only in rhyme until your next turn.",
  "Pretend to cry like a baby for 10 seconds.",
  "Do a dramatic reading of your most recent text message."
  // etc
];

// We shuffle them once, then after picking an item, we push it to back
function shuffleArray(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()* (i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}
shuffleArray(bigTruthsQueue);
shuffleArray(bigDaresQueue);

function getNextTruth(){
  const item=bigTruthsQueue.shift();
  bigTruthsQueue.push(item);
  return item;
}
function getNextDare(){
  const item=bigDaresQueue.shift();
  bigDaresQueue.push(item);
  return item;
}

// ============== Firebase init ================
const firebaseConfig={
  apiKey:"AIzaSyBO7EHU4-_b2NHf7UFYTB8Wolv73Z0P8Fw",
  authDomain:"static-live-chatting.firebaseapp.com",
  databaseURL:"https://static-live-chatting-default-rtdb.firebaseio.com",
  projectId:"static-live-chatting",
  storageBucket:"static-live-chatting.appspot.com",
  messagingSenderId:"578562140653",
  appId:"1:578562140653:web:c12df07155627083e9dfe4"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// ================ Login Flow =================
function checkNameAvailable(name, deviceId, cb){
  // check if /displayNames/{name} is used by another deviceId
  db.ref("displayNames/"+name).once("value",(snap)=>{
    const val=snap.val();
    if(!val) cb(true,null);
    else if(val===deviceId) cb(true,val); // it’s your old name
    else cb(false,val); // someone else has that name
  });
}
function doLogin(){
  const dName=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value.trim();
  if(!dName)return;
  checkNameAvailable(dName,myId,(ok,existing)=>{
    if(!ok && existing!==myId){
      showNotice("That display name is taken by another device. Try something else.");
      return;
    }
    displayName=dName; pass=p;
    localStorage.setItem("displayName",dName);
    localStorage.setItem("pass",p);
    db.ref("displayNames/"+dName).set(myId);
    db.ref("users/"+myId+"/displayName").set(dName);
    startApp();
  });
}

function startApp(){
  document.getElementById("login").style.display="none";
  document.getElementById("app").style.display="flex";
  applyTheme();
  loadBlocked();
  loadFriends();
  loadChats();
  loadRequests();
  setupHelpChat();
  document.getElementById("slashAutocomplete").style.display="none";
  showNotice(`Logged in as [${myId}] name: ${displayName}`);
}

//** Basic confirm + notice popups
function showConfirm(msg, yesCb){
  const mo=document.createElement("div");
  mo.style.position="fixed";
  mo.style.inset=0;
  mo.style.background="rgba(0,0,0,0.7)";
  mo.style.display="flex";
  mo.style.flexDirection="column";
  mo.style.justifyContent="center";
  mo.style.alignItems="center";
  mo.style.zIndex=999;
  mo.innerHTML=`
    <div style="background:var(--chat-bg);padding:20px;border-radius:10px;max-width:400px;position:relative;">
      <h3>Confirm</h3>
      <p>${msg}</p>
      <div style="text-align:center;">
        <button style="background:green;" id="yesBtn">Yes</button>
        <button style="background:red;" id="noBtn">No</button>
      </div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.querySelector("#yesBtn").onclick=()=>{
    document.body.removeChild(mo);
    yesCb();
  };
  mo.querySelector("#noBtn").onclick=()=>{
    document.body.removeChild(mo);
  };
}
function showNotice(msg){
  const mo=document.createElement("div");
  mo.style.position="fixed";
  mo.style.inset=0;
  mo.style.background="rgba(0,0,0,0.7)";
  mo.style.display="flex";
  mo.style.flexDirection="column";
  mo.style.justifyContent="center";
  mo.style.alignItems="center";
  mo.style.zIndex=999;
  mo.innerHTML=`
    <div style="background:var(--chat-bg);padding:20px;border-radius:10px;max-width:400px;position:relative;">
      <h3>Notice</h3>
      <p>${msg}</p>
      <div style="text-align:center;">
        <button style="background:var(--accent);" id="okBtn">OK</button>
      </div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.querySelector("#okBtn").onclick=()=>{
    document.body.removeChild(mo);
  };
}

//** "Help" Chat
function setupHelpChat(){
  db.ref(`users/${myId}/chats/help_chat`).set({
    name:"Help (info)", type:"help", last:0
  });
}

function openHelpChat(){
  currentChat="help_chat"; currentType="help";
  highlightChat("help_chat");
  document.getElementById("chatTitle").textContent="Help & Info";
  document.getElementById("groupMembers").style.display="none";
  const msgs=document.getElementById("messages");
  msgs.innerHTML="";
  // Big help msg
  const bigM=document.createElement("div");
  bigM.className="msg centerSys";
  bigM.innerHTML=`
    <strong>HELP & INFO</strong><br/>
    <em>All the game tips, commands, and updates can be displayed here</em><br/>
    <br/>
    <u>Slash Commands</u><br/>
    /tod truth — random truth question<br/>
    /tod dare — random dare<br/>
    /title text — center system text<br/>
    /cf heads or /cf tails — quick coin flip guess<br/>
    /coin flip heads or /coin flip tails — same coin flip<br/>
    <br/>
    <u>Latest Updates</u><br/>
    - Reactions pinned top-right<br/>
    - Slash command autocomplete<br/>
    - Big T/D queues to avoid repeats<br/>
    - And more...
  `;
  msgs.appendChild(bigM);
  // disable input area
  document.getElementById("msgInput").disabled=true;
}

//** load watchers for user
function loadBlocked(){
  db.ref(`users/${myId}/blocked`).on("value",(snap)=>{
    blocked=snap.val()||{};
  });
}
function loadFriends(){
  db.ref(`users/${myId}/friends`).on("value",(snap)=>{
    friends=snap.val()||{};
  });
}
function loadChats(){
  db.ref(`users/${myId}/chats`).on("value",(snap)=>{
    const data=snap.val()||{};
    // push help_chat to bottom
    const sorted=Object.entries(data).sort((a,b)=>{
      if(a[0]==="help_chat") return 1;
      if(b[0]==="help_chat") return -1;
      return (b[1].last||0)-(a[1].last||0);
    });
    const cList=document.getElementById("chatList");
    cList.innerHTML="";
    sorted.forEach(([id,info])=>{
      const div=document.createElement("div");
      div.className="chatItem";
      if(id===currentChat) div.classList.add("active");
      let nm=info.name||id;
      if(info.type==="private" && blocked[nm]) nm+=" [Blocked]";
      if(info.type==="help") nm="Help (info)";
      div.textContent=nm;
      // unread badge
      const rowRight=document.createElement("div");
      rowRight.style.display="flex"; rowRight.style.alignItems="center";
      if(chatUnread[id]){
        const bd=document.createElement("span");
        bd.className="chatBadge";
        bd.textContent="+"+chatUnread[id];
        rowRight.appendChild(bd);
      }
      // can’t delete help
      if(info.type!=="help"){
        const delBtn=document.createElement("button");
        delBtn.textContent="🗑";
        delBtn.onclick=(ev)=>{
          ev.stopPropagation();
          confirmDeleteChat(id,info);
        };
        rowRight.appendChild(delBtn);
      }
      div.appendChild(rowRight);
      div.onclick=()=>{
        if(info.type==="help"){
          openHelpChat();
        } else {
          openChat(id,nm,info.type);
        }
      };
      cList.appendChild(div);
    });
  });
}
function loadRequests(){
  db.ref(`users/${myId}/requests`).on("value",(snap)=>{
    const data=snap.val()||{};
    const tab=document.getElementById("requestsTab");
    tab.innerHTML="";
    Object.keys(data).forEach(fromId=>{
      const item=document.createElement("div");
      item.className="requestItem";
      item.textContent=`${fromId} wants to chat. `;
      const accept=document.createElement("button");
      accept.textContent="✔";
      accept.style.background="green";
      accept.onclick=()=>{
        if(blocked[fromId]){ showNotice("Blocked. Unblock first."); return; }
        const cid=[myId,fromId].sort().join("_");
        db.ref(`privateChats/${cid}`).set({});
        db.ref(`users/${myId}/chats/${cid}`).set({name:fromId,type:"private",last:Date.now()});
        db.ref(`users/${myId}/requests/${fromId}`).remove();
        db.ref(`users/${myId}/friends/${fromId}`).set(true);
        db.ref(`users/${fromId}/friends/${myId}`).set(true);
        db.ref(`users/${fromId}/requestsSent/${myId}`).once("value",(s2)=>{
          if(s2.exists()){
            db.ref(`users/${fromId}/requestsSent/${myId}`).remove();
            db.ref(`users/${fromId}/accepted/${myId}`).set(true);
            setTimeout(()=>db.ref(`users/${fromId}/accepted/${myId}`).remove(),3000);
          }
        });
        openChat(cid, fromId, "private");
      };
      item.appendChild(accept);
      const deny=document.createElement("button");
      deny.textContent="✘";
      deny.style.background="red";
      deny.onclick=()=> db.ref(`users/${myId}/requests/${fromId}`).remove();
      item.appendChild(deny);
      tab.appendChild(item);
    });
  });
  db.ref(`users/${myId}/requestsSent`).on("value",(snap2)=>{
    const outData=snap2.val()||{};
    const st=document.getElementById("requestsSentTab");
    st.innerHTML="<strong>Requests Sent:</strong><br/>";
    Object.keys(outData).forEach(tg=>{
      const di=document.createElement("div");
      di.className="requestItem";
      di.textContent=`(Pending) ${tg} `;
      const c=document.createElement("button");
      c.textContent="Cancel";
      c.onclick=()=>{
        db.ref(`users/${myId}/requestsSent/${tg}`).remove();
        db.ref(`users/${tg}/requests/${myId}`).remove();
      };
      di.appendChild(c);
      st.appendChild(di);
    });
  });
  db.ref(`users/${myId}/accepted`).on("child_added",(s)=>{
    const who=s.key;
    showNotice(`${who} accepted your request!`);
    db.ref(`users/${myId}/requestsSent/${who}`).remove();
    const cid=[myId,who].sort().join("_");
    db.ref(`privateChats/${cid}`).once("value",(sn)=>{
      if(!sn.exists()) db.ref(`privateChats/${cid}`).set({});
    });
    db.ref(`users/${myId}/chats/${cid}`).set({name:who,type:"private",last:Date.now()});
    setTimeout(()=>db.ref(`users/${myId}/accepted/${who}`).remove(),3000);
  });
}
function confirmDeleteChat(chatId,info){
  if(info.type==="group"){
    db.ref(`groupChats/${chatId}/createdBy`).once("value",(snap)=>{
      const c=snap.val();
      if(c!==myId){
        showConfirm(`Leave group ${info.name}?`,()=>{
          db.ref(`groupChats/${chatId}/members/${myId}`).remove();
          db.ref(`users/${myId}/chats/${chatId}`).remove();
          showNotice("Left group chat.");
        });
      } else {
        showConfirm(`Delete group ${info.name}?`,()=>{
          db.ref(`groupChats/${chatId}`).remove();
          db.ref(`users/${myId}/chats/${chatId}`).remove();
          showNotice("Group chat deleted for all!");
        });
      }
    });
  } else {
    showConfirm(`Remove private chat with ${info.name}?`,()=>{
      db.ref(`users/${myId}/chats/${chatId}`).remove();
      showNotice("Private chat removed from your device list.");
    });
  }
}

//** open chat watchers
let messagesRef=null; let childAddedRef=null; let childChangedRef=null;
function openChat(cid, name, type){
  currentChat=cid; currentType=type;
  highlightChat(cid);
  document.getElementById("chatTitle").textContent=name;
  document.getElementById("groupMembers").style.display=(type==="group")?"block":"none";
  // re-enable input if was disabled (in help)
  document.getElementById("msgInput").disabled=false;
  // reset unread
  chatUnread[cid]=0; 
  // clear watchers
  if(messagesRef){
    if(childAddedRef) messagesRef.off("child_added", childAddedRef);
    if(childChangedRef) messagesRef.off("child_changed", childChangedRef);
  }
  const msgArea=document.getElementById("messages");
  msgArea.innerHTML="";
  oldestKey=null; hasMoreOld=true;
  messagesRef=db.ref(`${(type==="group"?"groupChats":"privateChats")}/${cid}/messages`);
  fetchLatestMessages();
  db.ref(`users/${myId}/chats/${cid}/last`).set(Date.now());
  if(type==="group"){
    db.ref(`groupChats/${cid}/members`).on("value",(snap)=>{
      const mm=Object.keys(snap.val()||{});
      document.getElementById("groupMembers").textContent="Members: "+mm.join(", ");
    });
  }
  attachTypingListener();
}
function fetchLatestMessages(){
  messagesRef.orderByChild("timestamp").limitToLast(50).once("value",(snap)=>{
    const data=snap.val()||{};
    let arr=Object.entries(data).sort((a,b)=> (a[1].timestamp||0)-(b[1].timestamp||0));
    arr.forEach(([mId,mVal])=> createBubble(mId,mVal,true));
    if(arr.length>0) oldestKey=arr[0][0]; // earliest is the first
    if(arr.length>=50) document.getElementById("loadMoreBtn").style.display="inline";
    else hasMoreOld=false;
    attachChildWatchers();
  });
}
function attachChildWatchers(){
  childAddedRef=messagesRef.orderByChild("timestamp").startAt(Date.now()).on("child_added",(snap)=>{
    // new message
    const val=snap.val();
    createBubble(snap.key,val,true);
    markReadIfInThisChat([snap.key]);
    if(val.sender!==myId && document.hidden){
      // user is in another tab => increment unread?
      chatUnread[currentChat]=(chatUnread[currentChat]||0)+1;
      loadChats(); // refresh UI
    }
    if(val.sender!==myId && Notification.permission==="granted"){
      new Notification("New Msg",{body:`${val.sender}: ${val.text.slice(0,50)}`});
    }
  });
  childChangedRef=messagesRef.on("child_changed",(snap)=>{
    const val=snap.val();
    updateBubble(snap.key,val);
  });
}
function loadOlderMessages(){
  if(!oldestKey||!hasMoreOld) return;
  const loadBtn=document.getElementById("loadMoreBtn");
  loadBtn.disabled=true;
  messagesRef.orderByChild("timestamp").endAt(Date.now()).limitToLast(51).once("value",(snap)=>{
    const data=snap.val()||{};
    let arr=Object.entries(data).sort((a,b)=>(a[1].timestamp||0)-(b[1].timestamp||0));
    if(arr.length<=1){
      hasMoreOld=false;
      loadBtn.style.display="none";
    } else {
      // skip the last if it's the earliest we already have
      // we won't implement a perfect approach, but let's do a simpler approach
      arr.forEach(([mId,mVal])=> createBubble(mId,mVal,false));
    }
    loadBtn.disabled=false;
  });
}
function createBubble(mId, val, toBottom){
  // create msg bubble
  const container=document.getElementById("messages");
  if(document.getElementById("msg_"+mId)) return;
  let bubble=document.createElement("div");
  bubble.id="msg_"+mId;
  bubble.className="msg";
  if(val.sender===myId) bubble.classList.add("me");
  else if(val.sender==="_system") bubble.classList.add("centerSys");
  else bubble.classList.add("them");

  let text=val.text||"";
  bubble.innerHTML=text;
  // reaction top-right
  const rt=document.createElement("span");
  rt.className="reactionTag";
  if(val.reaction) rt.textContent=val.reaction;
  bubble.appendChild(rt);

  // reaction bar
  const rBar=document.createElement("div");
  rBar.className="reactionBar";
  ["❤️","👍","😂","😮","😢"].forEach(sy=>{
    const s=document.createElement("span");
    s.textContent=sy;
    s.onclick=(ev)=>{
      ev.stopPropagation();
      applyReaction(mId, sy);
      rBar.style.display="none";
    };
    rBar.appendChild(s);
  });
  bubble.appendChild(rBar);

  if(val.sender!==myId && val.sender!=="_system"){
    // color label if group
    if(currentType==="group"){
      const cClass=getColorClass(val.sender);
      bubble.innerHTML=`<span style="font-weight:bold;" class="${cClass}">${val.sender}:</span> `+bubble.innerHTML;
    }
  }
  bubble.addEventListener("dblclick", ev=>{
    rBar.style.display=(rBar.style.display==="flex")?"none":"flex";
  });
  bubble.addEventListener("contextmenu", e=>{
    e.preventDefault();
    if(currentType==="group"){
      db.ref(`groupChats/${currentChat}/createdBy`).once("value",(snap)=>{
        if(snap.val()===myId){
          showConfirm("Remove this message?",()=>{
            db.ref(`groupChats/${currentChat}/messages/${mId}`).remove();
            let el=document.getElementById("msg_"+mId);
            if(el) el.remove();
          });
        }
      });
    }
  });

  // timestamp
  const ts=document.createElement("div");
  ts.className="timestamp";
  let t= val.timestamp? new Date(val.timestamp).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}): "";
  ts.textContent=t;
  bubble.appendChild(ts);
  if(val.sender===myId) ts.classList.add("mineTime");
  else ts.classList.add("otherTime");

  // read receipts
  if(currentType==="group"){
    if(val.readBy){
      let readList=Object.keys(val.readBy).filter(u=>u!==val.sender);
      if(readList.length>0){
        let rr=document.createElement("div");
        rr.className="readReceipt";
        rr.textContent="Seen by: "+readList.join(", ");
        bubble.appendChild(rr);
      }
    }
  } else {
    if(val.sender===myId && val.readBy){
      let others=Object.keys(val.readBy).filter(u=>u!==myId);
      if(others.length>0){
        let rr=document.createElement("div");
        rr.className="readReceipt";
        rr.textContent="Seen";
        bubble.appendChild(rr);
      }
    }
  }
  if(toBottom) container.appendChild(bubble);
  else container.prepend(bubble);
}
function updateBubble(mId, val){
  let b=document.getElementById("msg_"+mId);
  if(!b) return;
  let rt=b.querySelector(".reactionTag");
  if(rt) rt.textContent= val.reaction || "";
  // read receipts
  let rr=b.querySelector(".readReceipt");
  if(currentType==="group"){
    if(val.readBy){
      let readList=Object.keys(val.readBy).filter(u=>u!==val.sender);
      if(readList.length>0){
        if(!rr){
          rr=document.createElement("div");
          rr.className="readReceipt";
          rr.textContent="Seen by: "+readList.join(", ");
          b.appendChild(rr);
        } else rr.textContent="Seen by: "+readList.join(", ");
      } else if(rr) rr.remove();
    } else if(rr) rr.remove();
  } else {
    // private
    if(val.sender===myId && val.readBy){
      let others=Object.keys(val.readBy).filter(u=>u!==myId);
      if(others.length>0){
        if(!rr){
          rr=document.createElement("div");
          rr.className="readReceipt";
          rr.textContent="Seen";
          b.appendChild(rr);
        }
      } else if(rr) rr.remove();
    }
  }
}

//** mark read if actually in the chat & window in focus
function markReadIfInThisChat(msgIds){
  if(document.hidden) return; // user not in window
  if(!currentChat) return;
  // we mark read
  const path=(currentType==="group"?"groupChats":"privateChats");
  msgIds.forEach(mId=>{
    db.ref(`${path}/${currentChat}/messages/${mId}/readBy/${myId}`).set(Date.now());
  });
}
document.addEventListener("visibilitychange",()=>{
  if(!document.hidden && currentChat){
    // we can mark all messages read in that chat
    // let's just do a quick once
    messagesRef.once("value",(snap)=>{
      const data=snap.val()||{};
      let keys=Object.keys(data);
      markReadIfInThisChat(keys);
    });
  }
});

//** attach typing
function attachTypingListener(){
  if(!currentChat) return;
  const path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/typing`).off();
  db.ref(`${path}/${currentChat}/typing`).on("value",(snap)=>{
    let v=snap.val();
    const t=document.getElementById("typingIndicator");
    if(v && v!==myId){
      t.style.display="block";
      t.textContent=`${v} is typing...`;
    } else {
      t.style.display="none";
    }
  });
}
function sendTyping(){
  if(!currentChat||isLocked) return;
  const path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/typing`).set(myId);
  setTimeout(()=> db.ref(`${path}/${currentChat}/typing`).set(""),2000);
}

//** Send message with slash commands
const slashCommands=[
  "/tod truth","/tod dare","/title","/cf heads","/cf tails","/coin flip heads","/coin flip tails"
];
function sendMessage(){
  if(!currentChat||currentType==="help") return;
  const inp=document.getElementById("msgInput");
  let txt=inp.value.trim();
  if(!txt) return;
  hideSlashAutocomplete();
  if(txt.startsWith("/")){
    processSlashCommand(txt);
    inp.value="";
    return;
  }
  // normal message
  let friendName=document.getElementById("chatTitle").textContent;
  if(currentType==="private" && blocked[friendName]){
    showNotice("You blocked them. Unblock first!");
    return;
  }
  const path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/messages`).push({
    sender:myId, text:txt, timestamp:Date.now(), reaction:"",
    readBy:{[myId]:Date.now()}
  });
  inp.value="";
  sendTyping();
}
function processSlashCommand(cmd){
  const parts=cmd.split(" ");
  const slash=parts[0];
  if(slash==="/tod"){
    if(parts[1]==="truth"){
      const next=getNextTruth();
      sendSystemMessage(next);
    } else if(parts[1]==="dare"){
      const next=getNextDare();
      sendSystemMessage(next);
    } else {
      showNotice("Usage: /tod truth or /tod dare");
    }
  } else if(slash==="/title"){
    let rest=parts.slice(1).join(" ");
    if(!rest) return showNotice("Usage: /title your text");
    sendSystemMessage(`<< ${rest} >>`);
  } else if(slash==="/cf" || slash==="/coin"){
    // coin flip
    let guess="";
    if(slash==="/cf") guess= parts[1]||"";
    else if(slash==="/coin"){
      // might be "flip heads" or "flip tails"
      if(parts[1]==="flip") guess=parts[2]||"";
    }
    guess=guess.toLowerCase();
    if(guess!=="heads"&& guess!=="tails"){
      showNotice(`Usage: ${slash} heads or ${slash} tails (or coin flip heads/tails)`);
      return;
    }
    // do random
    let coinSide=Math.random()<0.5? "heads":"tails";
    let result=(coinSide===guess)? "wins":"loses";
    sendSystemMessage(`Coin flipped on ${coinSide}, user ${displayName} ${result}!`);
  } else {
    showNotice(`Unknown command: ${cmd}`);
  }
}
function sendSystemMessage(txt){
  if(!currentChat) return;
  if(currentType==="help") return;
  // center system message
  const path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/messages`).push({
    sender:"_system",
    text:txt,
    timestamp:Date.now(),
    reaction:"",
    readBy:{}
  });
}

//** T/D queue approach
function getNextTruth(){
  let item=bigTruthsQueue.shift();
  bigTruthsQueue.push(item);
  return item;
}
function getNextDare(){
  let item=bigDaresQueue.shift();
  bigDaresQueue.push(item);
  return item;
}

//** Reactions
function applyReaction(mId, r){
  if(!currentChat) return;
  let p=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${p}/${currentChat}/messages/${mId}/reaction`).set(r);
}

//** slash command autocomplete
let slashOpen=false;
function showSlashAutocomplete(){
  let sc=document.getElementById("slashAutocomplete");
  sc.style.display="block";
  sc.innerHTML="";
  slashCommands.forEach(cmd=>{
    let b=document.createElement("button");
    b.textContent=cmd;
    b.onclick=()=>{
      document.getElementById("msgInput").value=cmd+" ";
      sc.style.display="none";
    };
    sc.appendChild(b);
  });
}
function hideSlashAutocomplete(){
  let sc=document.getElementById("slashAutocomplete");
  sc.style.display="none";
}
function slashAutoInput(e){
  if(!currentChat||currentType==="help") return;
  if(e.target.value.startsWith("/")) showSlashAutocomplete();
  else hideSlashAutocomplete();
}

//** Theming button label
function setThemeBtnLabel(tn){
  document.getElementById("themeBtn").textContent=`${tn}: Theme`;
}

//** open/close settings
function openSettings(){
  const setPanel=document.createElement("div");
  setPanel.className="modal";
  setPanel.innerHTML=`
    <div class="panelContent" style="position:relative;min-width:320px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Settings</h3>
      <label>Display Name:</label>
      <input id="editDisplay" value="${displayName}" /><br/>
      <label>Password (for friend requests, optional):</label>
      <input id="editPass" value="${pass}" /><br/><br/>
      <button id="saveBtn">Save</button>
    </div>
  `;
  document.body.appendChild(setPanel);
  setPanel.style.display="flex";
  setPanel.addEventListener("click",(ev)=>{
    if(ev.target===setPanel) document.body.removeChild(setPanel);
  });
  setPanel.querySelector("#saveBtn").onclick=()=>{
    let dN=setPanel.querySelector("#editDisplay").value.trim();
    let p=setPanel.querySelector("#editPass").value.trim();
    if(!dN) { showNotice("Name cannot be empty"); return; }
    // check name
    checkNameAvailable(dN,myId,(ok,ex)=>{
      if(!ok && ex!==myId){
        showNotice("That display name is taken by another device!");
        return;
      }
      displayName=dN; pass=p;
      localStorage.setItem("displayName", dN);
      localStorage.setItem("pass", p);
      db.ref("displayNames/"+dN).set(myId);
      db.ref("users/"+myId+"/displayName").set(dN);
      showNotice("Settings saved!");
      document.body.removeChild(setPanel);
    });
  };
}

//** addFriendUI
function addFriendUI(){
  const msg=`
    Enter friend's device ID:
    <br/>
    <input id='friendIdInput'/>
  `;
  showConfirm(msg,()=>{
    let fId=document.getElementById("friendIdInput").value.trim();
    if(!fId) { showNotice("No ID typed!"); return; }
    if(fId===myId){ showNotice("You can't friend yourself!"); return; }
    if(blocked[fId]){ showNotice("You blocked them! Unblock first."); return; }
    // check if user exists
    db.ref(`users/${fId}/displayName`).once("value",(snap)=>{
      if(!snap.exists()){
        showNotice(`That user ID ${fId} doesn't exist!`);
        return;
      }
      // check if already friends
      if(friends[fId]){
        showNotice(`You're already friends with ${fId}!`);
        return;
      }
      // check if there's a pending request
      db.ref(`users/${myId}/requestsSent/${fId}`).once("value",(s2)=>{
        if(s2.exists()){
          showNotice(`Already have a request with ${fId}. Wait for them to accept.`);
          return;
        }
        // send
        db.ref(`users/${fId}/requests/${myId}`).set({requested:true});
        db.ref(`users/${myId}/requestsSent/${fId}`).set(true);
        db.ref(`privateChats/${[myId,fId].sort().join("_")}`).set({});
        showNotice(`Friend request sent to ${fId}`);
      });
    });
  });
}

//** group create/join modals
function showAddChatPanel(){
  const mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="panelContent" style="position:relative;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Add Chat</h3>
      <button onclick="showCreatePanel();document.body.removeChild(this.closest('.modal'))">Create Group</button><br/>
      <button onclick="showJoinPanel();document.body.removeChild(this.closest('.modal'))">Join Group</button><br/>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{
    if(ev.target===mo) document.body.removeChild(mo);
  });
}
function showCreatePanel(){
  document.getElementById("groupCreatePanel").style.display="flex";
}
function closeCreatePanel(){
  document.getElementById("groupCreatePanel").style.display="none";
}
function createGroupChat(){
  let nm=document.getElementById("groupName").value.trim();
  let ty=document.getElementById("groupType").value;
  let pw=document.getElementById("groupPassword").value.trim();
  if(!nm) return;
  let gid="group_"+Date.now();
  let members={}; members[myId]=true;
  db.ref(`groupChats/${gid}`).set({name:nm,type:ty,password:pw,createdBy:myId,members});
  db.ref(`users/${myId}/chats/${gid}`).set({name:nm,type:"group",last:Date.now()});
  closeCreatePanel();
  openChat(gid,nm,"group");
}
function showJoinPanel(){
  document.getElementById("groupJoinPanel").style.display="flex";
}
function closeJoinPanel(){
  document.getElementById("groupJoinPanel").style.display="none";
}
function joinGroupChat(){
  let id=document.getElementById("joinGroupID").value.trim();
  let pw=document.getElementById("joinGroupPassword").value.trim();
  if(!id) return;
  db.ref("groupChats/"+id).once("value",(snap)=>{
    let g=snap.val();
    if(!g){ showNotice("Group not found!"); return; }
    if(g.type==="password" && g.password!==pw){ showNotice("Wrong password!"); return; }
    if(g.type==="invite" && !(g.members && g.members[myId])){ showNotice("Not invited!"); return; }
    db.ref(`groupChats/${id}/members/${myId}`).set(true);
    db.ref(`users/${myId}/chats/${id}`).set({name:g.name,type:"group",last:Date.now()});
    closeJoinPanel();
    openChat(id,g.name,"group");
  });
}

//** slash autocomplete
function slashInputHandler(e){
  let val=e.target.value;
  if(!val.startsWith("/")){
    document.getElementById("slashAutocomplete").style.display="none";
    return;
  }
  let sc=document.getElementById("slashAutocomplete");
  sc.style.display="block";
  sc.innerHTML="";
  let commands=["/tod truth","/tod dare","/title","/cf heads","/cf tails","/coin flip heads","/coin flip tails"];
  commands.forEach(c=>{
    if(c.startsWith(val)) {
      let b=document.createElement("button");
      b.textContent=c;
      b.onclick=()=>{
        document.getElementById("msgInput").value=c+" ";
        sc.style.display="none";
      };
      sc.appendChild(b);
    }
  });
}

//** Notifications
function requestNotificationPermission(){
  if(!("Notification" in window)) { showNotice("No notification support!"); return; }
  Notification.requestPermission().then(perm=>{
    if(perm==="granted") showNotice("Notifications enabled!");
    else showNotice("Notifications not granted.");
  });
}

//** done
console.log("Static Live Chat loaded with slash autocomplete, big T/D queue, help chat, device-based ID, no presence watchers!");
</script>

<!-- "slashAutocomplete" popup -->
<div id="slashAutocomplete" style="display:none; position:absolute;"></div>

<!-- Simple rules example:
{
  "rules": {
    ".read":true,
    ".write":true,
    "users":{"$deviceId":{".read":true,".write":true}},
    "privateChats":{"$chatId":{".read":true,".write":true}},
    "groupChats":{"$groupId":{".read":true,".write":true}},
    "displayNames":{"$name":{".read":true,".write":true}}
  }
}
-->
</body>
</html>
