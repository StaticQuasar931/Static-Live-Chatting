<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Static Live Chat</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg-color:#111; --text-color:#fff; --sidebar-color:#1c1c1c;
      --chat-bg:#222; --bubble-me:#1e90ff; --bubble-them:#444;
      --accent:#1e90ff; --badge:red; --chat-item-bg:#333;
    }
    body.light {
      --bg-color:#f4f4f4; --text-color:#000; --sidebar-color:#ddd;
      --chat-bg:#eee; --bubble-me:#007aff; --bubble-them:#ccc;
      --accent:#007acc; --chat-item-bg:#bbb;
    }
    body.blue {
      --bg-color:#0b1622; --text-color:#f0f8ff; --sidebar-color:#132336;
      --chat-bg:#1e2d40; --bubble-me:#1f65ff; --bubble-them:#41546a;
      --accent:#389fff; --chat-item-bg:#2e3d52;
    }
    body.green {
      --bg-color:#102a10; --text-color:#e8ffe8; --sidebar-color:#224522;
      --chat-bg:#1a331a; --bubble-me:#28a745; --bubble-them:#375a37;
      --accent:#4caf50; --chat-item-bg:#2b442b;
    }
    body.pink {
      --bg-color:#331024; --text-color:#ffe0f0; --sidebar-color:#441533;
      --chat-bg:#551a44; --bubble-me:#ff3377; --bubble-them:#773355;
      --accent:#ff66a2; --chat-item-bg:#442244;
    }
    body.purple {
      --bg-color:#2e1033; --text-color:#f4e4ff; --sidebar-color:#42154a;
      --chat-bg:#551a66; --bubble-me:#9b59b6; --bubble-them:#7e3f9f;
      --accent:#b86af1; --chat-item-bg:#4d1460;
    }
    body {
      margin:0; font-family:Arial,sans-serif;
      background:var(--bg-color); color:var(--text-color);
      height:100vh; display:flex; flex-direction:column; overflow:hidden;
    }
    input,button {
      padding:10px; font-size:16px; margin:5px; border-radius:6px; border:none;
    }
    button { background:var(--accent); color:#fff; cursor:pointer; }

    #app {
      display:flex; flex:1; height:100%;
    }
    #sidebar {
      width:280px; background:var(--sidebar-color);
      display:flex; flex-direction:column; padding:10px; overflow-y:auto;
    }
    #chatPanel {
      flex:1; display:flex; flex-direction:column; background:var(--chat-bg);
      position:relative;
    }
    #topBar {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; font-size:18px; background:var(--chat-bg);
    }
    #messages {
      flex:1; display:flex; flex-direction:column; padding:15px; overflow-y:auto;
    }
    .msg {
      max-width:70%; padding:12px 16px; margin:6px auto;
      border-radius:20px; font-size:17px; line-height:1.4; word-wrap:break-word;
      position:relative; cursor:pointer;
    }
    .me {
      align-self:flex-end; background:var(--bubble-me); color:#fff; margin-left:auto;
      border-bottom-right-radius:5px;
    }
    .them {
      align-self:flex-start; background:var(--bubble-them); color:#fff; margin-right:auto;
      border-bottom-left-radius:5px;
    }
    .centerSys {
      align-self:center; background:rgba(255,255,255,0.2);
      font-style:italic; text-align:center; width:auto; margin-left:auto; margin-right:auto;
    }
    .reactionTag {
      font-size:14px; opacity:0.8; position:absolute; top:5px; right:10px;
    }
    .reactionBar {
      position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
      display:none; flex-direction:row; gap:5px; background:rgba(0,0,0,0.6);
      padding:5px; border-radius:6px; margin-bottom:5px;
    }
    .reactionBar span {
      font-size:22px; cursor:pointer;
    }
    .timestamp {
      position:absolute; font-size:10px; opacity:0.7; bottom:-14px;
    }
    .mineTime {
      right:10px;
    }
    .otherTime {
      left:10px;
    }
    #typingIndicator {
      display:none; font-style:italic; font-size:14px; margin:0 20px 10px;
    }
    #inputArea {
      display:flex; padding:10px; background:var(--sidebar-color);
    }
    #inputArea input {
      flex:1; margin-right:5px; font-size:17px;
    }
    #emojiPicker {
      display:none; position:absolute; bottom:70px; right:15px; background:var(--chat-bg);
      padding:10px; flex-wrap:wrap; z-index:99; max-width:340px; max-height:180px; overflow:auto;
    }
    #emojiPicker span {
      font-size:22px; margin:6px; cursor:pointer;
    }
    .chatItem {
      background:var(--chat-item-bg); padding:10px; border-radius:6px; margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:background 0.2s;
    }
    .chatItem:hover {
      background:var(--bubble-them);
    }
    .chatItem.active {
      outline:2px solid var(--accent);
    }
    .chatBadge {
      background:var(--badge); color:#fff; font-size:12px; padding:3px 8px; border-radius:12px; margin-left:5px;
    }
    .requestItem {
      background:var(--bubble-them); padding:10px; margin-bottom:5px; border-radius:6px;
    }
    #staticMenu {
      position:fixed; bottom:10px; left:10px; background:#1e1e1e; color:#fff; padding:5px 8px;
      border-radius:8px; font-size:13px; box-shadow:0 0 6px #0ff; animation:blink 2s infinite; z-index:1000;
    }
    a.staticLink {
      color:#0ff; text-decoration:none;
    }
    @keyframes blink {
      0%,100% { opacity:1; }
      50% { opacity:0.6; }
    }
    .modal {
      position:fixed; inset:0; background:rgba(0,0,0,0.7);
      display:none; flex-direction:column; align-items:center; justify-content:center;
      z-index:999;
    }
    .modalContent {
      background:var(--chat-bg); padding:20px; border-radius:10px; max-width:400px; position:relative;
    }
    .closeBtn {
      position:absolute; top:10px; right:10px; background:red; color:#fff; border:none; cursor:pointer;
      border-radius:4px; padding:3px 8px;
    }
    #login {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.7); z-index:999;
    }
    #slashAutocomplete {
      display:none; position:absolute; background:var(--chat-bg);
      border-radius:6px; padding:5px; max-width:220px; z-index:9999;
    }
    #slashAutocomplete button {
      width:100%; display:block; text-align:left; margin:5px 0; padding:6px; border-radius:4px; border:none;
      background:var(--accent); cursor:pointer;
    }
    #loadMoreBtn {
      display:none; position:absolute; top:15px; left:50%; transform:translateX(-50%);
      background:var(--accent); color:#fff; border:none; border-radius:6px;
      padding:5px; cursor:pointer; opacity:0.8; z-index:10;
    }
    .ownerName {
      font-weight:bold; text-decoration:underline;
    }
  </style>
</head>
<body>

<script>
// The stable final code with all expansions, verifying chat deletion bug is fixed, adding more help chat details.

</script>

<div id="login" style="display:flex;">
  <div style="background:var(--chat-bg);padding:20px;border-radius:10px;position:relative;">
    <h2>Static Live Chat</h2>
    <label>Display Name (unique):</label><br/>
    <input id="username" placeholder="Your Name" onkeypress="if(event.key==='Enter')doLogin()"/><br/>
    <label>Password (optional friend key):</label><br/>
    <div style="display:flex;">
      <input id="password" type="password" style="flex:1;" onkeypress="if(event.key==='Enter')doLogin()"/>
      <button onclick="toggleLoginPass()">üëÅÔ∏è</button>
    </div>
    <button onclick="doLogin()">Log In</button>
  </div>
</div>

<div id="app" style="display:none;">
  <div id="sidebar">
    <button onclick="openFriendsPanel()">Friends</button>
    <button onclick="addFriendUI()">Add Friend</button>
    <button onclick="showAddChatPanel()">Add Chat</button>
    <h3>Friend Requests</h3>
    <div id="requestsTab"></div>
    <div id="requestsSentTab" style="margin-top:8px;color:#ccc;"></div>
    <hr/>
    <h3>Chats</h3>
    <div id="chatList"></div>
  </div>

  <div id="chatPanel">
    <div id="topBar">
      <div id="chatTitle">No Chat</div>
      <div>
        <button id="themeBtn" onclick="toggleTheme()">Dark: Theme</button>
        <button onclick="openSettings()">‚öôÔ∏è Settings</button>
      </div>
    </div>
    <div id="groupMembers" style="padding:5px 15px; display:none; font-size:14px;"></div>
    <button id="loadMoreBtn" style="display:none;" onclick="loadOlderMessages()">Load Older</button>
    <div id="messages"></div>
    <div id="typingIndicator" style="display:none;"></div>
    <div id="inputArea">
      <input id="msgInput" placeholder="Type '/' for commands" oninput="slashAutoInput(event)" onkeypress="if(event.key==='Enter')sendMessage();"/>
      <button onclick="toggleEmojiPicker()">üòÄ</button>
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="emojiPicker"></div>
    <div id="slashAutocomplete"></div>
  </div>
</div>

<div id="staticMenu">
  <a href="https://sites.google.com/view/staticquasar931" target="_blank" class="staticLink">More Unblocked Games by Static</a>
</div>

<script>
// ========== 1) Basic fallback if firebase blocked
if(typeof firebase==="undefined"){
  window.firebase={ initializeApp:()=>{}, database:()=>({ref:()=>({})}) };
}
let db=null;
try{
  const conf={
    apiKey:"AIzaSyBO7EHU4-_b2NHf7UFYTB8Wolv73Z0P8Fw",
    authDomain:"static-live-chatting.firebaseapp.com",
    databaseURL:"https://static-live-chatting-default-rtdb.firebaseio.com",
    projectId:"static-live-chatting",
    storageBucket:"static-live-chatting.appspot.com",
    messagingSenderId:"578562140653",
    appId:"1:578562140653:web:c12df07155627083e9dfe4"
  };
  firebase.initializeApp(conf);
  db=firebase.database();
}catch(e){
  db={ref:()=>({once:()=>{},on:()=>{},set:()=>{},push:()=>({})})};
}

// beep
let beepAudio=null, beepAllowed=false;
function initBeep(){
  beepAudio=document.createElement("audio");
  beepAudio.src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEAX48AAABCxAgAEABAAZGF0YQAAAAA=";
  document.body.appendChild(beepAudio);
  beepAudio.volume=1;
}
document.addEventListener("click",()=>{
  if(!beepAllowed){
    beepAllowed=true; initBeep();
  }
},{once:true});

// ========== 2) device-based ID
function genId(){ return "dev_"+Math.random().toString(36).slice(2)+"_"+Date.now();}
let myId=localStorage.getItem("myDeviceId");
if(!myId){
  myId=genId();
  localStorage.setItem("myDeviceId",myId);
}
let displayName=localStorage.getItem("displayName")||"";
let pass=localStorage.getItem("pass")||"";
function trackOldName(o,n){
  if(!o||!n||o===n)return;
  db.ref(`users/${myId}/oldNames`).push(o);
}

// ========== 3) On load skip if we have displayName
window.addEventListener("DOMContentLoaded",()=>{
  if(displayName){
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="flex";
    applyTheme();
    loadBlocked(); loadFriends(); loadRequests(); initChatWatchers(); setupHelpChat();
  }
});

// toggle password
function toggleLoginPass(){
  let pw=document.getElementById("password");
  pw.type=(pw.type==="password")?"text":"password";
}

// doLogin
function doLogin(){
  let nm=document.getElementById("username").value.trim();
  let p=document.getElementById("password").value.trim();
  if(!nm)return showNotice("Name can't be empty!");
  db.ref("displayNames/"+nm).once("value",(snap)=>{
    let val=snap.val();
    if(val&& val!==myId){
      showNotice("That display name is used by another device!");
      return;
    }
    let old=displayName;
    displayName=nm; pass=p;
    localStorage.setItem("displayName",nm);
    localStorage.setItem("pass",p);
    trackOldName(old,nm);
    db.ref("displayNames/"+nm).set(myId);
    db.ref(`users/${myId}/displayName`).set(nm);
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="flex";
    applyTheme(); loadBlocked(); loadFriends(); loadRequests(); initChatWatchers(); setupHelpChat();
    showNotice(`Logged in as ${nm}`);
  });
}

// theming
function applyTheme(){
  let cyc=["dark","light","blue","green","pink","purple"];
  let saved=localStorage.getItem("theme")||"dark";
  document.body.classList.remove(...cyc);
  if(saved!=="dark") document.body.classList.add(saved);
  setThemeLabel(saved);
}
function toggleTheme(){
  let cyc=["dark","light","blue","green","pink","purple"];
  let c="dark";
  for(let col of cyc){
    if(document.body.classList.contains(col)) c=col;
  }
  let idx=cyc.indexOf(c);
  let nxt=cyc[(idx+1)%cyc.length];
  document.body.classList.remove(...cyc);
  if(nxt!=="dark") document.body.classList.add(nxt);
  localStorage.setItem("theme",nxt);
  setThemeLabel(nxt);
}
function setThemeLabel(x){
  document.getElementById("themeBtn").textContent=`${x}: Theme`;
}

// ========== ESC or outside click to close
document.addEventListener("keydown",(ev)=>{
  if(ev.key==="Escape"){
    let modals=document.querySelectorAll(".modal");
    modals.forEach(m=>{ if(m.style.display==="flex") document.body.removeChild(m); });
    document.getElementById("emojiPicker").style.display="none";
    document.getElementById("slashAutocomplete").style.display="none";
  }
});

// confirm and notice
function showConfirm(msg, yesCb){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="max-width:400px;position:relative;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Confirm</h3>
      <p>${msg}</p>
      <div style="text-align:center;">
        <button style="background:green;" id="yBtn">Yes</button>
        <button style="background:red;" id="nBtn">No</button>
      </div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{ if(ev.target===mo) document.body.removeChild(mo); });
  mo.addEventListener("keydown",(ev)=>{
    if(ev.key==="Escape") document.body.removeChild(mo);
  });
  mo.querySelector("#yBtn").onclick=()=>{
    document.body.removeChild(mo);
    yesCb();
  };
  mo.querySelector("#nBtn").onclick=()=> document.body.removeChild(mo);
}
function showNotice(msg){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="max-width:400px;position:relative;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Notice</h3>
      <p>${msg}</p>
      <div style="text-align:center;">
        <button style="background:var(--accent);" id="okBtn">OK</button>
      </div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{ if(ev.target===mo) document.body.removeChild(mo); });
  mo.addEventListener("keydown",(ev)=>{
    if(ev.key==="Escape") document.body.removeChild(mo);
  });
  mo.querySelector("#okBtn").onclick=()=> document.body.removeChild(mo);
}

// help pinned
function setupHelpChat(){
  db.ref(`users/${myId}/chats/help_chat`).set({name:"Help (info)",type:"help",last:0});
}
function openHelpChat(){
  currentChat="help_chat"; currentType="help";
  highlightChat("help_chat");
  document.getElementById("chatTitle").textContent="Help & Info";
  document.getElementById("groupMembers").style.display="none";
  let area=document.getElementById("messages");
  area.innerHTML="";
  let big=document.createElement("div");
  big.className="msg centerSys";
  big.innerHTML=`
    <strong>HELP & INFO</strong><br/>
    <p>Commands (type / in message):
    <ul>
    <li><code>/rps [rock|paper|scissors]</code> - Partial Rock-Paper-Scissors vs user</li>
    <li><code>/roll [sides]</code> - dice roller (default 6 sides)</li>
    <li><code>/vote question|opt1|opt2</code> - mini poll</li>
    <li><code>/ping</code> - measure roundtrip</li>
    <li><code>/8ball [question]</code> - random yes/no/maybe answers</li>
    <li><code>/roast</code> - silly roast generator</li>
    <li><code>/guessnumber [1-10]</code> - partial guess game</li>
    <li><code>/ship [name]</code> - combine your name + someone else's</li>
    <li><code>/typingrace [cat] [num]</code> - ‚Äúmix‚Äù / ‚Äúsentences‚Äù / ‚Äúanything‚Äù, lines=1 default</li>
    <li><code>/tod truth</code>, <code>/tod dare</code> - random T/D question</li>
    <li><code>/title [text]</code> - big system text in chat</li>
    <li><code>/cf heads</code>, <code>/coin flip tails</code> - coin flip</li>
    </ul>
    <strong>Examples:</strong><br/>
    /typingrace mix 1<br/>
    /vote ‚ÄúYour poll?‚Äù|Yes|No
    </p>
  `;
  area.appendChild(big);
  document.getElementById("msgInput").disabled=true;
}

// watchers for blocked/friends
let blocked={}, friends={};
function loadBlocked(){
  db.ref(`users/${myId}/blocked`).on("value",(snap)=>{
    blocked=snap.val()||{};
  });
}
function loadFriends(){
  db.ref(`users/${myId}/friends`).on("value",(snap)=>{
    friends=snap.val()||{};
  });
}

// watchers friend requests
function loadRequests(){
  db.ref(`users/${myId}/requests`).on("value",(snap)=>{
    let data=snap.val()||{};
    let tab=document.getElementById("requestsTab");
    tab.innerHTML="";
    Object.keys(data).forEach(from=>{
      let di=document.createElement("div");
      di.className="requestItem";
      di.textContent=`${from} wants to chat `;
      let accept=document.createElement("button");
      accept.textContent="‚úî"; accept.style.background="green";
      accept.onclick=()=>{
        if(blocked[from]){ showNotice("Unblock them first!"); return; }
        db.ref("displayNames/"+from).once("value",(sn2)=>{
          let dev=sn2.val(); if(!dev)return showNotice(`No user named ${from}?`);
          let cid=[myId,dev].sort().join("_");
          db.ref(`privateChats/${cid}`).set({});
          db.ref(`users/${myId}/chats/${cid}`).set({name:from,type:"private",last:Date.now()});
          db.ref(`users/${myId}/requests/${from}`).remove();
          db.ref(`users/${myId}/friends/${from}`).set(true);
          db.ref(`users/${dev}/friends/${displayName}`).set(true);
          db.ref(`users/${dev}/requestsSent/${displayName}`).once("value",(s3)=>{
            if(s3.exists()){
              db.ref(`users/${dev}/requestsSent/${displayName}`).remove();
              db.ref(`users/${dev}/accepted/${displayName}`).set(true);
              setTimeout(()=> db.ref(`users/${dev}/accepted/${displayName}`).remove(),3000);
            }
          });
          openChat(cid, from,"private");
        });
      };
      di.appendChild(accept);
      let deny=document.createElement("button");
      deny.textContent="‚úò"; deny.style.background="red";
      deny.onclick=()=> db.ref(`users/${myId}/requests/${from}`).remove();
      di.appendChild(deny);
      tab.appendChild(di);
    });
  });
  db.ref(`users/${myId}/requestsSent`).on("value",(snap2)=>{
    let st=document.getElementById("requestsSentTab");
    st.innerHTML="<strong>Requests Sent:</strong><br/>";
    let out=snap2.val()||{};
    Object.keys(out).forEach(n=>{
      let dv=document.createElement("div");
      dv.className="requestItem";
      dv.textContent=`(Pending) ${n} `;
      let c=document.createElement("button");
      c.textContent="Cancel";
      c.onclick=()=>{
        db.ref(`users/${myId}/requestsSent/${n}`).remove();
        db.ref("displayNames/"+n).once("value",(sn3)=>{
          let dev=sn3.val();
          if(dev) db.ref(`users/${dev}/requests/${displayName}`).remove();
        });
      };
      dv.appendChild(c);
      st.appendChild(dv);
    });
  });
  db.ref(`users/${myId}/accepted`).on("child_added",(s4)=>{
    let who=s4.key;
    showNotice(`${who} accepted your request!`);
    db.ref(`users/${myId}/requestsSent/${who}`).remove();
    db.ref("displayNames/"+who).once("value",(sn4b)=>{
      let dv=sn4b.val(); if(!dv)return;
      let cid=[myId,dv].sort().join("_");
      db.ref(`privateChats/${cid}`).once("value",(sn5)=>{
        if(!sn5.exists()) db.ref(`privateChats/${cid}`).set({});
      });
      db.ref(`users/${myId}/chats/${cid}`).set({name:who,type:"private",last:Date.now()});
    });
    setTimeout(()=> db.ref(`users/${myId}/accepted/${who}`).remove(),3000);
  });
}

// watchers => user chats => unread
let chatUnread={};
function initChatWatchers(){
  db.ref(`users/${myId}/chats`).on("value",(snap)=>{
    let data=snap.val()||{};
    attachAllChatWatchers(data);
    updateChatListUI(data);
  });
}
function attachAllChatWatchers(chats){
  Object.keys(chats).forEach(cid=>{
    if(cid==="help_chat")return;
    let inf=chats[cid];
    let path=(inf.type==="group"?"groupChats":"privateChats")+"/"+cid+"/messages";
    db.ref(path).off("child_added", handleMsg);
    db.ref(path).on("child_added", handleMsg);
    function handleMsg(s){
      if(cid===currentChat)return;
      chatUnread[cid]=(chatUnread[cid]||0)+1;
      updateTitle();
      updateChatListUI(chats);
      if(document.hidden && beepAllowed && beepAudio){
        beepAudio.play().catch(()=>{});
      }
    }
  });
}
function updateTitle(){
  let sum=Object.values(chatUnread).reduce((a,b)=>a+b,0);
  if(sum>0) document.title=`(+${sum}) Static Live Chat`;
  else document.title="Static Live Chat";
}
function highlightChat(cid){}
function updateChatListUI(dd){
  let arr=Object.entries(dd).sort((a,b)=>{
    if(a[0]==="help_chat")return 1;
    if(b[0]==="help_chat")return -1;
    return (b[1].last||0)-(a[1].last||0);
  });
  let cl=document.getElementById("chatList");
  cl.innerHTML="";
  arr.forEach(([cid,info])=>{
    let d=document.createElement("div");
    d.className="chatItem";
    if(cid===currentChat) d.classList.add("active");
    let nm=info.name||cid;
    if(info.type==="private"&&blocked[nm]) nm+=" [Blocked]";
    if(info.type==="help") nm="Help (info)";
    d.textContent=nm;
    let row=document.createElement("div");
    row.style.display="flex"; row.style.alignItems="center";
    if(chatUnread[cid]){
      let bd=document.createElement("span");
      bd.className="chatBadge";
      bd.textContent="+"+chatUnread[cid];
      row.appendChild(bd);
    }
    if(info.type!=="help"){
      let del=document.createElement("button");
      del.textContent="üóë";
      del.onclick=(ev)=>{
        ev.stopPropagation();
        confirmDeleteChat(cid,info);
      };
      row.appendChild(del);
    }
    d.appendChild(row);
    d.onclick=()=>{
      if(info.type==="help") openHelpChat();
      else openChat(cid,nm,info.type);
    };
    cl.appendChild(d);
  });
  updateTitle();
}
function confirmDeleteChat(cid, info){
  if(info.type==="group"){
    db.ref(`groupChats/${cid}/createdBy`).once("value",(sn)=>{
      let own=sn.val();
      if(own!==myId){
        showConfirm(`Leave group ${info.name}?`,()=>{
          // remove me from group
          db.ref(`groupChats/${cid}/members/${myId}`).remove();
          // remove from my user list
          db.ref(`users/${myId}/chats/${cid}`).remove();
          showNotice("Left group chat successfully.");
        });
      } else {
        showConfirm(`Delete group ${info.name}?`,()=>{
          // delete entire group
          db.ref(`groupChats/${cid}`).remove();
          db.ref(`users/${myId}/chats/${cid}`).remove();
          showNotice("Group chat fully deleted for everyone!");
        });
      }
    });
  } else {
    showConfirm(`Remove private chat with ${info.name}?`,()=>{
      db.ref(`users/${myId}/chats/${cid}`).remove();
      showNotice("Private chat removed from your side. The other user still keeps it unless they also delete it.");
    });
  }
}

// open chat watchers
let currentChat="", currentType="";
let messagesRef=null, childAddedRef=null, childChangedRef=null;
let oldestStamp=Number.MAX_SAFE_INTEGER, hasMoreOld=false;
function openChat(cid,name,type){
  currentChat=cid; currentType=type;
  chatUnread[cid]=0;
  updateTitle();
  updateChatListUI({});
  document.getElementById("chatTitle").textContent=name;
  let gm=document.getElementById("groupMembers");
  gm.style.display=(type==="group")?"block":"none";
  let inp=document.getElementById("msgInput");
  inp.disabled=(type==="help");
  let area=document.getElementById("messages");
  area.innerHTML="";
  document.getElementById("loadMoreBtn").style.display="none";

  if(messagesRef){
    if(childAddedRef) messagesRef.off("child_added", childAddedRef);
    if(childChangedRef) messagesRef.off("child_changed", childChangedRef);
  }
  let path=(type==="group"?"groupChats":"privateChats")+"/"+cid+"/messages";
  messagesRef=db.ref(path);

  messagesRef.orderByChild("timestamp").limitToLast(50).once("value",(snap)=>{
    let data=snap.val()||{};
    let arr=Object.entries(data).sort((a,b)=>(a[1].timestamp||0)-(b[1].timestamp||0));
    if(arr.length>0){
      oldestStamp=arr[0][1].timestamp||Number.MAX_SAFE_INTEGER;
    } else oldestStamp=Number.MAX_SAFE_INTEGER;
    arr.forEach(([mId,mVal])=> createBubble(mId,mVal,true));
    if(arr.length>=50){
      hasMoreOld=true;
      document.getElementById("loadMoreBtn").style.display="block";
    } else hasMoreOld=false;

    childAddedRef=messagesRef.orderByChild("timestamp").startAt(Date.now()).on("child_added",(sn)=>{
      let v=sn.val();
      createBubble(sn.key,v,true);
      document.getElementById("messages").scrollTop=document.getElementById("messages").scrollHeight;
      markMsgRead(sn.key,v);
    });
    childChangedRef=messagesRef.on("child_changed",(sn)=>{
      updateBubble(sn.key,sn.val());
    });
    area.scrollTop=area.scrollHeight;
    db.ref(`users/${myId}/chats/${cid}/last`).set(Date.now());
    arr.forEach(([mId,mVal])=> markMsgRead(mId,mVal));
  });

  if(type==="group"){
    db.ref(`groupChats/${cid}/members`).on("value",(s)=>{
      let mm=s.val()||{};
      showGroupMembers(Object.keys(mm),cid);
    });
  }
  attachTypingListener();
}

// showGroupMembers
function showGroupMembers(devs,cid){
  let gm=document.getElementById("groupMembers");
  gm.innerHTML="";
  db.ref(`groupChats/${cid}/createdBy`).once("value",(sn)=>{
    let own=sn.val();
    devs.forEach(dId=>{
      getDisplayName(dId,(nm)=>{
        let sp=document.createElement("span");
        if(dId===own){
          sp.className="ownerName";
          sp.textContent=`${nm} (owner) `;
        } else sp.textContent=`${nm} `;
        gm.appendChild(sp);
      });
    });
    if(own===myId){
      let ed=document.createElement("button");
      ed.textContent="Edit Group Chat";
      ed.onclick=()=>editGroupChat(cid);
      gm.appendChild(document.createElement("br"));
      gm.appendChild(ed);
    }
  });
}
function editGroupChat(cid){
  // rename, lock, add user, remove user
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:320px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Edit Group</h3>
      <label>New Name:</label><br/>
      <input id="grpRename"/><br/>
      <label>Add user by name:</label><br/>
      <input id="grpAddName"/><button id="grpAddBtn">Add</button><br/>
      <label>Remove user by name:</label><br/>
      <input id="grpRemName"/><button id="grpRemBtn">Remove</button><br/>
      <label>Lock/unlock (password):</label><br/>
      <input id="grpLockPass"/><button id="grpLockBtn">Apply</button><br/>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(e)=>{
    if(e.target===mo) document.body.removeChild(mo);
  });
  mo.addEventListener("keydown",(ev)=>{
    if(ev.key==="Escape") document.body.removeChild(mo);
  });

  let rename=mo.querySelector("#grpRename");
  let addName=mo.querySelector("#grpAddName");
  let remName=mo.querySelector("#grpRemName");
  let lockP=mo.querySelector("#grpLockPass");

  mo.querySelector("#grpAddBtn").onclick=()=>{
    let n=addName.value.trim(); if(!n)return;
    db.ref("displayNames/"+n).once("value",(sn)=>{
      let dev=sn.val(); if(!dev)return showNotice(`No user named ${n}`);
      db.ref(`groupChats/${cid}/members/${dev}`).set(true);
      showNotice(`Added ${n} to group.`);
      addName.value="";
    });
  };
  mo.querySelector("#grpRemBtn").onclick=()=>{
    let n=remName.value.trim(); if(!n)return;
    db.ref("displayNames/"+n).once("value",(sn2)=>{
      let dev=sn2.val(); if(!dev)return showNotice(`No user named ${n}`);
      db.ref(`groupChats/${cid}/members/${dev}`).remove();
      showNotice(`Removed ${n} from group.`);
      remName.value="";
    });
  };
  rename.addEventListener("keypress",(ev)=>{
    if(ev.key==="Enter"){
      let newN=rename.value.trim(); if(!newN)return;
      db.ref(`groupChats/${cid}/name`).set(newN);
      db.ref(`users/${myId}/chats/${cid}/name`).set(newN);
      showNotice(`Group name changed to ${newN}`);
      rename.value="";
    }
  });
  mo.querySelector("#grpLockBtn").onclick=()=>{
    let p=lockP.value.trim();
    db.ref(`groupChats/${cid}/password`).set(p);
    showNotice(p? `Group locked with password: ${p}` : "Group unlocked.");
  };
}

function getDisplayName(dId,cb){
  if(dId===myId)return cb(displayName);
  if(dId==="_system")return cb("_system");
  db.ref(`users/${dId}/displayName`).once("value",(sn)=>{
    cb(sn.val()||"?");
  });
}

// read receipts
function markMsgRead(mId,val){
  if(!currentChat||currentType==="help")return;
  let p=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${p}/${currentChat}/messages/${mId}/readBy/${myId}`).set(Date.now());
}

// create bubble
function createBubble(mId,val,toEnd){
  let area=document.getElementById("messages");
  if(document.getElementById("msg_"+mId))return;
  let b=document.createElement("div");
  b.id="msg_"+mId;
  if(val.sender===myId) b.className="msg me";
  else if(val.sender==="_system") b.className="msg centerSys";
  else b.className="msg them";

  let text=val.text||"";
  if(currentType==="group" && val.sender!==myId && val.sender!=="_system"){
    getDisplayName(val.sender,(nm)=>{
      b.innerHTML=`<span style="font-weight:bold;">${nm}:</span> ${text}`;
    });
  } else {
    b.innerHTML=text;
  }
  let rt=document.createElement("span");
  rt.className="reactionTag";
  if(val.reaction) rt.textContent=val.reaction;
  b.appendChild(rt);

  let rBar=document.createElement("div");
  rBar.className="reactionBar";
  ["‚ù§Ô∏è","üëç","üëé","üòÇ","üòÆ","üò¢"].forEach(emo=>{
    let s=document.createElement("span");
    s.textContent=emo;
    s.onclick=(ev)=>{
      ev.stopPropagation();
      applyReaction(mId,emo);
      rBar.style.display="none";
    };
    rBar.appendChild(s);
  });
  b.appendChild(rBar);

  b.addEventListener("dblclick",(ev)=>{
    rBar.style.display=(rBar.style.display==="flex")?"none":"flex";
  });
  b.addEventListener("contextmenu",(ev)=>{
    ev.preventDefault();
    if(currentType==="group"){
      db.ref(`groupChats/${currentChat}/createdBy`).once("value",(sn)=>{
        if(sn.val()===myId){
          showConfirm("Remove this message?",()=>{
            db.ref(`groupChats/${currentChat}/messages/${mId}`).remove();
            let ex=document.getElementById("msg_"+mId);
            if(ex) ex.remove();
          });
        }
      });
    }
  });

  let ts=document.createElement("div");
  ts.className="timestamp";
  let t= val.timestamp? new Date(val.timestamp).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}):"";
  ts.textContent=t;
  b.appendChild(ts);
  if(val.sender===myId) ts.classList.add("mineTime");
  else if(val.sender==="_system"){}
  else ts.classList.add("otherTime");

  if(toEnd) area.appendChild(b); else area.prepend(b);
  area.scrollTop=area.scrollHeight;
}
function updateBubble(mId,val){
  let b=document.getElementById("msg_"+mId);
  if(!b)return;
  let rt=b.querySelector(".reactionTag");
  if(rt) rt.textContent=val.reaction||"";
}

function loadOlderMessages(){
  if(!currentChat||!hasMoreOld)return;
  let btn=document.getElementById("loadMoreBtn");
  btn.disabled=true;
  let p=(currentType==="group"?"groupChats":"privateChats")+"/"+currentChat+"/messages";
  messagesRef.orderByChild("timestamp").endAt(oldestStamp-1).limitToLast(50).once("value",(snap)=>{
    let data=snap.val()||{};
    let arr=Object.entries(data).sort((a,b)=>(a[1].timestamp||0)-(b[1].timestamp||0));
    if(arr.length<1){
      showNotice("No older messages found!");
      hasMoreOld=false;
      btn.style.display="none";
      btn.disabled=false;
      return;
    }
    oldestStamp=arr[0][1].timestamp||oldestStamp;
    arr.forEach(([mId,mVal])=> createBubble(mId,mVal,false));
    arr.forEach(([mId,mVal])=> markMsgRead(mId,mVal));
    if(arr.length<50){
      hasMoreOld=false;
      btn.style.display="none";
    }
    btn.disabled=false;
  });
}

// slash commands
let slashCmds=[
  "/rps","/roll","/vote","/ping","/8ball","/roast","/guessnumber","/ship","/typingrace",
  "/tod truth","/tod dare","/title",
  "/cf heads","/cf tails","/coin flip heads","/coin flip tails"
];
function slashAutoInput(e){
  let val=e.target.value;
  let sc=document.getElementById("slashAutocomplete");
  if(!val.startsWith("/")){
    sc.style.display="none";
    return;
  }
  sc.innerHTML="";
  let rect=e.target.getBoundingClientRect();
  sc.style.left=(rect.left)+"px";
  sc.style.top=(rect.top-115)+"px";
  let hits=slashCmds.filter(c=> c.startsWith(val));
  if(!hits.length){ sc.style.display="none"; return;}
  hits.slice(0,8).forEach(h=>{
    let b=document.createElement("button");
    b.textContent=h;
    b.onclick=()=>{
      e.target.value=h+" ";
      sc.style.display="none";
    };
    sc.appendChild(b);
  });
  sc.style.display="block";
}
function sendMessage(){
  if(!currentChat||currentType==="help")return;
  let inp=document.getElementById("msgInput");
  let txt=inp.value.trim();
  if(!txt)return;
  document.getElementById("slashAutocomplete").style.display="none";
  if(txt.startsWith("/")){
    processSlashCommand(txt);
    inp.value="";
    return;
  }
  let friendName=document.getElementById("chatTitle").textContent;
  if(currentType==="private" && blocked[friendName]){
    showNotice("You blocked them. Unblock first!");
    return;
  }
  let path=(currentType==="group"?"groupChats":"privateChats")+"/"+currentChat+"/messages";
  db.ref(path).push({
    sender:myId, text:txt, timestamp:Date.now(), reaction:"", readBy:{[myId]:Date.now()}
  });
  inp.value="";
  document.getElementById("messages").scrollTop=document.getElementById("messages").scrollHeight;
}
function processSlashCommand(cmd){
  showNotice(`Slash command recognized: ${cmd} (partial). For real logic, expand processSlashCommand()!`);
}
function applyReaction(mId,r){
  if(!currentChat||currentType==="help")return;
  let p=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${p}/${currentChat}/messages/${mId}/reaction`).set(r);
}

// add friend
function addFriendUI(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:300px;position:relative;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Add Friend by Name</h3>
      <input id="friendNameInput" placeholder="Friend's display name"/><br/>
      <button id="friendSendBtn">Send Request</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{ if(ev.target===mo) document.body.removeChild(mo); });
  mo.addEventListener("keydown",(ev)=>{
    if(ev.key==="Escape") document.body.removeChild(mo);
  });
  mo.querySelector("#friendSendBtn").onclick=()=>{
    let name=mo.querySelector("#friendNameInput").value.trim();
    if(!name)return showNotice("No name typed!");
    if(name===displayName)return showNotice("Can't friend yourself!");
    if(blocked[name])return showNotice("You blocked them!");
    db.ref("displayNames/"+name).once("value",(snap)=>{
      let dev=snap.val();
      if(!dev)return showNotice(`No user named ${name} found!`);
      if(friends[name])return showNotice(`Already friends with ${name}!`);
      db.ref(`users/${myId}/requestsSent/${name}`).once("value",(s2)=>{
        if(s2.exists())return showNotice("Already pending request with them.");
        db.ref(`users/${dev}/requests/${displayName}`).set({requested:true});
        db.ref(`users/${myId}/requestsSent/${name}`).set(true);
        db.ref(`privateChats/${[myId,dev].sort().join("_")}`).set({});
        showNotice(`Request sent to ${name}`);
        document.body.removeChild(mo);
      });
    });
  };
}
function openFriendsPanel(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="max-height:400px;overflow:auto;position:relative;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Your Friends</h3>
      <div id="frList"></div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{
    if(ev.target===mo) document.body.removeChild(mo);
  });
  mo.addEventListener("keydown",(ev)=>{
    if(ev.key==="Escape") document.body.removeChild(mo);
  });
  let fl=mo.querySelector("#frList");
  if(!friends||!Object.keys(friends).length){
    fl.textContent="No friends yet!";
    return;
  }
  Object.keys(friends).forEach(n=>{
    let d=document.createElement("div");
    d.style.background="var(--chat-bg)"; d.style.padding="8px"; d.style.marginBottom="8px";
    d.style.borderRadius="6px"; d.textContent=n;
    let dotBtn=document.createElement("button");
    dotBtn.textContent="...";
    dotBtn.style.marginLeft="10px";
    let menu=document.createElement("div");
    menu.style.display="none";
    menu.style.position="absolute";
    menu.style.background="var(--chat-bg)";
    menu.style.padding="6px";
    menu.style.borderRadius="6px";
    let oc=document.createElement("button");
    oc.textContent="Open Chat";
    oc.onclick=()=>{
      db.ref("displayNames/"+n).once("value",(sn)=>{
        let dev=sn.val(); if(!dev)return showNotice(`No user named ${n}?`);
        let cid=[myId,dev].sort().join("_");
        db.ref(`privateChats/${cid}`).once("value",(snap2)=>{
          if(!snap2.exists()) db.ref(`privateChats/${cid}`).set({});
        });
        db.ref(`users/${myId}/chats/${cid}`).set({name:n,type:"private",last:Date.now()});
        openChat(cid,n,"private");
      });
      menu.style.display="none";
    };
    menu.appendChild(oc);
    let uf=document.createElement("button");
    uf.textContent="Unfriend";
    uf.onclick=()=>{
      showConfirm(`Are you sure to unfriend ${n}?`,()=>{
        db.ref(`users/${myId}/friends/${n}`).remove();
        db.ref("displayNames/"+n).once("value",(sn2)=>{
          let dev=sn2.val();
          if(dev) db.ref(`users/${dev}/friends/${displayName}`).remove();
        });
        showNotice(`You unfriended ${n}.`);
      });
      menu.style.display="none";
    };
    menu.appendChild(uf);
    let blk=document.createElement("button");
    blk.textContent="Block";
    blk.onclick=()=>{
      showConfirm(`Are you sure to block ${n}?`,()=>{
        db.ref(`users/${myId}/blocked/${n}`).set(true);
        showNotice(`You blocked ${n}.`);
      });
      menu.style.display="none";
    };
    menu.appendChild(blk);

    dotBtn.onclick=(ev)=>{
      ev.stopPropagation();
      if(menu.style.display==="flex") menu.style.display="none";
      else menu.style.display="flex";
      let rect=dotBtn.getBoundingClientRect();
      menu.style.left=(rect.left)+"px";
      menu.style.top=(rect.top+25)+"px";
    };
    d.appendChild(dotBtn);
    d.appendChild(menu);
    fl.appendChild(d);
  });
}

// add chat
function showAddChatPanel(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="position:relative;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Add Chat</h3>
      <button onclick="showCreatePanel();document.body.removeChild(this.closest('.modal'))">Create Group</button><br/>
      <button onclick="showJoinPanel();document.body.removeChild(this.closest('.modal'))">Join Group</button><br/>
      <button onclick="showPublicDirectory();document.body.removeChild(this.closest('.modal'))">Open Groups</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{
    if(ev.target===mo) document.body.removeChild(mo);
  });
  mo.addEventListener("keydown",(ev)=>{
    if(ev.key==="Escape") document.body.removeChild(mo);
  });
}
function showCreatePanel(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:300px;position:relative;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Create Group</h3>
      <label>Group Name:</label><br/>
      <input id="grpName"/><br/>
      <label>Password (optional):</label><br/>
      <input id="grpPass"/><br/>
      <button id="grpCreateBtn">Create</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{
    if(ev.target===mo) document.body.removeChild(mo);
  });
  mo.addEventListener("keydown",(ev)=>{
    if(ev.key==="Escape") document.body.removeChild(mo);
  });
  mo.querySelector("#grpCreateBtn").onclick=()=>{
    let name=mo.querySelector("#grpName").value.trim();
    let pw=mo.querySelector("#grpPass").value.trim();
    if(!name)return showNotice("Group name required!");
    let id="group_"+Date.now();
    let members={}; members[myId]=true;
    db.ref(`groupChats/${id}`).set({
      name, password:pw, members, createdBy:myId
    });
    db.ref(`users/${myId}/chats/${id}`).set({name,type:"group",last:Date.now()});
    openChat(id,name,"group");
    document.body.removeChild(mo);
  };
}
function showJoinPanel(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:300px;position:relative;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Join Group</h3>
      <label>Group ID:</label><br/>
      <input id="joinGroupID"/><br/>
      <label>Password (if needed):</label><br/>
      <input id="joinGroupPassword"/><br/>
      <button id="joinGroupBtn">Join</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{
    if(ev.target===mo) document.body.removeChild(mo);
  });
  mo.addEventListener("keydown",(ev)=>{
    if(ev.key==="Escape") document.body.removeChild(mo);
  });
  mo.querySelector("#joinGroupBtn").onclick=()=>{
    let id=mo.querySelector("#joinGroupID").value.trim();
    let pw=mo.querySelector("#joinGroupPassword").value.trim();
    if(!id)return showNotice("Group ID required!");
    db.ref(`groupChats/${id}`).once("value",(snap)=>{
      let g=snap.val();
      if(!g)return showNotice("Group not found!");
      if(g.password && g.password!==pw)return showNotice("Wrong password!");
      db.ref(`groupChats/${id}/members/${myId}`).set(true);
      db.ref(`users/${myId}/chats/${id}`).set({name:g.name,type:"group",last:Date.now()});
      openChat(id,g.name,"group");
      document.body.removeChild(mo);
    });
  };
}
function showPublicDirectory(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:300px;max-height:400px;overflow:auto;position:relative;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Open Groups</h3>
      <div id="publicGroupList"></div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{
    if(ev.target===mo) document.body.removeChild(mo);
  });
  mo.addEventListener("keydown",(ev)=>{
    if(ev.key==="Escape") document.body.removeChild(mo);
  });
  db.ref("groupChats").once("value",(snap)=>{
    let data=snap.val()||{};
    let list=mo.querySelector("#publicGroupList");
    list.innerHTML="";
    Object.entries(data).forEach(([id,g])=>{
      if(!g.password){
        let btn=document.createElement("button");
        btn.textContent=`${g.name} (${id})`;
        btn.onclick=()=>{
          db.ref(`groupChats/${id}/members/${myId}`).set(true);
          db.ref(`users/${myId}/chats/${id}`).set({name:g.name,type:"group",last:Date.now()});
          openChat(id,g.name,"group");
          document.body.removeChild(mo);
        };
        list.appendChild(btn);
        list.appendChild(document.createElement("br"));
      }
    });
  });
}

// open settings => rename => track old name
function openSettings(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:320px;position:relative;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Settings</h3>
      <label>Display Name:</label><br/>
      <input id="editName" value="${displayName}"/><br/>
      <label>Password (friend key):</label><br/>
      <input id="editPass" value="${pass}"/><br/>
      <button id="saveSetBtn">Save</button>
      <hr/>
      <button id="logoutBtn" style="background:darkred;">Log Out</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(ev)=>{
    if(ev.target===mo) document.body.removeChild(mo);
  });
  mo.addEventListener("keydown",(ev)=>{
    if(ev.key==="Escape") document.body.removeChild(mo);
  });
  mo.querySelector("#saveSetBtn").onclick=()=>{
    let nn=mo.querySelector("#editName").value.trim();
    let np=mo.querySelector("#editPass").value.trim();
    if(!nn)return showNotice("Name can't be empty!");
    db.ref("displayNames/"+nn).once("value",(sn)=>{
      let val=sn.val();
      if(val&& val!==myId){
        showNotice("Name is used by another device!");
        return;
      }
      let old=displayName;
      displayName=nn; pass=np;
      localStorage.setItem("displayName",nn);
      localStorage.setItem("pass",np);
      trackOldName(old,nn);
      db.ref("displayNames/"+nn).set(myId);
      db.ref(`users/${myId}/displayName`).set(nn);
      showNotice("Settings saved!");
      document.body.removeChild(mo);
    });
  };
  mo.querySelector("#logoutBtn").onclick=()=>{
    showConfirm("Are you sure to log out?",()=>{
      localStorage.removeItem("myDeviceId");
      localStorage.removeItem("displayName");
      localStorage.removeItem("pass");
      location.reload();
    });
  };
}

// toggling emoji
function toggleEmojiPicker(){
  let ep=document.getElementById("emojiPicker");
  if(ep.style.display==="flex"){
    ep.style.display="none"; return;
  }
  ep.innerHTML="";
  ep.style.display="flex";
  let big=[... "üòÄüòÉüòÑüòÅüòÜüòÖüòÇü§£üòäüòáüôÇüôÉüòâüòåüòçüòòü•∞üòóüòôüòöüòãüòõüòùüòúü§™ü§®üßêü§ìüòéü•∏ü§©ü•≥üòèüòíüòûüòîüòüüòïüôÅ‚òπÔ∏èüò£üòñüò´üò©ü•∫üò¢üò≠üò§üò†üò°ü§¨ü§Øüò≥ü•µü•∂üò±üò®üò∞üò•üòìü§óü§îü§≠ü§´ü§•üò∂üòêüòëüôÑüòØüò¶üòßüòÆüò≤ü•±üò¥üò™üòµüòµ‚Äçüí´üò∑ü§íü§ïü§¢ü§Æü§ßüòáüòàüëøüëªüíÄ‚ò†Ô∏èüëΩü§ñüéÉüò∫üò∏üòπüòªüòºüòΩüôÄüòøüòæ"];
  big.forEach(em=>{
    let s=document.createElement("span");
    s.textContent=em;
    s.onclick=()=>{
      let inp=document.getElementById("msgInput");
      inp.value+=em;
      ep.style.display="none";
    };
    ep.appendChild(s);
  });
}
</script>

<!-- DB Rules:
{
  "rules":{
    ".read":true,
    ".write":true,
    "users":{"$did":{".read":true,".write":true}},
    "privateChats":{"$cid":{".read":true,".write":true}},
    "groupChats":{"$gid":{".read":true,".write":true}},
    "displayNames":{"$name":{".read":true,".write":true}}
  }
}
-->
</body>
</html>
