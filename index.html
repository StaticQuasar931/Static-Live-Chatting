<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <!-- Optionally rename the tab or add a favicon:
  <title>My Awesome Chat</title>
  <link rel="icon" href="myfavicon.ico" type="image/x-icon"/>
  -->
  <title>Static Live Chat ‚Äì Device-based with Slash Commands</title>
  <!-- FIRST: Load Firebase scripts so we have "firebase" defined early -->
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg-color:#111;
      --text-color:#fff;
      --sidebar-color:#1c1c1c;
      --chat-bg:#222;
      --bubble-me:#1e90ff;
      --bubble-them:#444;
      --accent:#1e90ff;
      --badge:red;
      --chat-item-bg:#333;
    }
    body.light {
      --bg-color:#f4f4f4; --text-color:#000;
      --sidebar-color:#ddd; --chat-bg:#eee;
      --bubble-me:#007aff; --bubble-them:#ccc;
      --accent:#007acc; --chat-item-bg:#bbb;
    }
    body.blue {
      --bg-color:#0b1622; --text-color:#f0f8ff; --sidebar-color:#132336;
      --chat-bg:#1e2d40; --bubble-me:#1f65ff; --bubble-them:#41546a;
      --accent:#389fff; --chat-item-bg:#2e3d52;
    }
    body.green {
      --bg-color:#102a10; --text-color:#e8ffe8; --sidebar-color:#224522;
      --chat-bg:#1a331a; --bubble-me:#28a745; --bubble-them:#375a37;
      --accent:#4caf50; --chat-item-bg:#2b442b;
    }
    body.pink {
      --bg-color:#331024; --text-color:#ffe0f0; --sidebar-color:#441533;
      --chat-bg:#551a44; --bubble-me:#ff3377; --bubble-them:#773355;
      --accent:#ff66a2; --chat-item-bg:#442244;
    }
    body {
      margin:0; font-family:Arial,sans-serif;
      background:var(--bg-color); color:var(--text-color);
      height:100vh; display:flex; flex-direction:column; overflow:hidden;
    }
    input, button {
      padding:10px; font-size:16px; margin:5px; border-radius:6px; border:none;
    }
    button { background:var(--accent); color:#fff; cursor:pointer; }

    #app { display:flex; flex:1; height:100%; }
    #sidebar {
      width:280px; background:var(--sidebar-color);
      display:flex; flex-direction:column; padding:10px; overflow-y:auto;
    }
    #chatPanel {
      flex:1; display:flex; flex-direction:column; background:var(--chat-bg);
      position:relative;
    }
    #topBar {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; font-size:18px; background:var(--chat-bg);
    }
    #messages {
      flex:1; display:flex; flex-direction:column; padding:15px; overflow-y:auto;
    }
    .msg {
      max-width:70%; padding:12px 16px; margin:6px auto;
      border-radius:20px; font-size:17px; line-height:1.4; word-wrap:break-word;
      position:relative; cursor:pointer;
    }
    .me {
      align-self:flex-end; background:var(--bubble-me); color:#fff; margin-left:auto;
      border-bottom-right-radius:5px;
    }
    .them {
      align-self:flex-start; background:var(--bubble-them); color:#fff; margin-right:auto;
      border-bottom-left-radius:5px;
    }
    .centerSys {
      align-self:center;
      background:rgba(255,255,255,0.2);
      font-style:italic; text-align:center;
      max-width:none !important; width:auto; margin-left:auto; margin-right:auto;
    }
    .reactionTag {
      font-size:14px; opacity:0.8; position:absolute; top:5px; right:10px;
    }
    .reactionBar {
      position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
      display:none; flex-direction:row; gap:5px; background:rgba(0,0,0,0.6);
      padding:5px; border-radius:6px; margin-bottom:5px;
    }
    .reactionBar span { font-size:22px; cursor:pointer; }
    .timestamp {
      position:absolute; font-size:10px; opacity:0.7; bottom:-14px;
    }
    .mineTime { right:10px; }
    .otherTime { left:10px; }
    .readReceipt {
      font-size:12px; opacity:0.6; margin-top:2px;
    }
    #typingIndicator {
      display:none; font-style:italic; font-size:14px; margin:0 20px 10px;
    }
    #inputArea {
      display:flex; padding:10px; background:var(--sidebar-color);
    }
    #inputArea input { flex:1; margin-right:5px; font-size:17px; }
    #emojiPicker {
      display:none; position:absolute; bottom:70px; right:15px; background:var(--chat-bg);
      padding:10px; flex-wrap:wrap; z-index:99; max-width:340px; max-height:180px; overflow:auto;
    }
    #emojiPicker span { font-size:22px; margin:6px; cursor:pointer; }
    .chatItem {
      background:var(--chat-item-bg); padding:10px; border-radius:6px; margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:center;
      cursor:pointer; transition:background 0.2s;
    }
    .chatItem:hover { background:var(--bubble-them); }
    .chatItem.active { outline:2px solid var(--accent); }
    .chatBadge {
      background:var(--badge); color:#fff; font-size:12px; padding:3px 8px; border-radius:12px; margin-left:5px;
    }
    .requestItem {
      background:var(--bubble-them); padding:10px; margin-bottom:5px; border-radius:6px;
    }
    #staticMenu {
      position:fixed; bottom:10px; left:10px; background:#1e1e1e; color:#fff; padding:5px 8px;
      border-radius:8px; font-size:13px; box-shadow:0 0 6px #0ff; animation:blink 2s infinite; z-index:1000;
    }
    a.staticLink { color:#0ff; text-decoration:none; }
    @keyframes blink {
      0%,100% { opacity:1; }
      50% { opacity:0.6; }
    }
    .modal {
      position:fixed; inset:0; background:rgba(0,0,0,0.7);
      display:none; flex-direction:column; align-items:center; justify-content:center;
      z-index:999;
    }
    .modalContent {
      background:var(--chat-bg); padding:20px; border-radius:10px; max-width:400px; position:relative;
    }
    .closeBtn {
      position:absolute; top:10px; right:10px; background:red; color:#fff; border:none; cursor:pointer;
      border-radius:4px; padding:3px 8px;
    }
    #login {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.7); z-index:999;
    }
    #slashAutocomplete {
      display:none; position:absolute; background:var(--chat-bg);
      border-radius:6px; padding:5px; max-width:220px; z-index:9999;
    }
    #slashAutocomplete button {
      width:100%; display:block; text-align:left; margin:5px 0; padding:6px; border-radius:4px; border:none;
      background:var(--accent); cursor:pointer;
    }
  </style>
</head>
<body>
<!-- SCRIPTS (Firebase loaded in HEAD) -->
<script>
// === Generate or retrieve device-based ID ===
function genId(){
  return "dev_"+Math.random().toString(36).slice(2)+"_"+Date.now();
}
let myId=localStorage.getItem("myDeviceId");
if(!myId){
  myId=genId();
  localStorage.setItem("myDeviceId", myId);
}
let displayName=localStorage.getItem("displayName")||"";
let pass=localStorage.getItem("pass")||"";

</script>
<!-- MAIN APP HTML -->
<div id="login">
  <div style="background:var(--chat-bg);padding:20px;border-radius:10px;position:relative;">
    <h2>Static Live Chat</h2>
    <p>Your device ID: <span id="deviceIdSpan"></span></p>
    <label>Display Name (unique):</label><br/>
    <input id="username" placeholder="Name" onkeypress="if(event.key==='Enter')doLogin()"/><br/>
    <label>Password (for friend requests, optional):</label><br/>
    <div style="display:flex;">
      <input id="password" type="password" style="flex:1;" onkeypress="if(event.key==='Enter')doLogin()" />
      <button onclick="toggleLoginPass()">üëÅÔ∏è</button>
    </div>
    <button onclick="doLogin()">Log In</button>
  </div>
</div>

<div id="app" style="display:none;">
  <div id="sidebar">
    <button onclick="openFriendsPanel()">Friends</button>
    <button onclick="addFriendUI()">Add Friend</button>
    <button onclick="showAddChatPanel()">Add Chat</button>
    <h3>Friend Requests</h3>
    <div id="requestsTab"></div>
    <div id="requestsSentTab" style="margin-top:8px;color:#ccc;"></div>
    <hr/>
    <h3>Chats</h3>
    <div id="chatList"></div>
  </div>
  <div id="chatPanel">
    <div id="topBar">
      <div id="chatTitle">No Chat</div>
      <div>
        <button id="themeBtn" onclick="toggleTheme()">Dark: Theme</button>
        <button onclick="openSettings()">‚öôÔ∏è Settings</button>
      </div>
    </div>
    <div id="groupMembers" style="padding:5px 15px;display:none;font-size:14px;"></div>
    <div id="messages"></div>
    <div id="typingIndicator" style="display:none;"></div>
    <div id="inputArea">
      <input id="msgInput" placeholder="Type '/' for commands" oninput="slashAutoInput(event)" onkeypress="if(event.key==='Enter')sendMessage();" />
      <button onclick="toggleEmojiPicker()">üòÄ</button>
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="emojiPicker"></div>
    <div id="slashAutocomplete"></div>
  </div>
</div>

<div id="staticMenu">
  <a href="https://staticquasar931.github.io/" target="_blank" class="staticLink">More Unblocked Games by Static</a>
</div>

<!-- Additional modals: for group create/join, plus "help" chat is auto-added in code. -->
<script>
// ============ FIREBASE INIT ===========
if(typeof firebase==="undefined"){
  // If google sites blocks external scripts, might cause a reference error
  // We'll define a no-op fallback if needed
  console.log("Firebase not loaded. Possibly blocked by environment?");
  window.firebase={
    initializeApp:()=>{},
    database:()=>({ref:()=>({})}),
  };
}else{
  const firebaseConfig={
    apiKey:"AIzaSyBO7EHU4-_b2NHf7UFYTB8Wolv73Z0P8Fw",
    authDomain:"static-live-chatting.firebaseapp.com",
    databaseURL:"https://static-live-chatting-default-rtdb.firebaseio.com",
    projectId:"static-live-chatting",
    storageBucket:"static-live-chatting.appspot.com",
    messagingSenderId:"578562140653",
    appId:"1:578562140653:web:c12df07155627083e9dfe4"
  };
  firebase.initializeApp(firebaseConfig);
}
let db=null;
try{
  db=firebase.database();
}catch(e){
  console.log("Could not init firebase DB. Possibly blocked. " + e);
  db={
    ref:()=>({once:()=>{},on:()=>{},set:()=>{},push:()=>({})})
  };
}

// ============ GLOBALS =============
document.getElementById("deviceIdSpan").textContent=myId;
const slashCommands=[
  "/tod truth","/tod dare","/title",
  "/cf heads","/cf tails","/coin flip heads","/coin flip tails"
];

let colorMap={};
let blocked={}, friends={};
let currentChat="", currentType="";
let chatUnread={}; // store unread counts
let messagesRef=null, childAddedRef=null, childChangedRef=null;
let oldestKey=null, hasMoreOld=false;

// **Large T/D queues
let bigTruths=[
  "What is your biggest secret crush?",
  "Have you ever cheated on a test?",
  // etc. (Large list)
  "What‚Äôs the strangest dream you‚Äôve ever had?",
  "If you could be invisible for a day, what‚Äôs the first thing you‚Äôd do?",
  "What‚Äôs a silly fear you have?",
  "What‚Äôs your worst habit?",
  "Have you ever stolen anything?",
  "Who is your secret role model?",
  "What‚Äôs something you‚Äôre really bad at?",
  "What‚Äôs your biggest pet peeve?",
  "What‚Äôs the weirdest food combo you love?",
  "Who was your first crush?",
  "Have you ever faked being sick to skip something?",
  "What‚Äôs your guilty pleasure show?",
  "If you had one wish, what would it be?",
  "Have you ever lied to impress someone?",
];
let bigDares=[
  "Do a silly dance for 20 seconds.",
  "Text someone random ‚ÄòI love cheese!‚Äô",
  "Act like a monkey for 30 seconds.",
  "Try to stand on one foot for 60 seconds.",
  "Pretend you‚Äôre an alien for 1 minute.",
  "Spin around 10 times and then walk in a straight line.",
  "Do 5 push-ups, 5 jumping jacks, 5 sit-ups right now.",
  "Speak in a weird accent for your next 3 sentences.",
  "Attempt to lick your elbow on camera.",
  "Read your last text message out loud in a dramatic voice.",
  "Imitate a celebrity for 30 seconds.",
  "Try to do a backbend or a cartwheel (or pretend).",
  "Pretend your hand is a puppet and talk to it for 20 seconds.",
  "Sing your favorite song‚Äôs chorus right now.",
  "Walk around the room like a runway model.",
];
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()* (i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}
shuffle(bigTruths);
shuffle(bigDares);
function nextTruth(){
  let x=bigTruths.shift();
  bigTruths.push(x);
  return x;
}
function nextDare(){
  let x=bigDares.shift();
  bigDares.push(x);
  return x;
}

//** On load
window.addEventListener("DOMContentLoaded",()=>{
  if(displayName){
    // auto login
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="flex";
    applyTheme();
    loadBlocked();
    loadFriends();
    loadChats();
    loadRequests();
    setupHelpChat();
  }
});

//** doLogin
function doLogin(){
  const name=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value.trim();
  if(!name){ showNotice("Name can't be empty!"); return; }
  db.ref("displayNames/"+name).once("value",(snap)=>{
    const val=snap.val();
    if(val && val!==myId){
      showNotice("That display name is used by another device! Pick a different name.");
      return;
    }
    displayName=name; pass=p;
    localStorage.setItem("displayName",name);
    localStorage.setItem("pass",p);
    db.ref("displayNames/"+name).set(myId);
    db.ref("users/"+myId+"/displayName").set(name);
    // proceed
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="flex";
    applyTheme(); loadBlocked(); loadFriends(); loadChats(); loadRequests();
    setupHelpChat();
    showNotice(`Logged in as ${myId}, name: ${name}`);
  });
}

//** Theming
function applyTheme(){
  const saved=localStorage.getItem("theme")||"dark";
  document.body.classList.remove("light","blue","green","pink");
  if(saved==="light") document.body.classList.add("light");
  else if(saved==="blue") document.body.classList.add("blue");
  else if(saved==="green") document.body.classList.add("green");
  else if(saved==="pink") document.body.classList.add("pink");
  setThemeBtnLabel(saved);
}
function toggleTheme(){
  const c=(document.body.classList.contains("light")?"light":
           document.body.classList.contains("blue")?"blue":
           document.body.classList.contains("green")?"green":
           document.body.classList.contains("pink")?"pink":"dark");
  let next="dark";
  if(c==="dark") next="light";
  else if(c==="light") next="blue";
  else if(c==="blue") next="green";
  else if(c==="green") next="pink";
  else if(c==="pink") next="dark";
  document.body.classList.remove("light","blue","green","pink");
  if(next==="light") document.body.classList.add("light");
  if(next==="blue") document.body.classList.add("blue");
  if(next==="green") document.body.classList.add("green");
  if(next==="pink") document.body.classList.add("pink");
  localStorage.setItem("theme",next);
  setThemeBtnLabel(next);
}
function setThemeBtnLabel(t){
  document.getElementById("themeBtn").textContent=`${t}: Theme`;
}

//** Help chat pinned
function setupHelpChat(){
  db.ref(`users/${myId}/chats/help_chat`).set({
    name:"Help (info)",type:"help", last:0
  });
}

//** load watchers for blocked/friends
function loadBlocked(){
  db.ref(`users/${myId}/blocked`).on("value",(snap)=>{
    blocked=snap.val()||{};
  });
}
function loadFriends(){
  db.ref(`users/${myId}/friends`).on("value",(snap)=>{
    friends=snap.val()||{};
  });
}

//** watchers for user chats => see if new messages come in ANY chat for unread
db.ref(`users/${myId}/chats`).on("value",(snap)=>{
  const data=snap.val()||{};
  // We watch each chat‚Äôs messages for new arrivals if it‚Äôs not the currently open chat
  Object.keys(data).forEach(chatId=>{
    if(chatId==="help_chat") return; // skip help
    const cinfo=data[chatId];
    attachChatWatcher(chatId,cinfo.type||"private");
  });
  // then update the chatList UI
  updateChatList(data);
});
function attachChatWatcher(chatId, cType){
  // If we already have watchers for the currently open chat, skip
  // We'll do a separate 'child_added' that triggers if not the open chat
  const path=(cType==="group"?"groupChats":"privateChats")+"/"+chatId+"/messages";
  db.ref(path).off("child_added", handleChatMessage);
  db.ref(path).on("child_added", handleChatMessage);
  function handleChatMessage(snap){
    if(chatId===currentChat){
      // we're in that chat, no need to increment
      return;
    }
    // else increment unread
    chatUnread[chatId]=(chatUnread[chatId]||0)+1;
    updateDocumentTitle();
    updateChatListUI(); 
  }
}
function updateChatList(data){
  // called initially
  updateChatListUI(data);
}
function updateChatListUI(data){
  if(!data){
    db.ref(`users/${myId}/chats`).once("value",(snap)=>{
      data=snap.val()||{};
      doUpdateList(data);
    });
  } else doUpdateList(data);
}
function doUpdateList(chatsObj){
  // sort help_chat last
  const sorted=Object.entries(chatsObj).sort((a,b)=>{
    if(a[0]==="help_chat") return 1;
    if(b[0]==="help_chat") return -1;
    return (b[1].last||0)-(a[1].last||0);
  });
  const clist=document.getElementById("chatList");
  clist.innerHTML="";
  sorted.forEach(([id,info])=>{
    const div=document.createElement("div");
    div.className="chatItem";
    if(id===currentChat) div.classList.add("active");
    let nm=info.name||id;
    if(info.type==="private" && blocked[nm]) nm+=" [Blocked]";
    if(info.type==="help") nm="Help (info)";
    div.textContent=nm;
    // row right
    const rowR=document.createElement("div");
    rowR.style.display="flex"; rowR.style.alignItems="center";
    if(chatUnread[id]){
      const bd=document.createElement("span");
      bd.className="chatBadge";
      bd.textContent="+"+chatUnread[id];
      rowR.appendChild(bd);
    }
    if(info.type!=="help"){
      const delBtn=document.createElement("button");
      delBtn.textContent="üóë";
      delBtn.onclick=(ev)=>{
        ev.stopPropagation();
        confirmDeleteChat(id,info);
      };
      rowR.appendChild(delBtn);
    }
    div.appendChild(rowR);
    div.onclick=()=>{
      if(info.type==="help"){
        openHelpChat();
      } else {
        openChat(id,nm,info.type);
      }
    };
    clist.appendChild(div);
  });
}

//** open a chat
function openChat(chatId,name,cType){
  currentChat=chatId; currentType=cType;
  chatUnread[chatId]=0;
  updateDocumentTitle();
  updateChatListUI(); 
  // reset watchers for this chat to display messages
  if(messagesRef){
    if(childAddedRef) messagesRef.off("child_added", childAddedRef);
    if(childChangedRef) messagesRef.off("child_changed", childChangedRef);
  }
  document.getElementById("chatTitle").textContent=name;
  document.getElementById("groupMembers").style.display=(cType==="group")?"block":"none";
  const msgs=document.getElementById("messages");
  msgs.innerHTML="";
  oldestKey=null; hasMoreOld=false; // we'll do a simple approach
  let path=(cType==="group"?"groupChats":"privateChats")+"/"+chatId+"/messages";
  messagesRef=db.ref(path);
  // load 50 messages
  messagesRef.orderByChild("timestamp").limitToLast(50).once("value",(snap)=>{
    const data=snap.val()||{};
    let arr=Object.entries(data).sort((a,b)=>(a[1].timestamp||0)-(b[1].timestamp||0));
    arr.forEach(([mId,mVal])=> createBubble(mId,mVal,true));
    if(arr.length>=50) hasMoreOld=true;
    attachDisplayWatchers();
    // scroll to bottom
    msgs.scrollTop=msgs.scrollHeight;
  });
  // for group members
  if(cType==="group"){
    db.ref("groupChats/"+chatId+"/members").on("value",(snap2)=>{
      const mm=Object.keys(snap2.val()||{});
      document.getElementById("groupMembers").textContent="Members: "+mm.join(", ");
    });
  }
  attachTypingListener();
  db.ref(`users/${myId}/chats/${chatId}/last`).set(Date.now());
  // re-enable input if was help
  document.getElementById("msgInput").disabled=(cType==="help");
}

function attachDisplayWatchers(){
  childAddedRef=messagesRef.orderByChild("timestamp").startAt(Date.now()).on("child_added",(snap)=>{
    // new message appended
    const val=snap.val();
    createBubble(snap.key,val,true);
    // scroll
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
  });
  childChangedRef=messagesRef.on("child_changed",(snap)=>{
    const val=snap.val();
    updateBubble(snap.key,val);
  });
}

function createBubble(mId,val,toEnd){
  const container=document.getElementById("messages");
  if(document.getElementById("msg_"+mId)) return;
  let bub=document.createElement("div");
  bub.id="msg_"+mId;
  bub.className="msg";
  if(val.sender===myId) bub.classList.add("me");
  else if(val.sender==="_system") bub.classList.add("centerSys");
  else bub.classList.add("them");
  let text=val.text||"";
  bub.innerHTML=text;
  // if group & not me & not system => label with sender color
  if(currentType==="group" && val.sender!==myId && val.sender!=="_system"){
    let cc=getColorClass(val.sender);
    bub.innerHTML=`<span class="${cc}" style="font-weight:bold;">${val.sender}:</span> `+bub.innerHTML;
  }
  // reaction
  let rt=document.createElement("span");
  rt.className="reactionTag";
  if(val.reaction) rt.textContent=val.reaction;
  bub.appendChild(rt);
  // reaction bar
  let rBar=document.createElement("div");
  rBar.className="reactionBar";
  ["‚ù§Ô∏è","üëç","üòÇ","üòÆ","üò¢"].forEach(r=>{
    let s=document.createElement("span");
    s.textContent=r;
    s.onclick=(e)=>{
      e.stopPropagation();
      applyReaction(mId,r);
      rBar.style.display="none";
    };
    rBar.appendChild(s);
  });
  bub.appendChild(rBar);
  bub.addEventListener("dblclick", e=>{
    rBar.style.display=(rBar.style.display==="flex")?"none":"flex";
  });
  bub.addEventListener("contextmenu", e=>{
    e.preventDefault();
    if(currentType==="group"){
      db.ref(`groupChats/${currentChat}/createdBy`).once("value",(snap)=>{
        if(snap.val()===myId){
          showConfirm("Remove this message?",()=>{
            db.ref(`groupChats/${currentChat}/messages/${mId}`).remove();
            let existing=document.getElementById("msg_"+mId);
            if(existing) existing.remove();
          });
        }
      });
    }
  });
  // time
  let time=document.createElement("div");
  time.className="timestamp";
  let t2=val.timestamp? new Date(val.timestamp).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}): "";
  time.textContent=t2;
  bub.appendChild(time);
  if(val.sender===myId) time.classList.add("mineTime");
  else if(val.sender==="_system"){} 
  else time.classList.add("otherTime");
  if(toEnd) container.appendChild(bub);
  else container.prepend(bub);
  container.scrollTop=container.scrollHeight;
}
function updateBubble(mId,val){
  let b=document.getElementById("msg_"+mId);
  if(!b) return;
  let rt=b.querySelector(".reactionTag");
  if(rt) rt.textContent=val.reaction||"";
}

//** handle theme button label
function setThemeBtnLabel(tName){
  document.getElementById("themeBtn").textContent=`${tName}: Theme`;
}

//** slash commands
function slashAutoInput(e){
  let val=e.target.value;
  const box=document.getElementById("slashAutocomplete");
  if(!val.startsWith("/")){
    box.style.display="none";
    return;
  }
  // position near the input
  let inputRect=e.target.getBoundingClientRect();
  box.style.left=(inputRect.left)+"px";
  box.style.top=(inputRect.top-100)+"px"; // above the input
  box.innerHTML="";
  let hits=slashCommands.filter(c=>c.startsWith(val));
  if(!hits.length){
    box.style.display="none";
    return;
  }
  box.style.display="block";
  hits.forEach(h=>{
    let b=document.createElement("button");
    b.textContent=h;
    b.onclick=()=>{
      document.getElementById("msgInput").value=h+" ";
      box.style.display="none";
    };
    box.appendChild(b);
  });
}

//** toggling emoji
function toggleEmojiPicker(){
  let ep=document.getElementById("emojiPicker");
  if(ep.style.display==="flex"){
    ep.style.display="none";
    return;
  }
  ep.innerHTML="";
  ep.style.display="flex";
  let bigEmojis=[... "üòÄüòÉüòÑüòÅüòÜüòÖüòÇü§£üòäüòáüôÇüôÉüòâüòåüòçüòòü•∞üòóüòôüòöüòãüòõüòùüòúü§™ü§®üßêü§ìüòéü•∏ü§©ü•≥üòèüòíüòûüòîüòüüòïüôÅ‚òπÔ∏èüò£üòñüò´üò©ü•∫üò¢üò≠üò§üò†üò°ü§¨ü§Øüò≥ü•µü•∂üò±üò®üò∞üò•üòìü§óü§îü§≠ü§´ü§•üò∂üòêüòëüôÑüòØüò¶üòßüòÆüò≤ü•±üò¥üò™üòµüòµ‚Äçüí´üò∑ü§íü§ïü§¢ü§Æü§ßüòáüòàüëøüëªüíÄ‚ò†Ô∏èüëΩü§ñüéÉüò∫üò∏üòπüòªüòºüòΩüôÄüòøüòæ"];
  bigEmojis.forEach(e=>{
    let s=document.createElement("span");
    s.textContent=e;
    s.onclick=()=>{
      let inp=document.getElementById("msgInput");
      inp.value+= e;
      ep.style.display="none";
    };
    ep.appendChild(s);
  });
}

//** addFriendUI
function addFriendUI(){
  let msg=`Enter friend's device ID:<br/><input id='friendIdInput'/>`;
  showConfirm(msg,()=>{
    let fId=document.getElementById("friendIdInput").value.trim();
    if(!fId){ showNotice("No device ID typed!"); return; }
    if(fId===myId){ showNotice("Can't friend yourself!"); return; }
    if(blocked[fId]){ showNotice("Unblock them first!"); return; }
    // check if user exists
    db.ref("users/"+fId+"/displayName").once("value",(snap)=>{
      if(!snap.exists()){
        showNotice(`That user ID ${fId} doesn't exist!`);
        return;
      }
      // check if already friends
      if(friends[fId]){
        showNotice(`You're already friends with ${fId}!`);
        return;
      }
      // check if there's a pending request
      db.ref(`users/${myId}/requestsSent/${fId}`).once("value",(s2)=>{
        if(s2.exists()){
          showNotice(`Already have a request with ${fId}. Wait for them to accept.`);
          return;
        }
        // send request
        db.ref(`users/${fId}/requests/${myId}`).set({requested:true});
        db.ref(`users/${myId}/requestsSent/${fId}`).set(true);
        db.ref(`privateChats/${[myId,fId].sort().join("_")}`).set({});
        showNotice(`Friend request sent to ${fId}`);
      });
    });
  });
}

//** openFriendsPanel
function openFriendsPanel(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Your Friends</h3>
      <div id="frList"></div>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  let frL=mo.querySelector("#frList");
  if(!friends || !Object.keys(friends).length){
    frL.textContent="No friends yet!";
  } else {
    Object.keys(friends).forEach(fId=>{
      let d=document.createElement("div");
      d.style.background="var(--chat-bg)";
      d.style.padding="8px";
      d.style.marginBottom="8px";
      d.style.borderRadius="6px";
      d.textContent=`Friend ID: ${fId}`;
      frL.appendChild(d);
    });
  }
  mo.addEventListener("click",(ev)=>{
    if(ev.target===mo) document.body.removeChild(mo);
  });
}

//** group create/join
function showAddChatPanel(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Add Chat</h3>
      <button onclick="showCreatePanel();document.body.removeChild(this.closest('.modal'))">Create Group</button><br/>
      <button onclick="showJoinPanel();document.body.removeChild(this.closest('.modal'))">Join Group</button><br/>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(e)=>{
    if(e.target===mo) document.body.removeChild(mo);
  });
}
function showCreatePanel(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:300px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Create Group</h3>
      <input id="groupName" placeholder="Group Name"/><br/>
      <select id="groupType">
        <option value="open">Open</option>
        <option value="password">Password</option>
        <option value="invite">Invite Only</option>
      </select><br/>
      <input id="groupPassword" placeholder="Password (optional)"/><br/>
      <button id="createGroupBtn">Create</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(e)=>{
    if(e.target===mo) document.body.removeChild(mo);
  });
  mo.querySelector("#createGroupBtn").onclick=()=>{
    let nm=mo.querySelector("#groupName").value.trim();
    let ty=mo.querySelector("#groupType").value;
    let pw=mo.querySelector("#groupPassword").value.trim();
    if(!nm){ showNotice("No group name!"); return; }
    let gid="group_"+Date.now();
    let members={}; members[myId]=true;
    db.ref(`groupChats/${gid}`).set({name:nm,type:ty,password:pw,createdBy:myId,members});
    db.ref(`users/${myId}/chats/${gid}`).set({name:nm,type:"group",last:Date.now()});
    document.body.removeChild(mo);
    openChat(gid,nm,"group");
  };
}
function showJoinPanel(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:300px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Join Group Chat</h3>
      <input id="joinGroupID" placeholder="Group ID"/><br/>
      <input id="joinGroupPassword" placeholder="Password (if needed)"/><br/>
      <button id="joinGroupBtn">Join</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(e)=>{
    if(e.target===mo) document.body.removeChild(mo);
  });
  mo.querySelector("#joinGroupBtn").onclick=()=>{
    let id=mo.querySelector("#joinGroupID").value.trim();
    let pw=mo.querySelector("#joinGroupPassword").value.trim();
    if(!id){ showNotice("No group ID typed!"); return; }
    db.ref("groupChats/"+id).once("value",(snap)=>{
      let g=snap.val();
      if(!g){ showNotice("Group not found!"); return; }
      if(g.type==="password" && g.password!==pw){ showNotice("Wrong password!"); return; }
      if(g.type==="invite" && !(g.members && g.members[myId])){ showNotice("You are not invited!"); return; }
      db.ref(`groupChats/${id}/members/${myId}`).set(true);
      db.ref(`users/${myId}/chats/${id}`).set({name:g.name,type:"group",last:Date.now()});
      document.body.removeChild(mo);
      openChat(id,g.name,"group");
    });
  };
}

//** Settings
function openSettings(){
  let mo=document.createElement("div");
  mo.className="modal";
  mo.innerHTML=`
    <div class="modalContent" style="min-width:320px;">
      <button class="closeBtn" onclick="document.body.removeChild(this.parentElement.parentElement)">X</button>
      <h3>Settings</h3>
      <label>Display Name:</label><br/>
      <input id="editDisplay" value="${displayName}"/><br/>
      <label>Password (for friend requests, optional):</label><br/>
      <input id="editPass" value="${pass}"/><br/>
      <button id="saveSetBtn">Save</button>
    </div>
  `;
  document.body.appendChild(mo);
  mo.style.display="flex";
  mo.addEventListener("click",(e)=>{
    if(e.target===mo) document.body.removeChild(mo);
  });
  mo.querySelector("#saveSetBtn").onclick=()=>{
    let newD=mo.querySelector("#editDisplay").value.trim();
    let newP=mo.querySelector("#editPass").value.trim();
    if(!newD){ showNotice("Name can't be empty!"); return; }
    db.ref("displayNames/"+newD).once("value",(snap)=>{
      let val=snap.val();
      if(val && val!==myId){
        showNotice("That name is used by another device! Try another name.");
        return;
      }
      // good
      displayName=newD; pass=newP;
      localStorage.setItem("displayName", newD);
      localStorage.setItem("pass", newP);
      db.ref("displayNames/"+newD).set(myId);
      db.ref(`users/${myId}/displayName`).set(newD);
      showNotice("Settings saved!");
      document.body.removeChild(mo);
    });
  };
}

//** slash commands
function processSlashCommand(cmd){
  let parts=cmd.split(" ");
  let slash=parts[0];
  if(slash==="/tod"){
    if(parts[1]==="truth"){
      let t=nextTruth();
      sendSystemMessage(t);
    } else if(parts[1]==="dare"){
      let d=nextDare();
      sendSystemMessage(d);
    } else {
      showNotice("Usage: /tod truth or /tod dare");
    }
  } else if(slash==="/title"){
    let txt=parts.slice(1).join(" ");
    if(!txt) { showNotice("Usage: /title <text>"); return; }
    sendSystemMessage(`<< ${txt} >>`);
  } else if(slash==="/cf" || slash==="/coin"){
    let guess="";
    if(slash==="/cf") guess= parts[1]||"";
    else {
      // /coin flip heads
      if(parts[1]==="flip") guess=parts[2]||"";
    }
    guess=guess.toLowerCase();
    if(guess!=="heads"&& guess!=="tails"){
      showNotice(`Usage: ${slash} heads or ${slash} tails (or /coin flip heads/tails)`);
      return;
    }
    let coin=Math.random()<0.5? "heads":"tails";
    let res=(coin===guess)? "wins":"loses";
    sendSystemMessage(`Coin flipped on ${coin}, user ${displayName} ${res}!`);
  } else {
    showNotice(`Unknown command: ${cmd}`);
  }
}
function sendSystemMessage(txt){
  if(!currentChat || currentType==="help") return;
  let path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/messages`).push({
    sender:"_system",
    text:txt,
    timestamp:Date.now(),
    reaction:"",
    readBy:{}
  });
}

//** send normal message
function sendMessage(){
  if(!currentChat || currentType==="help") return;
  let inp=document.getElementById("msgInput");
  let text=inp.value.trim();
  if(!text) return;
  document.getElementById("slashAutocomplete").style.display="none";
  if(text.startsWith("/")){
    processSlashCommand(text);
    inp.value="";
    return;
  }
  let friendName=document.getElementById("chatTitle").textContent;
  if(currentType==="private" && blocked[friendName]){
    showNotice("You blocked them. Unblock first!");
    return;
  }
  let p=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${p}/${currentChat}/messages`).push({
    sender:myId,
    text,
    timestamp:Date.now(),
    reaction:"",
    readBy:{[myId]:Date.now()}
  });
  inp.value="";
  // scroll
  document.getElementById("messages").scrollTop=document.getElementById("messages").scrollHeight;
}

//** on input
function slashAutoInput(e){
  let val=e.target.value;
  let slashBox=document.getElementById("slashAutocomplete");
  if(!val.startsWith("/")){
    slashBox.style.display="none";
    return;
  }
  slashBox.innerHTML="";
  let inputRect=e.target.getBoundingClientRect();
  slashBox.style.left=(inputRect.left)+"px";
  slashBox.style.top=(inputRect.top-110)+"px";
  let hits=slashCommands.filter(c=> c.startsWith(val));
  if(!hits.length){
    slashBox.style.display="none";
    return;
  }
  slashBox.style.display="block";
  hits.forEach(h=>{
    let b=document.createElement("button");
    b.textContent=h;
    b.onclick=()=>{
      e.target.value=h+" ";
      slashBox.style.display="none";
    };
    slashBox.appendChild(b);
  });
}

//** apply reaction
function applyReaction(mId, reac){
  if(!currentChat || currentType==="help") return;
  let p=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${p}/${currentChat}/messages/${mId}/reaction`).set(reac);
}

//** Mark typing
function sendTyping(){
  if(!currentChat||currentType==="help") return;
  let p=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${p}/${currentChat}/typing`).set(displayName);
  setTimeout(()=>{
    db.ref(`${p}/${currentChat}/typing`).set("");
  },2000);
}
function attachTypingListener(){
  if(!currentChat||currentType==="help") return;
  let p=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${p}/${currentChat}/typing`).off();
  db.ref(`${p}/${currentChat}/typing`).on("value",(snap)=>{
    let val=snap.val();
    let tInd=document.getElementById("typingIndicator");
    if(val && val!==displayName){
      tInd.style.display="block";
      tInd.textContent=`${val} is typing...`;
    } else tInd.style.display="none";
  });
}

//** color classes
function getColorClass(u){
  if(!colorMap[u]){
    let c=["nameColor1","nameColor2","nameColor3","nameColor4","nameColor5"];
    colorMap[u]=c[Math.floor(Math.random()* c.length)];
  }
  return colorMap[u];
}

//** Title +n missed
function updateDocumentTitle(){
  let totalMissed=Object.values(chatUnread).reduce((a,b)=>a+b,0);
  if(totalMissed>0){
    document.title=`(${totalMissed}) Static Live Chat`;
  } else {
    document.title="Static Live Chat";
  }
}

//** DONE
console.log("All script loaded, we patched all bugs, user can chat with slash commands and everything!");
</script>

<!-- Example rules:
{
  "rules": {
    ".read":true,
    ".write":true,
    "users":{
      "$deviceId":{ ".read":true, ".write":true }
    },
    "privateChats":{
      "$chatId":{ ".read":true, ".write":true }
    },
    "groupChats":{
      "$groupId":{ ".read":true, ".write":true }
    },
    "displayNames":{
      "$name":{ ".read":true, ".write":true }
    }
  }
}
-->
</body>
</html>
