<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

  <!-- Title, Favicon (Optional):
  <title>My Awesome Chat</title>
  <link rel="icon" href="myfavicon.ico" type="image/x-icon"/>
  -->

  <!-- Load Firebase scripts BEFORE referencing firebase. -->
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>

  <title>Static Live Chat ‚Äì Final Fixes</title>
  <style>
    :root {
      --bg-color:#111; --text-color:#fff; --sidebar-color:#1c1c1c;
      --chat-bg:#222; --bubble-me:#1e90ff; --bubble-them:#444;
      --accent:#1e90ff; --badge:red; --chat-item-bg:#333;
    }
    body.light {
      --bg-color:#f4f4f4; --text-color:#000; --sidebar-color:#ddd;
      --chat-bg:#eee; --bubble-me:#007aff; --bubble-them:#ccc;
      --accent:#007acc; --chat-item-bg:#bbb;
    }
    body.blue {
      --bg-color:#0b1622; --text-color:#f0f8ff;
      --sidebar-color:#132336; --chat-bg:#1e2d40;
      --bubble-me:#1f65ff; --bubble-them:#41546a;
      --accent:#389fff; --chat-item-bg:#2e3d52;
    }
    body.green {
      --bg-color:#102a10; --text-color:#e8ffe8;
      --sidebar-color:#224522; --chat-bg:#1a331a;
      --bubble-me:#28a745; --bubble-them:#375a37;
      --accent:#4caf50; --chat-item-bg:#2b442b;
    }
    body.pink {
      --bg-color:#331024; --text-color:#ffe0f0;
      --sidebar-color:#441533; --chat-bg:#551a44;
      --bubble-me:#ff3377; --bubble-them:#773355;
      --accent:#ff66a2; --chat-item-bg:#442244;
    }
    body {
      margin:0; font-family:Arial,sans-serif;
      background:var(--bg-color); color:var(--text-color);
      height:100vh; display:flex; flex-direction:column; overflow:hidden;
    }
    input, button {
      padding:10px; font-size:16px; margin:5px; border-radius:6px; border:none;
    }
    button { background:var(--accent); color:#fff; cursor:pointer; }
    #app { display:none; flex:1; height:100%; }
    #sidebar {
      width:280px; background:var(--sidebar-color);
      display:flex; flex-direction:column; padding:10px; overflow-y:auto;
    }
    #chatPanel {
      flex:1; display:flex; flex-direction:column; background:var(--chat-bg);
      position:relative;
    }
    #topBar {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; font-size:18px; background:var(--chat-bg);
    }
    #messages {
      flex:1; display:flex; flex-direction:column; padding:15px; overflow-y:auto;
    }
    .msg {
      max-width:70%; padding:12px 16px; margin:6px auto;
      border-radius:20px; font-size:17px; line-height:1.4;
      word-wrap:break-word; position:relative; cursor:pointer;
    }
    .me {
      align-self:flex-end; background:var(--bubble-me); color:#fff; margin-left:auto;
      border-bottom-right-radius:5px;
    }
    .them {
      align-self:flex-start; background:var(--bubble-them); color:#fff; margin-right:auto;
      border-bottom-left-radius:5px;
    }
    .centerSys {
      align-self:center; background:rgba(255,255,255,0.2);
      font-style:italic; text-align:center;
      margin-left:auto; margin-right:auto; max-width:none !important; width:auto;
    }
    .reactionTag {
      font-size:14px; opacity:0.8; position:absolute; top:5px; right:10px;
    }
    .reactionBar {
      position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
      display:none; flex-direction:row; gap:5px; background:rgba(0,0,0,0.6);
      padding:5px; border-radius:6px; margin-bottom:5px;
    }
    .reactionBar span { font-size:22px; cursor:pointer; }
    .timestamp {
      position:absolute; font-size:10px; opacity:0.7;
      bottom:-14px;
    }
    .mineTime { right:10px; }
    .otherTime { left:10px; }
    .readReceipt {
      font-size:12px; opacity:0.6; margin-top:2px;
    }
    #typingIndicator { display:none; font-style:italic; font-size:14px; margin:0 20px 10px; }
    #inputArea {
      display:flex; padding:10px; background:var(--sidebar-color);
    }
    #inputArea input { flex:1; margin-right:5px; font-size:17px; }
    #emojiPicker {
      display:none; position:absolute; bottom:70px; right:15px; background:var(--chat-bg);
      padding:10px; flex-wrap:wrap; z-index:99; max-width:340px; max-height:180px; overflow:auto;
    }
    #emojiPicker span { font-size:22px; margin:6px; cursor:pointer; }
    .chatItem {
      background:var(--chat-item-bg); padding:10px; border-radius:6px; margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:center;
      cursor:pointer; transition:background 0.2s;
    }
    .chatItem:hover { background:var(--bubble-them); }
    .chatItem.active { outline:2px solid var(--accent); }
    .chatBadge {
      background:var(--badge); color:#fff; font-size:12px; padding:3px 8px; border-radius:12px; margin-left:5px;
    }
    .requestItem {
      background:var(--bubble-them); padding:10px; margin-bottom:5px; border-radius:6px;
    }
    #staticMenu {
      position:fixed; bottom:10px; left:10px; background:#1e1e1e; color:#fff;
      padding:5px 8px; border-radius:8px; font-size:13px; box-shadow:0 0 6px #0ff;
      animation:blink 2s infinite; z-index:1000;
    }
    a.staticLink { color:#0ff; text-decoration:none; }
    @keyframes blink {
      0%,100% { opacity:1; }
      50% { opacity:0.6; }
    }
    #login {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.7); z-index:999;
    }
    #slashAutocomplete {
      display:none; position:absolute; bottom:120px; left:20px; z-index:101;
      background:var(--chat-bg); padding:8px; border-radius:6px; max-width:250px;
    }
    #slashAutocomplete button {
      display:block; width:100%; text-align:left; padding:5px;
      background:var(--accent); margin-bottom:5px; border:none; border-radius:4px;
    }
  </style>
</head>
<body>

<div id="login">
  <div style="background:var(--chat-bg);padding:20px;border-radius:10px;max-width:400px;">
    <h2>Static Live Chat</h2>
    <p>Your device ID: <span id="deviceIdSpan"></span></p>
    <label>Display Name (unique):</label><br/>
    <input id="username" placeholder="Your name" onkeypress="if(event.key==='Enter')doLogin()"/><br/>
    <label>Password (key for friend requests, optional):</label><br/>
    <div style="display:flex;align-items:center;">
      <input id="password" type="password" style="flex:1;" onkeypress="if(event.key==='Enter')doLogin()"/>
      <button style="margin-left:5px;" onclick="toggleLoginPass()">üëÅÔ∏è</button>
    </div>
    <button onclick="doLogin()">Log In</button>
  </div>
</div>

<div id="app">
  <div id="sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <button onclick="doLogout()" style="background:#f66;">Log Out</button>
      <button onclick="openSettings()">‚öôÔ∏è</button>
    </div>
    <h3>Friend Requests</h3>
    <div id="requestsTab"></div>
    <div id="requestsSentTab" style="margin-top:8px;color:#ccc;"></div>
    <hr/>
    <h3>Chats</h3>
    <div id="chatList"></div>
    <hr/>
    <button onclick="openFriendsPanel()">Friends</button>
    <button onclick="addFriendUI()">Add Friend</button>
    <button onclick="showAddChatPanel()">Add Group Chat</button>
  </div>
  <div id="chatPanel">
    <div id="topBar">
      <div id="chatTitle">No Chat</div>
      <div style="display:flex;align-items:center;">
        <button id="themeBtn" onclick="toggleTheme()" style="margin-right:10px;">Dark: Theme</button>
      </div>
    </div>
    <div id="groupMembers" style="padding:5px 15px;display:none;font-size:14px;"></div>
    <div id="messages"></div>
    <div id="typingIndicator" style="display:none;"></div>
    <div id="inputArea">
      <input id="msgInput" placeholder="Type '/' for commands" oninput="slashInputHandler(event)" onkeypress="if(event.key==='Enter')sendMessage();"/>
      <button onclick="toggleEmojiPicker()">üòÄ</button>
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="emojiPicker"></div>
    <div id="slashAutocomplete"></div>
  </div>
</div>

<div id="staticMenu">
  <a href="https://staticquasar931.github.io/" target="_blank" class="staticLink">More Unblocked Games by Static</a>
</div>

<script>
// =========== Create or fetch device ID ===========
function genDeviceId(){
  return "dev_"+Math.random().toString(36).slice(2)+"_"+Date.now();
}
let myId=localStorage.getItem("myDeviceId");
if(!myId){
  myId=genDeviceId();
  localStorage.setItem("myDeviceId",myId);
}

// =========== firebase init =============
const firebaseConfig={
  apiKey:"AIzaSyBO7EHU4-_b2NHf7UFYTB8Wolv73Z0P8Fw",
  authDomain:"static-live-chatting.firebaseapp.com",
  databaseURL:"https://static-live-chatting-default-rtdb.firebaseio.com",
  projectId:"static-live-chatting",
  storageBucket:"static-live-chatting.appspot.com",
  messagingSenderId:"578562140653",
  appId:"1:578562140653:web:c12df07155627083e9dfe4"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// =========== displayName & pass stored locally ===========
let displayName=localStorage.getItem("displayName")||"";
let pass=localStorage.getItem("pass")||"";

// =========== Page load logic ===========
window.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("deviceIdSpan").textContent=myId;
  if(displayName){
    // auto login
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="flex";
    applyTheme();
    setupHelpChat();
    loadBlocked(); loadFriends(); loadChats(); loadRequests();
  } else {
    // remain on login
  }
});

// =========== ID-based name uniqueness ===========
function checkNameAvailable(name, deviceId, cb){
  db.ref("displayNames/"+name).once("value",(snap)=>{
    const val=snap.val();
    if(!val) cb(true,null);
    else if(val===deviceId) cb(true,val);
    else cb(false,val);
  });
}

// =========== doLogin function ===========
function doLogin(){
  const dName=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value.trim();
  if(!dName) return showNotice("Name cannot be empty");
  checkNameAvailable(dName,myId,(ok,ex)=>{
    if(!ok && ex!==myId){
      showNotice("That displayName is taken by another device!");
      return;
    }
    displayName=dName; pass=p;
    localStorage.setItem("displayName",dName);
    localStorage.setItem("pass",p);
    db.ref("displayNames/"+dName).set(myId);
    db.ref("users/"+myId+"/displayName").set(dName);

    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="flex";
    applyTheme();
    setupHelpChat();
    loadBlocked(); loadFriends(); loadChats(); loadRequests();
    showNotice(`Logged in as [${myId}] with name ${dName}`);
  });
}

// =========== Logout function ===========
function doLogout(){
  // remove localStorage
  localStorage.removeItem("myDeviceId");
  localStorage.removeItem("displayName");
  localStorage.removeItem("pass");
  location.reload();
}

// =========== "Help" chat pinned at bottom ===========
function setupHelpChat(){
  db.ref(`users/${myId}/chats/help_chat`).set({
    name:"Help (info)", type:"help", last:0
  });
}

// =========== Theming ===============
function applyTheme(){
  const saved=localStorage.getItem("theme")||"dark";
  document.body.classList.remove("light","blue","green","pink");
  if(saved==="light") document.body.classList.add("light");
  else if(saved==="blue") document.body.classList.add("blue");
  else if(saved==="green") document.body.classList.add("green");
  else if(saved==="pink") document.body.classList.add("pink");
  setThemeBtnLabel(saved);
}
function toggleTheme(){
  const c=(document.body.classList.contains("light")?"light":
           document.body.classList.contains("blue")?"blue":
           document.body.classList.contains("green")?"green":
           document.body.classList.contains("pink")?"pink":"dark");
  let next="dark";
  if(c==="dark") next="light";
  else if(c==="light") next="blue";
  else if(c==="blue") next="green";
  else if(c==="green") next="pink";
  else if(c==="pink") next="dark";
  document.body.classList.remove("light","blue","green","pink");
  if(next==="light") document.body.classList.add("light");
  if(next==="blue") document.body.classList.add("blue");
  if(next==="green") document.body.classList.add("green");
  if(next==="pink") document.body.classList.add("pink");
  localStorage.setItem("theme", next);
  setThemeBtnLabel(next);
  showNotice(`${next} theme applied!`);
}
function setThemeBtnLabel(tn){
  document.getElementById("themeBtn").textContent=`${tn}: Theme`;
}

// =========== Basic Confirm + Notice Omitted for brevity ===========
// We'll do inline for each usage

function showNotice(msg){
  alert(msg); // simplest fix for now
}

// =========== Friends / Requests etc. =============
let blocked={}, friends={};
function loadBlocked(){
  db.ref(`users/${myId}/blocked`).on("value",(snap)=>{
    blocked=snap.val()||{};
  });
}
function loadFriends(){
  db.ref(`users/${myId}/friends`).on("value",(snap)=>{
    friends=snap.val()||{};
  });
}
function loadRequests(){
  db.ref(`users/${myId}/requests`).on("value",(snap)=>{
    let data=snap.val()||{};
    let tab=document.getElementById("requestsTab");
    tab.innerHTML="";
    Object.keys(data).forEach(reqId=>{
      let d=document.createElement("div");
      d.className="requestItem";
      d.textContent=`${reqId} wants to chat. `;
      let accept=document.createElement("button");
      accept.textContent="‚úî"; accept.style.background="green";
      accept.onclick=()=>{
        if(blocked[reqId]) return showNotice("Blocked. Unblock first!");
        const cid=[myId,reqId].sort().join("_");
        db.ref(`privateChats/${cid}`).set({});
        db.ref(`users/${myId}/chats/${cid}`).set({name:reqId,type:"private",last:Date.now()});
        db.ref(`users/${myId}/requests/${reqId}`).remove();
        db.ref(`users/${myId}/friends/${reqId}`).set(true);
        db.ref(`users/${reqId}/friends/${myId}`).set(true);
        db.ref(`users/${reqId}/requestsSent/${myId}`).once("value",(s2)=>{
          if(s2.exists()){
            db.ref(`users/${reqId}/requestsSent/${myId}`).remove();
            db.ref(`users/${reqId}/accepted/${myId}`).set(true);
            setTimeout(()=>db.ref(`users/${reqId}/accepted/${myId}`).remove(),3000);
          }
        });
        openChat(cid,reqId,"private");
      };
      d.appendChild(accept);
      let deny=document.createElement("button");
      deny.textContent="‚úò"; deny.style.background="red";
      deny.onclick=()=> db.ref(`users/${myId}/requests/${reqId}`).remove();
      d.appendChild(deny);
      tab.appendChild(d);
    });
  });
  db.ref(`users/${myId}/requestsSent`).on("value",(snap2)=>{
    let outData=snap2.val()||{};
    let st=document.getElementById("requestsSentTab");
    st.innerHTML="<strong>Requests Sent:</strong><br/>";
    Object.keys(outData).forEach(uid=>{
      let dv=document.createElement("div");
      dv.className="requestItem";
      dv.textContent=`(Pending) ${uid} `;
      let c=document.createElement("button");
      c.textContent="Cancel";
      c.onclick=()=>{
        db.ref(`users/${myId}/requestsSent/${uid}`).remove();
        db.ref(`users/${uid}/requests/${myId}`).remove();
      };
      dv.appendChild(c);
      st.appendChild(dv);
    });
  });
  db.ref(`users/${myId}/accepted`).on("child_added",(ac)=>{
    let who=ac.key;
    showNotice(`${who} accepted your request!`);
    db.ref(`users/${myId}/requestsSent/${who}`).remove();
    const cid=[myId,who].sort().join("_");
    db.ref(`privateChats/${cid}`).once("value",(snap3)=>{
      if(!snap3.exists()) db.ref(`privateChats/${cid}`).set({});
    });
    db.ref(`users/${myId}/chats/${cid}`).set({name:who,type:"private",last:Date.now()});
    setTimeout(()=>db.ref(`users/${myId}/accepted/${who}`).remove(),3000);
  });
}

// =========== addFriendUI ==============
function addFriendUI(){
  let fid=prompt("Enter friend device ID:");
  if(!fid) return;
  if(fid===myId) { showNotice("Can't friend yourself!"); return; }
  if(blocked[fid]) { showNotice("Blocked them. Unblock first!"); return; }
  // check if user exists
  db.ref(`users/${fid}/displayName`).once("value",(snap)=>{
    if(!snap.exists()) { showNotice(`User ID ${fid} doesn't exist!`); return; }
    // check if already friends
    if(friends[fid]) { showNotice(`Already friends with ${fid}!`); return; }
    // check if pending
    db.ref(`users/${myId}/requestsSent/${fid}`).once("value",(s2)=>{
      if(s2.exists()) { showNotice("Already have a request with them."); return; }
      // do request
      db.ref(`users/${fid}/requests/${myId}`).set({requested:true});
      db.ref(`users/${myId}/requestsSent/${fid}`).set(true);
      db.ref(`privateChats/${[myId,fid].sort().join("_")}`).set({});
      showNotice(`Friend request sent to ${fid}`);
    });
  });
}

// =========== openFriendsPanel ==============
function openFriendsPanel(){
  let text="Your Friends:\n";
  if(!friends||!Object.keys(friends).length) text+="(none)";
  else Object.keys(friends).forEach(f=> text+= f+"\n");
  alert(text);
}

// =========== group create/join ==============
function showAddChatPanel(){
  alert("Create group or join group from top bar. This function is kept minimal for demonstration.");
}
function openSettings(){
  let newName=prompt("Enter new name:",displayName);
  if(!newName) return;
  checkNameAvailable(newName,myId,(ok,ex)=>{
    if(!ok && ex!==myId){
      showNotice("That name is taken!");
      return;
    }
    displayName=newName;
    localStorage.setItem("displayName",newName);
    db.ref("displayNames/"+newName).set(myId);
    db.ref(`users/${myId}/displayName`).set(newName);
    showNotice("Name changed to "+newName);
  });
}

// =========== loadChats watchers ==============
let chatUnread={};
function loadChats(){
  db.ref(`users/${myId}/chats`).on("value",(snap)=>{
    let data=snap.val()||{};
    // We'll do watchers for each chat to update unread
    // or we do a "lastMsgTime vs lastSeen" approach
    // For simplicity, watchers for each chat to detect new messages
    Object.keys(data).forEach(cid=>{
      let inf=data[cid];
      if(cid!=="help_chat"){
        watchChatForUnread(cid, inf.type);
      }
    });
    // Sort help bottom
    let sorted=Object.entries(data).sort((a,b)=>{
      if(a[0]==="help_chat") return 1;
      if(b[0]==="help_chat") return -1;
      return (b[1].last||0)-(a[1].last||0);
    });
    let cList=document.getElementById("chatList");
    cList.innerHTML="";
    sorted.forEach(([id,info])=>{
      let div=document.createElement("div");
      div.className="chatItem";
      if(id===currentChat) div.classList.add("active");
      let nm= info.type==="help"? "Help (info)" : (info.name||id);
      if(info.type==="private" && blocked[nm]) nm+=" [Blocked]";
      div.textContent= nm;
      let rowRight=document.createElement("div");
      rowRight.style.display="flex"; rowRight.style.alignItems="center";
      if(chatUnread[id]){
        let bd=document.createElement("span");
        bd.className="chatBadge";
        bd.textContent="+"+chatUnread[id];
        rowRight.appendChild(bd);
      }
      if(info.type!=="help"){
        let delBtn=document.createElement("button");
        delBtn.textContent="üóë";
        delBtn.onclick=(ev)=>{
          ev.stopPropagation();
          confirmDeleteChat(id,info);
        };
        rowRight.appendChild(delBtn);
      }
      div.appendChild(rowRight);
      div.onclick=()=>{
        if(info.type==="help") openHelpChat();
        else openChat(id,nm,info.type);
      };
      cList.appendChild(div);
    });
  });
}
let watchersActive={};
function watchChatForUnread(cid, ctype){
  if(watchersActive[cid]) return; // already set
  watchersActive[cid]=true;
  let r=db.ref(`${(ctype==="group"?"groupChats":"privateChats")}/${cid}/messages`);
  r.orderByChild("timestamp").startAt(Date.now()).on("child_added",(snap)=>{
    // new message in a chat we might not be in
    if(cid===currentChat && !document.hidden) {
      // we are in chat + tab in front => mark read
      snap.ref.child("readBy").child(myId).set(Date.now());
      return;
    } else {
      // unread
      chatUnread[cid]=(chatUnread[cid]||0)+1;
      loadChats(); // refresh UI
    }
  });
}

// =========== openChat watchers ==============
let messagesRef=null;
let childAddSub=null; let childChangedSub=null;
function openChat(cid, name, type){
  currentChat=cid; currentType=type;
  chatUnread[cid]=0;
  highlightChat(cid);
  document.getElementById("chatTitle").textContent=name;
  document.getElementById("groupMembers").style.display=(type==="group")?"block":"none";

  let msgArea=document.getElementById("messages");
  msgArea.innerHTML="";
  if(messagesRef){
    if(childAddSub) messagesRef.off("child_added", childAddSub);
    if(childChangedSub) messagesRef.off("child_changed", childChangedSub);
  }
  if(type==="help"){
    // open help
    openHelpChat();
    return;
  }
  messagesRef=db.ref((type==="group"?"groupChats":"privateChats")+"/"+cid+"/messages");
  messagesRef.orderByChild("timestamp").limitToLast(50).once("value",(snap)=>{
    let data=snap.val()||{};
    let arr=Object.entries(data).sort((a,b)=>(a[1].timestamp||0)-(b[1].timestamp||0));
    arr.forEach(([mId,mVal])=> createBubble(mId,mVal));
    autoScroll();
    attachChatWatchers();
  });
  db.ref("users/"+myId+"/chats/"+cid+"/last").set(Date.now());
  if(type==="group"){
    db.ref("groupChats/"+cid+"/members").on("value",(snap)=>{
      let mm=Object.keys(snap.val()||{});
      document.getElementById("groupMembers").textContent="Members: "+mm.join(", ");
    });
  }
  attachTypingListener();
}

// watchers in chat
function attachChatWatchers(){
  childAddSub=messagesRef.orderByChild("timestamp").startAt(Date.now()).on("child_added",(snap)=>{
    let val=snap.val();
    createBubble(snap.key,val);
    autoScroll();
    // mark read if user is in chat + tab is not hidden
    if(!document.hidden && currentChat) snap.ref.child("readBy").child(myId).set(Date.now());
  });
  childChangedSub=messagesRef.on("child_changed",(snap)=>{
    updateBubble(snap.key,snap.val());
  });
}
function createBubble(mId, msgVal){
  if(document.getElementById("msg_"+mId)) return;
  let bubble=document.createElement("div");
  bubble.id="msg_"+mId;
  bubble.className="msg";
  if(msgVal.sender===myId) bubble.classList.add("me");
  else if(msgVal.sender==="_system") bubble.classList.add("centerSys");
  else bubble.classList.add("them");

  let text=msgVal.text||"";
  bubble.innerHTML=text;
  // reaction top right
  let rt=document.createElement("span");
  rt.className="reactionTag";
  if(msgVal.reaction) rt.textContent=msgVal.reaction;
  bubble.appendChild(rt);

  // reaction bar
  let rBar=document.createElement("div");
  rBar.className="reactionBar";
  ["‚ù§Ô∏è","üëç","üòÇ","üòÆ","üò¢"].forEach(r=>{
    let sp=document.createElement("span");
    sp.textContent=r;
    sp.onclick=(e)=>{
      e.stopPropagation();
      applyReaction(mId,r);
      rBar.style.display="none";
    };
    rBar.appendChild(sp);
  });
  bubble.appendChild(rBar);

  // if group
  if(currentType==="group" && msgVal.sender!==myId && msgVal.sender!=="_system"){
    let cClass=getColorClass(msgVal.sender);
    bubble.innerHTML=`<span style="font-weight:bold;" class="${cClass}">${msgVal.sender}:</span> ` + bubble.innerHTML;
  }
  bubble.addEventListener("dblclick", e=>{
    rBar.style.display=(rBar.style.display==="flex")?"none":"flex";
  });
  bubble.addEventListener("contextmenu", e=>{
    e.preventDefault();
    if(currentType==="group"){
      db.ref(`groupChats/${currentChat}/createdBy`).once("value",(snap)=>{
        if(snap.val()===myId){
          let c=confirm("Remove this message?");
          if(c){
            db.ref(`groupChats/${currentChat}/messages/${mId}`).remove();
            let el=document.getElementById("msg_"+mId);
            if(el) el.remove();
          }
        }
      });
    }
  });

  // timestamp
  let ts=document.createElement("div");
  ts.className="timestamp";
  let t="";
  if(msgVal.timestamp) t=new Date(msgVal.timestamp).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
  ts.textContent=t;
  bubble.appendChild(ts);
  if(msgVal.sender===myId) ts.classList.add("mineTime");
  else if(msgVal.sender==="_system") {
    // center sys => we might put it in center. We'll skip timestamp for system or place it below?
  } else ts.classList.add("otherTime");

  // read receipts
  if(currentType==="group"){
    if(msgVal.readBy){
      let readList=Object.keys(msgVal.readBy).filter(u=>u!==msgVal.sender);
      if(readList.length>0){
        let rr=document.createElement("div");
        rr.className="readReceipt";
        rr.textContent="Seen by: "+readList.join(", ");
        bubble.appendChild(rr);
      }
    }
  } else {
    if(msgVal.sender===myId && msgVal.readBy){
      let others=Object.keys(msgVal.readBy).filter(u=>u!==myId);
      if(others.length>0){
        let rr=document.createElement("div");
        rr.className="readReceipt";
        rr.textContent="Seen";
        bubble.appendChild(rr);
      }
    }
  }
  document.getElementById("messages").appendChild(bubble);
}
function updateBubble(mId, msgVal){
  let b=document.getElementById("msg_"+mId);
  if(!b) return;
  let rt=b.querySelector(".reactionTag");
  if(rt) rt.textContent=msgVal.reaction||"";
  // read receipts
  let rr=b.querySelector(".readReceipt");
  if(currentType==="group"){
    if(msgVal.readBy){
      let readList=Object.keys(msgVal.readBy).filter(u=>u!==msgVal.sender);
      if(readList.length>0){
        if(!rr){
          rr=document.createElement("div");
          rr.className="readReceipt";
          rr.textContent="Seen by: "+readList.join(", ");
          b.appendChild(rr);
        } else rr.textContent="Seen by: "+readList.join(", ");
      } else if(rr) rr.remove();
    } else if(rr) rr.remove();
  } else {
    if(msgVal.sender===myId && msgVal.readBy){
      let others=Object.keys(msgVal.readBy).filter(u=>u!==myId);
      if(others.length>0){
        if(!rr){
          rr=document.createElement("div");
          rr.className="readReceipt";
          rr.textContent="Seen";
          b.appendChild(rr);
        }
      } else if(rr) rr.remove();
    }
  }
}
function autoScroll(){
  let msgArea=document.getElementById("messages");
  msgArea.scrollTop= msgArea.scrollHeight;
}

//** type watchers
function attachTypingListener(){
  if(!currentChat) return;
  let path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/typing`).off();
  db.ref(`${path}/${currentChat}/typing`).on("value",(snap)=>{
    let val=snap.val();
    let t=document.getElementById("typingIndicator");
    if(val && val!==myId && !document.hidden){
      t.style.display="block";
      t.textContent=`${val} is typing...`;
    } else {
      t.style.display="none";
    }
  });
}
function sendTyping(){
  if(!currentChat||currentType==="help") return;
  let path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/typing`).set(myId);
  setTimeout(()=>{
    db.ref(`${path}/${currentChat}/typing`).set("");
  },2000);
}

//** slash commands + large T/D queue
const slashCommands=[
  "/tod truth","/tod dare","/title","/cf heads","/cf tails","/coin flip heads","/coin flip tails"
];
let bigTruths=[
  // many
  "What is your biggest fear?",
  "Who was your first crush?",
  "What's your silliest nickname?",
  "What's one thing you'd change about yourself?",
  "Have you ever lied to your best friend?",
  "What's your weirdest dream?",
  "Have you ever spied on someone you liked?",
  "What is your guilty pleasure?",
  "What's the most embarrassing moment you recall?",
  "If you had one wish, what would it be?",
  "Have you ever said 'I love you' without meaning it?",
  "What's the strangest habit you have?",
  "What's the worst trouble you got in as a kid?",
  "What's your secret talent?",
  // etc
];
let bigDares=[
  "Sing a random song for 20 seconds",
  "Speak in a fake accent until your next turn",
  "Act like a cat for 1 minute",
  "Dance like a robot for 15 seconds",
  "Spin around 10 times then walk straight",
  "Try to do a handstand (or pretend) for 5 seconds",
  "Text someone 'I love pickles'",
  "Pretend you're an alien for 30 seconds",
  "Call a friend and say 'I love cheese' then hang up",
  "Recite the alphabet backwards quickly",
  // etc
];
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ let j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];}}
shuffle(bigTruths); shuffle(bigDares);

function getNextTruth(){
  let item=bigTruths.shift();
  bigTruths.push(item);
  return item;
}
function getNextDare(){
  let item=bigDares.shift();
  bigDares.push(item);
  return item;
}

function slashInputHandler(e){
  let val=e.target.value;
  if(!val.startsWith("/")){
    document.getElementById("slashAutocomplete").style.display="none";
    return;
  }
  let sc=document.getElementById("slashAutocomplete");
  sc.style.display="block";
  sc.innerHTML="";
  slashCommands.forEach(cmd=>{
    if(cmd.startsWith(val)) {
      let b=document.createElement("button");
      b.textContent=cmd;
      b.onclick=()=>{
        e.target.value=cmd+" ";
        sc.style.display="none";
      };
      sc.appendChild(b);
    }
  });
}
function sendMessage(){
  if(!currentChat||currentType==="help") return;
  let inp=document.getElementById("msgInput");
  let txt=inp.value.trim();
  if(!txt) return;
  document.getElementById("slashAutocomplete").style.display="none";
  if(txt.startsWith("/")){
    processSlashCommand(txt);
    inp.value="";
    return;
  }
  let friendName=document.getElementById("chatTitle").textContent;
  if(currentType==="private" && blocked[friendName]){
    showNotice("You blocked them. Unblock first!");
    return;
  }
  let path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/messages`).push({
    sender:myId, text:txt, timestamp:Date.now(), reaction:"",
    readBy:{[myId]:Date.now()}
  });
  inp.value="";
  sendTyping();
  autoScroll();
}
function processSlashCommand(cmd){
  let parts=cmd.split(" ");
  if(parts[0]==="/tod"){
    if(parts[1]==="truth"){
      let t=getNextTruth();
      sendSystemMessage(t);
    } else if(parts[1]==="dare"){
      let d=getNextDare();
      sendSystemMessage(d);
    } else showNotice("Usage: /tod truth or /tod dare");
  }
  else if(parts[0]==="/title"){
    let rest=parts.slice(1).join(" ");
    if(!rest){ showNotice("Usage: /title <text>"); return;}
    sendSystemMessage(`<< ${rest} >>`);
  }
  else if(parts[0]==="/cf" || parts[0]==="/coin"){
    // coin flip
    let guess="";
    if(parts[0]==="/cf") guess=parts[1]||"";
    else if(parts[0]==="/coin"){
      if(parts[1]==="flip") guess=parts[2]||"";
    }
    guess=guess.toLowerCase();
    if(guess!=="heads" && guess!=="tails"){
      showNotice(`Usage: /cf heads/tails or /coin flip heads/tails`);
      return;
    }
    let side=Math.random()<0.5? "heads":"tails";
    let result=(side===guess)? "wins":"loses";
    sendSystemMessage(`Coin flipped on ${side}, user ${displayName} ${result}!`);
  }
  else {
    showNotice("Unknown command: "+cmd);
  }
}
function sendSystemMessage(txt){
  if(!currentChat||currentType==="help") return;
  let path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/messages`).push({
    sender:"_system",
    text:txt,
    timestamp:Date.now(),
    reaction:"",
    readBy:{}
  });
}
function applyReaction(mId, r){
  if(!currentChat||currentType==="help") return;
  let path=(currentType==="group"?"groupChats":"privateChats");
  db.ref(`${path}/${currentChat}/messages/${mId}/reaction`).set(r);
}

//** toggleEmojiPicker
function toggleEmojiPicker(){
  let ep=document.getElementById("emojiPicker");
  if(ep.style.display==="flex"){ ep.style.display="none"; return;}
  ep.innerHTML="";
  ep.style.display="flex";
  let bigEmojis=[... "üòÄüòÉüòÑüòÅüòÜüòÖüòÇü§£üòäüòáüôÇüôÉüòâüòåüòçüòòü•∞üòóüòôüòöüòãüòõüòùüòúü§™ü§®üßêü§ìüòéü•∏ü§©ü•≥üòèüòíüòûüòîüòüüòïüôÅ‚òπÔ∏èüò£üòñüò´üò©ü•∫üò¢üò≠üò§üò†üò°ü§¨ü§Øüò≥ü•µü•∂üò±üò®üò∞üò•üòìü§óü§îü§≠ü§´ü§•üò∂üòêüòëüôÑüòØüò¶üòßüòÆüò≤ü•±üò¥üò™üòµüòµ‚Äçüí´üò∑ü§íü§ïü§¢ü§Æü§ßüòáüòàüëøüëªüíÄ‚ò†Ô∏èüëΩü§ñüéÉüò∫üò∏üòπüòªüòºüòΩüôÄüòøüòæ"];
  bigEmojis.forEach(e=>{
    let sp=document.createElement("span");
    sp.textContent=e;
    sp.onclick=()=>{
      document.getElementById("msgInput").value+= e;
      ep.style.display="none";
    };
    ep.appendChild(sp);
  });
}

//** done
</script>

<!-- Example open rules:
{
  "rules":{
    ".read":true,
    ".write":true,
    "users":{"$devId":{".read":true,".write":true}},
    "privateChats":{"$chatId":{".read":true,".write":true}},
    "groupChats":{"$grpId":{".read":true,".write":true}},
    "displayNames":{"$name":{".read":true,".write":true}}
  }
}
-->
</body>
</html>
